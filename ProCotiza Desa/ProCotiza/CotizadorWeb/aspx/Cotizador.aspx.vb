'BBVA-P-412: AMR: RQ02,RQ03,RQ04,RQ05,RQ06,RQ08
'BBVA-P-412: 22/07/2016: AMR: RQ18 Cambio por Agregar Version y Año del Auto.
'BBVA-P-412: 25-08-2016: AMR: RQCOT-01 Ajustes a la pantalla de Cotización.
'BBV-P-412 RQCOT-05:AVH: 08/09/2016 SE VALIDA EN QUE REPORTE SE MUESTRA
'BBV-P-412 RQCOT-04:AVH: 20/09/2016 RECOTIZACION
'BBVA-P-412 RQ06: AMR: 20/09/2016 Administración de Planes de Financiamiento: Promociones
'BBVA-P-412 RQ WSC AVH: 20/10/2016 SE INSERTAN PLAZOS DE LA COTIZACION (SUDOKU)
'BBV-P-412:RQ 10 AVH: 01/11/2016 Cambio de las clases de WS
'BBV-P-412:RQ F GVARGAS: 07/11/2016 Correccion errores.
'BBV-P-412  BUG-PC-05 MARREDONDO 11/11/2016 Se permite ocultar la sección de agencia
'BBV-P-412:BUG-PC-10 JRHM: 18/11/2016 Se muestra giro default en combo
'BUG-PC-12: AVH: 24/11/2016 SE AGREGA MENSAJE DE ERROR EN WS
'BUG-PC-20: AVH: 30/11/2016 SE AGREGA ValidaDatosCliente
'BBV-P-412:BUG-PC-23 JRHM: 01/12/2016 Se modifico evento textchanged de txtprecio por que no traia el valor maximo de parametros sistema.
'BUG-PC-22 MAUT 05/12/2016 Se agrega segundo nombre al rfc
'BUG-PC-24 MAUT 14/12/2016 Se valida el nombre del cliente
'BUG-PC-25 MAUT 15/12/2016 Se corrige formato de fecha
'BUG-PC-26: JRHM: 20/12/2016 Se repararon bugs de errores en servicio, acciones postback, entre otras.
'BUG-PC-27 MAUT 23/12/2016 Se separan accesorios financiados y de contado, se arregla compra inteligente
'BUG-PC-29 AMR 02/01/2017: Al seleccionar cualquier version fuera de la que muestra por default manda una pantalla de error.
'BUG-PC-30 AMR 03/01/2017: Al ingresar al portal procotiza e ingresar a la opcion de cotizacion manda un mensaje de warning.
'BBV-P-412:RQ LOGIN GVARGAS: 03/01/2017 Actualizacion REST Service iv_ticket & userID
'BUG-PC-33: JRHM: 10/01/2017 Se modifico validacion de escritura de fecha de nacimiento y prohibicion de acentos en nombres y apellidos del cliente
'BUG-PC-34 MAUT 12/01/2017 Se modifico carga de fecha de nacimiento para evitar error y opcion de seguro
'BUG-PC-38 MAUT 23/01/2017 Se quita calculo automatico de RFC
'BUG-PC-41:PVARGAS:31/01/2017:SE MANDA A LLAMAR EL METODO QUE MUESTRA EL TXT DEPENDIENDO DE LA PERSONALIDAD JURIDICA SELECCIONADA.
'BUG-PC-44 07/02/17 JRHM SE AGREGAN CAMBIOS PARA LA PRESENTACION DE LOS CCUADROS DE TEXTO DE VALOR RESIDUAL(TIPO CALCULO BALLON) Y PORCENTAJE SUBSIDIO
'BUG-PC-45: AVH: 07/02/2017 SE VALIDA SI ES MODIFICACION
'BUG-PC-46 JRHM 09/02/17 SE CAMBIAN VALIDACIONES DE RFC A LONGITUD DE CARACTERES Y SE DESHABILITA LA SELECCION DEL TIPO DE SEGURO
'BBV-P412 RQCOT-01.2: AMR 23/02/2017: Seguros.
'BUG-PC-48 JRHM 15/02/17 SE AGREGARON VALIDACION PARA MENSAJES DE ERROR AL EDITAR COTIZACION MUESTRA MENSAJE SI LA AGENCIA NO TIENE VENDEDOR O PROMOTOR ASIGNADO
'BUG-PC-49 MAPH 17/03/17 VALIDACION DE LAS CAJAS DE TEXTO DEPENDIENDO DE SU CONFIGURACION
'BUG-PC-50 JRHM 11/04/17 SE COLOCAN <SELECCIONAR> A COMBOS DE SECCION DE SEGUROS,  SE CORRIGEN PROBLEMAS CON ENGANCHE CI Y SE AGREGA COMENTADA POSIBLE FUNCIONALIDAD A FUTURO DE FINANCIAMIENTO ADICIONAL
'BUG-PC-54 CGARCIA 19/04/2017 SE CAMBIO LA CARGA NUEVA DE LOS COBBOS QUE VAN DENTRO DEL GRIDVUEW grvAccesorios 
'BUG-PC-53 AMR 21/04/2017 Correcciones Multicotiza.
'BUG-PC-52 AMR 21/04/2017 Cambios Eikos y Marsh.
'BUG-PC-57 JRHM 03/05/17 Se mensaje que solicitaba que seleccionaran el genero del conductor recurrente
'BUG-PC-58:AMATA:03/05/2017:Seguros Ordas
'BUG-PC-59:AMATA:08/05/2017:Seguro de vida Bancomer.
'BUG-PC-61:AMATA:11/05/2017:Actualiza Aseguradoras.
'BUG-PC-67: RHERNANDEZ: 23/05/17 SE MODIFICA PROBLEMA AL CALCULAR GARANTIA EXTENDIDA ORDAS CUANDO EL PRODUCTO NO TIENE ID EXTERNO
'BUG-PC-70: RHERNANDEZ: 30/05/17 SE AGREGAN SEGURO DE DANOS Y VIDA BANCOMER
'BUG-PC-69:MPUESTO:30/05/17 MODIFICACIONES PARA CORRECCIÓN DE ERROR AL GUARDAR COTIZACIONES EXISTENTES
'BUG-PD-68: RHERNANDEZ: 02/06/17 SE MODIFICA COTIZADOR PARA ALMACENAR EL VALOR DEL USO DEL VEHICULO DE LOS DATOS DEL SEGURO
'BUG-PC-72: RHERNANDEZ: 08/06/17: SE SOLUCIONAN PORBLEMAS AL CALCULAR SEGUROS POR FACTOR Y PROBLEMAS DE CAMBIO DE COMBOS AL SELECCIONAR SEGURO DE VIDA POR CUENTA DE CLIENTE, SOLICITUD DE COTIZACION DE SEGURO DE VIDA ANTES DE GUARDAR Y PROBLEMA DE SEGURO DE DAÑOS POR FACTOR CUANDO ES POR CUENTA DEL CLIENTE
'BUG-PC-79: CGARCIA: 17/06/2017: AGREGA VALIDACION PARA "POR CUENTA DEL CLIENTE "
'BUG-PC-80: CGARCIA: 22/06/2017: SE AGREGO VALIDACION A BOTON DE SEGUROS.
'BUG-PC-81: RHERNANDEZ: 29/06/17: SE ACCESORIOS A SEGUROS BANCOMER ADEMAS SE LE AGREGA TANTO A EIKOS, ORDAS Y BBVA EL TIPO SEGURO PARA EVALUER SI SE VA A SUMAR A EL MONTO A FINANCIAR CUANDO EL SEGURO ES POR CONTADO
'BUG-PC-84: RHERNANDEZ: 11/07/17: SE INVIERTEN EL ID QUE SE MANDABA EN GENERO DE CONDUCTOR RECURRENTE
'BUG-PC-90:MPUESTO:10/07/2017:CORRECCIÓN DE VALIDACION DE MONTO DE ACCESORIOS
'BUG-PC-93: RHERNANDEZ: 12/07/17: SE CORRIGE PROBLEMA DE MENSAJE AL GENERAR GARANTIA EXTENDIDA   
'RQ-SEGIP : RHERNANDEZ: 19/07/17: SE AGREGA A COTIZADOR EL ID PRODUCTO PARA EL CALCULO DE SEGUROS POR FACTOR CON CONSTANTE DINAMICA
'RQ-INB17: ERODRIGUEZ: 26/07/2017: SE AGREGO CANDADO PARA NO PERMITIR GARANTIA EXTENDIDA CUANDO LA CLASIFICACION DEL PRODUCTO SEA SEMINUEVO.
'BUG-PC-97: RHERNANDEZ: 25/07/17 SE MANDAN A SEGUROS DE DANIOS BBVA SOLO ACCESORIOS 
'RQ-INB221: ERODRIGUEZ: 19/07/2017: Se realizaron validaciones para permitir a los usuarios vendedores seleccionar deiferente agencia que sea de su alianza
'BUG-PC-98: RHERNANDEZ: 10/08/2017: Se agregan try y catch a eventos donde se actualizan las agencias, grupos y divisiones y se obtienen datos de productos
'RQ-INB217: RHERNANDEZ: 15/08/17: SE AGREGO LA FUNCIONALIDAD DE VALORES DEFAULT PARA LAS MARCAS EN EL COTIZADOR
'RQ-MN2-6:RHERNANDEZ: 07/09/17: SE CORRIGE PROBLEMA AL CONSULTAR EL PRODUCTO
'RQ-MN2-2 ERODRIGUEZ 14/09/2017 Se agregaron tasas para compra inteligente .
'RQ-MN2-4 : CGARCIA: 11/09/2017 :  SE AGREGO LA PARTE DE GUARDAR EL DEDUCIBLE UNICAMENTE PARA SEGUROS BANCOMER
'RQ-MN2-4.2 : CGARCIA: 28/09/2017 :  SE ELIMINO EL TIPO DE DEDUCIBLE  
'BUG-PC-113: ERODRIGUEZ: 03/10/2017: Se valido, cuando el valor de tasa dos, en compra inteligente sea nulo
'BUG-PC-114: CGARCIA: 04/10/2017: SE AGREGAN PARAMETROS PARA VALOR GARANTIZADO
'-- RQ-PI7-PC3: CGARCIA: 09/10/2017: CREACION DE NUEVA ALIANZA KIA PARA AGENCIA KIA, INDIAN, POLARIAS Y DEDUCIBLES
'RQ-MN2-2.3 ERODRIGUEZ 14/09/2017 Se agregaron tablas para CI.
'RQ-PI7-PC1:RHERNANDEZ: 12/10/17: Se modifica pantalla cotizador para administrar la nueva cascada de submarca>clasificacion>anio>version
'RQ-MN2-2.3.1 ERODRIGUEZ 31/10/2017 Se agregaron tablas para CI.
'BUG-PC-125  RIGLESIAS:  14/11/2017 SE Agrego nuevo combolist para indemnización 
'BUG-PC-126: ERODRIGUEZ: 16/11/2017 Se agrego parametro para etiqueta de periodo
'BUG-PC-128: CGARCIA: 23/11/2017: SE PONE BANDERA PARA APARESER O NO AL DEDUCIBLE
'BUG-PC-136: ERODRIGUEZ: 13/12/2017: Se valida cuando sea compra inteligente en el combo de clasificación, validacion para etiquetas de valor residual, enganche ci.
'BUG-PC-135: CCHAVEZ  11/12/2017: EVALUACION MONTO MINIMO Y MAXIMO DE CREDITO 
'BUG-PC-144: DJUAREZ: 09/01/2018: Se oculta el campo de subsidio cuando la opcion no viene seleccionada en el plan
'RQ-PI7-PC7: CGARCIA: 27/12/2017: CREACION DE LOS SERVICIOS DE SUBPLANES, INDEMNIZACION Y DEDUCIBLES (comobo de coberturas es subplan)
'RQ-PI7-PC4: RHERNANDEZ: 11/01/17: Se comenta metodo previo de simulacion de cotizacion de seguro de vida por el seguro variable
'BUG-PC-149: CGARCIA: 22/01/2018: SE BANDEREA SEGURO DAÑOS						   
'BUG-PC-152: DCORNEJO: 25/01/2018: SE ENVIA EL VALOR DEL MONTO DEL SEGURO DEL VEHICULO AL REPORTE, SE COMENTA LINEA QUE REALIZABA EL CALCULO Y SE OBTINE DE MANERA DIRECTA _ObjSeg._decSegPrimaTotal = CDec(grvSeguro.Rows(i).Cells(6).Text)
'BUG-PC-147: RHERNANDEZ: 19/02/18: SE ENVIA EL NUEVO VALOR DE ID QOUTE DE SEGURO DE VIDA 
'BUG-PC-150: CGARCIA: CAMBIO EN MSJ DE ROBO TOTAL
'BUG-PC-154: CGARCIA: 19/02/2018: actualizacion de cotizacion de segurosa de daños 
'RQ-PD30: JMENDIETA: 05/03/2018: Se envia el tipo de producto al contizar vida.
'BUG-PC-163: RHERNANDEZ: 28/02/2018: Se modifica calculo de prima total del seguro para ford qualitas
'BUG-PC-166: JMENDIETA: 09/03/2018: Se valida que cuando se tenga información de deducibles esta se almacene en base de datos.
'BUG-PC-168: CGARCIA: 15/03/2018: SE MODIFICA SERVICO DE DAÑOS PARA MULTIMARCA
'BUG-PC-171: CGARCIA: 27/03/2018: SE MODIFICA LA CONSULTA DEL SERVICO DE DEDUCIBLE.	
'RQ-PC5: JMENDIETA: 27/01/2018: Se agrega el broker 4 (MARSH) para mostrar el codigo postal y se agrega el metodo para la multicotizacion de Marsh.
'BUG-PC-173: CGARCIA: 05/04/2018: SE MODIFICAN ALIANZAS PARA SEGURO A TU MEDIDA
'BUG-PC-175: JMENDIETA: 09/04/2017 Se envia el plazo seleccionado al multicotizador de Marsh.
'BUG-PC-179: DJUAREZ: 16/04/2018: Se agrega validacion Suzuki, Axa al cotizar cuando se agregan accesorios.
'BUG-PC-177: JMENDIETA: 16/04/2017 En la seccion de Financiamiento del Seguro se deshabilita el combo de Estado y se guarda el codigo postal enviado a la cotizacion.
'BUG-PC-180: DJUAREZ: 17/04/2018: Reacomodo de codigo postal en cotizacion.
'BUG-PC-183: JMENDIETA: 20/04/2017 Se corrige validacion de codigo postal al momento de guardar una cotizacion para Marsh.
'BUG-PC-185: JMENDIETA: 26/04/2017 Cambio de validacion para guardar datos de deducibles y guardar codigo postal en broker 5 y 9 (Bancomer).
'BUG-PC-187: JMENDIETA: 26/04/2017 Se guarda el recargo de los recibos en el detalle del seguro para broker 4(Marsh) y cuando multicotizacion esta activada.
'BUG-PC-181 : EGONZALEZ : 20/04/2018 : Se cambia el número de caracteres requeridos en nombre y apellido paterno de 3 a 2 caratéres.
'Bug-PC-189 : EGONZALEZ : 04/05/2018 : Se agrega al reporte de cotización la sección de datos de "Personalización tu Seguro de daños" sólo para seguros Bancomer.
'BUG-PC-191 : JMENDIETA : 09/05/2018 : Cambio en validaciones para broker 4 (Marsh) y alianzas de broker 2(Ordas) para mostrar los datos de conductor.
'BUG-PC-190 : JMENDIETA : 10/05/2018 : Para cotizacion con broker 5 y 9 se envia el id de agencia.
'BUG-PC-192 : DCORNEJO : 08/05/2018 : Se utiliza ddlagencia para validacion automik
'BUG-PC-193 : JMENDIETA : 14/05/2018 : Para el borker 9 se elimina el poder visualizar el codigo postal.
'BUG-PC-195: RHERNANDEZ: 18/05/2018: Se corrigue problema al guardar cotizacion por factor
'BUG-PC-196 : JMENDIETA : 22/04/2018 : Para los productos se obtendran unicamente los activos y se agrega validacion en carga cargacombos2 cuando el tipo seguro es 32 o 168

Imports System.Data
Imports System.Configuration
Imports Microsoft.Reporting.WebForms
Imports System.Data.OleDb
Imports System.IO
Imports System.Text
Imports System.Diagnostics
Imports System.Drawing
Imports CrystalDecisions.CrystalReports.Engine
Imports CrystalDecisions.Shared
Imports SNProcotiza
Imports Newtonsoft.Json
Imports System.Data.DataSet
Imports WCF
Imports WCF.clsSubplanes
Imports WCF.clsDeducible


Partial Class aspx_Cotizador
    Inherits System.Web.UI.Page
    Dim strErr As String = ""
    Dim objUser As New clsUsuariosSistema
    Dim objAge As New clsAgencias
    Dim objCombo As New clsProcGenerales
    Dim objEdo As New clsEstados
    Dim objPaq As New clsPaquetes
    Dim objIva As New clsTasasIVA
    Dim objCot As New clsCotizaciones
    Dim objPlazos As New clsPlazo
    Dim objProd As New clsProductos
    Dim objParam As New clsParametros
    Dim objMon As New SNProcotiza.clsMonedas
    Dim objListaAcc As New List(Of SDManejaBD.clsListaAccesorios)
    Dim total As Double = 0
    Dim AccFinan As Double = 0
    Dim AccConta As Double = 0
    Dim IDCotizacion As Integer = 0
    Dim idSistema As Integer
    Dim prodid As Integer = 0
    Dim idpersona As Integer = 0
    Dim iduser As Integer = 0

    Dim objWS As New Lmscover_Serv.Envio_cotizacion1
    Dim objWSCot As New Lmscover_Serv.Lorant_LmsCover1
    Dim dst As New DataSet
    Dim PlazoMod As String = ""
    Dim AccFlag As Boolean = False
    Dim generarCot As Boolean = False
    Dim SoloAccesorios As Decimal
    Dim MuestraDeducible As Integer
    Dim VerificaCobertura As Integer
    Dim usaMulticotiza As Integer

    Protected Sub Page_Load(sender As Object, e As System.EventArgs) Handles Me.Load

        lblMensaje.Text = String.Empty

        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
        ''Session("idPerfil") = objUsuFirma.IDPerfil
        Session("usrreg") = objUsuFirma.UserName
        iduser = objUsuFirma.IDUsuario
        ViewState("wvsUsr") = iduser

        Dim dts As New DataSet
        If objUsuFirma.ErrorUsuario = "Sesion Terminada" Then
            Response.Redirect("../login.aspx?mns=" & Trim$(objUsuFirma.ErrorUsuario), True)
        End If

        Dim clsParam As New clsParametros
        Dim dtDeduc As New DataSet
        dtDeduc = clsParam.ManejaParametro(7)
        If dtDeduc.Tables.Count > 0 AndAlso dtDeduc.Tables(0).Rows.Count > 0 AndAlso dtDeduc.Tables(0).Rows(0).Item("VALOR") <> String.Empty Then
            MuestraDeducible = CInt(dtDeduc.Tables(0).Rows(0).Item("VALOR").ToString)
        Else
            MuestraDeducible = 0
            MensajeError("No se encuentra información sobre parametro de deducible.")
        End If

        'RQ-PC5 INI
        Dim dtsMulticotiza As New DataSet
        dtsMulticotiza = clsParam.ManejaParametro(9)
        If (Not IsNothing(dtsMulticotiza)) AndAlso (dtsMulticotiza.Tables.Count > 0) AndAlso (dtsMulticotiza.Tables(0).Rows.Count > 0) AndAlso (Not String.IsNullOrEmpty(dtsMulticotiza.Tables(0).Rows(0).Item("VALOR"))) Then
            usaMulticotiza = CInt(dtsMulticotiza.Tables(0).Rows(0).Item("VALOR").ToString)
        Else
            usaMulticotiza = 0
        End If
        'RQ-PC5 FIN

        If Not IsPostBack Then

            'Session("idpolBBVA") = 0
            Session("montoSegVida") = "0.00"
            Session("idquotevida") = "0"
            If objUsuFirma.IDPerfil = 74 Then
                '    If ValidaUser(objUsuFirma.IDUsuario, objUsuFirma.UserName) Then
                '        objEdo.IDEstado = Val(Session("idEdo"))
                '        dts = objEdo.ManejaEstado(1)
                '        If objEdo.ErrorEstados = "" Then
                '            objCombo.LlenaCombos(dts, "NOMBRE", "ID_ESTADO", ddledo, strErr)
                '            If Trim$(strErr) <> "" Then
                '                Response.Redirect("../login.aspx?mns=" & Trim$(strErr), True)
                '                Exit Sub
                '            End If
                '        End If

                '        'Combo Promotores
                '        objUser.IDAgencia = ddlagencia.SelectedValue
                '        objUser.IDEstado = ddledo.SelectedValue
                '        dts = objUser.ManejaUsuario(16)
                '        If objUser.ErrorUsuario = "" Then
                '            If dts.Tables(0).Rows.Count > 0 Then
                '                objCombo.LlenaCombos(dts, "NOMBRE", "ID_USUARIO", ddlejecutivo, strErr)
                '                If strErr <> "" Then
                '                    MensajeError(strErr)
                '                    Exit Sub
                '                End If
                '            Else
                '                MensajeError("No se encontro información de Promotores.")
                '            End If
                '        Else
                '            MensajeError(objUser.ErrorUsuario)
                '        End If

                '    Else
                '        Response.Redirect("../login.aspx?mns=" & Trim$(strErr), True)
                '    End If
                'se comento por modificacion de vendedores con agencias de alianza
                'ddledo.Enabled = False
                'ddlalianza.Enabled = False
                'ddlgrupo.Enabled = False
                'ddldivision.Enabled = False
                'ddlagencia.Enabled = False
                'ddlejecutivo.Enabled = False
                ddlvendedor.Enabled = False

            End If
            Dim idbroker As String
            If CargaCombos() Then
                If CargaCombos2() Then
                    idbroker = obten_broker()
                    'btncotizaseg.Enabled = True 'JRHM Se comenta desactivacion de boton de cotizar cuando la pagina carga la primera vez
                    ''BUG-PC-30
                    'RQ-PC5 
                    'BUG-PC-191 BUG-PC-193
                    If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) OrElse (idbroker = 5) OrElse (usaMulticotiza = 1 AndAlso idbroker = 4) Then
                        dvrecurrecte.Visible = True
                        dvcodpostal.Visible = True
                    Else
                        dvrecurrecte.Visible = False
                        dvcodpostal.Visible = False
                    End If
                    'BUG-PC-24 MAUT 14/12/2016 Se selecciona el usuario que ingresa
                    ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
                    'BUG-PC-41:PVARGAS:31/01/2017:SE MANDA A LLAMAR EL METODO QUE MUESTRA EL TXT DEPENDIENDO DE LA PERSONALIDAD JURIDICA SELECCIONADA.
                    Personalidad()
                Else
                    idbroker = obten_broker()
                    btncotizaseg.Enabled = False
                    finseg.Visible = False
                    'RQ-PC5
                    'BUG-PC-191 BUG-PC-193
                    If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) OrElse (idbroker = 5) OrElse (usaMulticotiza = 1 AndAlso idbroker = 4) Then
                        dvrecurrecte.Visible = True
                        dvcodpostal.Visible = True
                    Else
                        dvrecurrecte.Visible = False
                        dvcodpostal.Visible = False
                    End If
                    Dim brokerid As Integer = obten_broker()
                    If brokerid <> 2 Then
                        If ddltipounidad.Items.Count = 0 OrElse ddluso.Items.Count = 0 OrElse ddlcobertura.Items.Count = 0 OrElse ddlaseguradora.Items.Count = 0 OrElse (ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168) Then
                            ViewState("MulPlazos") = Nothing
                            btncotizaseg.Enabled = False
                            ddlaseguradora.Enabled = False
                            ddltipounidad.Enabled = False
                            ddluso.Enabled = False
                            ddlcobertura.Enabled = False
                            If ddltiposeg.Items.Count > 0 Then
                                ddltiposeg.Enabled = True
                            Else
                                ddltiposeg.Enabled = False
                            End If

                            If ddlsegvida.Items.Count > 0 Then
                                ddlsegvida.Enabled = True
                            Else
                                ddlsegvida.Enabled = False
                            End If

                        Else
                            btncotizaseg.Enabled = True
                            ddlaseguradora.Enabled = True
                            ddltipounidad.Enabled = True
                            ddluso.Enabled = True
                            ddlcobertura.Enabled = True
                            ddltiposeg.Enabled = True
                            ddlsegvida.Enabled = True
                        End If
                    End If


                    Exit Sub
                End If

            Else
                'BUG-PC-41:PVARGAS:31/01/2017:SE MANDA A LLAMAR EL METODO QUE MUESTRA EL TXT DEPENDIENDO DE LA PERSONALIDAD JURIDICA SELECCIONADA.
                Personalidad()
                divfinadic.Visible = False
                MensajeError(strErr)
                Exit Sub
            End If
            If Val(Request("idCotizacion")) <> 0 Then
                Dim idCot As Integer = Val(Request("idCotizacion"))
                RecargaCotizacion(idCot)
            End If


        End If

        Dim fechaact As Date = Date.Now.Date
        If (txtfecnac.Text <> "" Or IsNothing(txtfecnac.Text)) Then
            Dim test As Date
            If Date.TryParse(txtfecnac.Text, test) Then
                If Date.TryParseExact(txtfecnac.Text.ToString(), "dd-mm-yyyy", System.Globalization.CultureInfo.CurrentCulture, System.Globalization.DateTimeStyles.None, test) Then
                    Dim datenac As DateTime = txtfecnac.Text
                    If (datenac > fechaact) Then
                        txtfecnac.Text = ""
                        MensajeError("Fecha de nacimiento mayor a fecha actual")
                    ElseIf DateDiff("Y", datenac, fechaact) < 18 Then
                        txtfecnac.Text = ""
                        MensajeError("Fecha de nacimiento introducida invalida, menor de 18 años")
                    End If
                Else
                    txtfecnac.Text = ""
                    MensajeError("Fecha Introducida no valida (ingresar dd-MM-AAAA)")
                End If
            Else
                txtfecnac.Text = ""
                MensajeError("Fecha Introducida no valida")
            End If
        End If
        'Dim script As String = "muestradiv();"
        'ScriptManager.RegisterStartupScript(Me, GetType(Page), "muestradiv", script, True)
        'Dim script2 As String = "muestradiv2();"
        'ScriptManager.RegisterStartupScript(Me, GetType(Page), "muestradiv2", script, True)

    End Sub

    Private Sub VerificaSubsidio(ByRef configuracionPaquete As SNProcotiza.clsPaquetes)
        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        If configuracionPaquete.PermiteMontoSubsidio = 1 Or configuracionPaquete.PermitePtjSubsidio = 1 Then
            tdmontosub.Visible = True
            txtmtosub.Visible = True
            lblptjsub.Visible = True
            txtporsub.Visible = True
            txtmtosub.Enabled = IIf(configuracionPaquete.PermiteMontoSubsidio = 1, True, False)
            txtporsub.Enabled = IIf(configuracionPaquete.PermitePtjSubsidio = 1, True, False)
        Else
            tdmontosub.Visible = False
            txtmtosub.Visible = False
            txtporsub.Visible = False
            lblptjsub.Visible = False
        End If
    End Sub

    Private Sub MensajeError(ByVal strMsj As String)
        strMsj = Replace(strMsj, "'", "")
        strMsj = Replace(strMsj, """", "")
        strMsj = Replace(strMsj, vbCrLf, " ")
        'strMsj = Replace(strMsj, "(", "")
        'strMsj = Replace(strMsj, ")", "")
        lblMensaje.Text = "<script>alert('" & strMsj & "')</script>"
    End Sub

    Private Function ValidaUser(usrid As Integer, usrname As String) As Boolean
        Dim dts As New DataSet

        ValidaUser = False

        objUser.IDUsuario = usrid
        dts = objUser.ManejaUsuario(14)

        If objUser.ErrorUsuario = "" Then
            If dts.Tables(0).Rows.Count > 0 Then
                ''Se llena el combo de Agencia
                objAge.IDAgencia = dts.Tables(0).Rows(0).Item("ID_AGENCIA")
                'dts = objAge.ManejaAgencia(1)
                objAge.IDUsuario = iduser
                dts = objAge.ManejaAgencia(26)

                If objAge.ErrorAgencia = "" Then
                    If dts.Tables(0).Rows.Count > 0 Then
                        Session("idEdo") = dts.Tables(0).Rows(0).Item("ID_ESTADO")
                        If dts.Tables(0).Rows(0).Item("ESTATUS") = 2 Then
                            objCombo.LlenaCombos(dts, "NOMBRE", "ID_AGENCIA", ddlagencia, strErr)
                            If Trim$(strErr) <> "" Then
                                Exit Function
                            Else
                                'Combo Alianza
                                Dim objalianza As New clsAlianzas
                                Dim dataset As New DataSet
                                objalianza.IDAlianza = dts.Tables(0).Rows(0).Item("ID_ALIANZA")
                                dataset = objalianza.ManejaAlianza(1)
                                If objalianza.ErrorAlianza = "" Then
                                    If dataset.Tables(0).Rows.Count > 0 Then
                                        objCombo.LlenaCombos(dataset, "ALIANZA", "ID_ALIANZA", ddlalianza, strErr)
                                        If strErr <> "" Then
                                            Exit Function
                                        End If
                                    Else
                                        strErr = "No se encontro información de Alianza."
                                        Exit Function
                                    End If

                                Else
                                    strErr = objalianza.ErrorAlianza
                                End If

                                'Combo Grupo
                                Dim objgrupo As New clsGrupos
                                objgrupo.IDGrupo = dts.Tables(0).Rows(0).Item("ID_GRUPO")
                                dataset = objgrupo.ManejaGrupo(1)
                                If objgrupo.ErrorGrupo = "" Then
                                    If dataset.Tables(0).Rows.Count > 0 Then
                                        objCombo.LlenaCombos(dataset, "GRUPO", "ID_GRUPO", ddlgrupo, strErr)
                                        If strErr <> "" Then
                                            Exit Function
                                        End If
                                    Else
                                        strErr = "No se encontro información de Grupo."
                                        Exit Function
                                    End If
                                Else
                                    strErr = objgrupo.ErrorGrupo
                                    Exit Function
                                End If

                                'Combo División
                                Dim objdivision As New clsDivisiones
                                objdivision.IDDivision = dts.Tables(0).Rows(0).Item("ID_DIVISION")
                                dataset = objdivision.ManejaDivision(1)
                                If objdivision.ErrorDivision = "" Then
                                    If dataset.Tables(0).Rows.Count > 0 Then
                                        objCombo.LlenaCombos(dataset, "DIVISION", "ID_DIVISION", ddldivision, strErr)
                                        If strErr <> "" Then
                                            Exit Function
                                        End If
                                    Else
                                        strErr = "No se encontro información de División."
                                        Exit Function
                                    End If
                                Else
                                    strErr = objdivision.ErrorDivision
                                    Exit Function
                                End If

                            End If
                        Else
                            strErr = "El usuario " & usrname & ", esta asignado a una Agencia inactiva. Comuniquese con su Administrador."
                            Exit Function
                        End If
                    Else
                        strErr = "No se encontro información de Agencias. Comuniquese con su Administrador"
                        Exit Function
                    End If
                Else
                    strErr = objAge.ErrorAgencia
                    Exit Function
                End If
            Else
                strErr = "El usuario " & usrname & " no esta asignado a alguna Agencia. Comuniquese con su Administrador."
                Exit Function
            End If
        Else
            MensajeError(strErr)
        End If

        ''Se llena el combo de Ejecutivo de Ventas
        objUser.IDUsuario = usrid
        dts = objUser.ManejaUsuario(1)

        If dts.Tables(0).Rows.Count > 0 Then
            If objUser.ErrorUsuario = "" Then
                objCombo.LlenaCombos(dts, "NOMBRE", "ID_USUARIO", ddlvendedor, strErr)
                If strErr <> "" Then
                    Exit Function
                End If
            End If
        End If

        ValidaUser = True

    End Function

    Private Function CargaCombos() As Boolean

        Try
            Dim dtsRes As New DataSet
            Dim dtsResDeducible As New DataSet
            Dim objTO As New clsTiposOperacion
            Dim objMarca As New clsMarcas

            Dim renglon() As DataRow
            Dim row As DataRow
            Dim strsql As String = String.Empty
            Dim dsCot As DataSet

            CargaCombos = False


            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Dim idCot As Integer = Val(Request("idCotizacion"))
                'RecargaCotizacion(idCot)

                objCot.IDCotizacion = idCot
                dsCot = objCot.ManejaCotizacion(1)
            End If


            'llena deducible de daños 
            'objCot.IDCotizacion = Val(Request("idCotizacion"))
            'dtsResDeducible = objCot.ManejaCotizacion(35)

            'If objCot.ErrorCotizacion = "" Then
            '    If dtsResDeducible.Tables(0).Rows.Count > 0 Then
            '        objCombo.LlenaCombos(dtsResDeducible, "TEXTO", "VALOR", cmbDedusibleDaños, strErr)
            '        If strErr <> "" Then
            '            Exit Function
            '        End If
            '        cmbDedusibleDaños.Items.Insert(0, New ListItem("< SELECCIONAR >", "-1"))
            '        cmbIndemnizacion.Items.Insert(0, New ListItem("< SELECCIONAR >", "-1"))
            '    End If
            'End If
            If MuestraDeducible = 1 Then
                'obtieneDeducibles()
            End If

            'objCot.IDCotizacion = Val(Request("idCotizacion"))
            'dtsResDeducible = objCot.ManejaCotizacion(36)

            'If objCot.ErrorCotizacion = "" Then
            '    If dtsResDeducible.Tables(0).Rows.Count > 0 Then
            '        objCombo.LlenaCombos(dtsResDeducible, "TEXTO", "VALOR", cmbDeducibleRoboTotal, strErr)
            '        If strErr <> "" Then
            '            Exit Function
            '        End If
            '        cmbDeducibleRoboTotal.Items.Insert(0, New ListItem("< SELECCIONAR>", "-1"))
            '    End If
            'End If

            'Validando el perfil
            ''If Session("idPerfil") = 71 Then
            objEdo.IDUsuario = iduser
            dtsRes = objEdo.ManejaEstado(5)

            If objEdo.ErrorEstados = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_ESTADO", ddledo, strErr)
                    If strErr <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "El usuario no tiene Agencia asignada."
                    Response.Redirect("Default.aspx?mns=" & Trim$(strErr), True)
                    Exit Function
                End If
            Else
                strErr = objEdo.ErrorEstados
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddledo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_ESTADO").ToString
                If Not Me.ddledo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_ESTADO").ToString Then
                    strErr = "No se encontro información de Estado, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            'Combo Agencias
            objAge.IDEstatus = 2
            objAge.IDEstado = ddledo.SelectedValue
            objAge.IDUsuario = iduser
            dtsRes = objAge.ManejaAgencia(26)
            If objAge.ErrorAgencia = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_AGENCIA", ddlagencia, strErr)
                    If Trim$(strErr) <> "" Then
                        Exit Function
                    End If
                    strsql = "ID_AGENCIA = " + ddlagencia.SelectedValue.ToString
                    renglon = dtsRes.Tables(0).Select(strsql)
                    Session("dtsagencias") = Nothing
                    Session("dtsagencias") = dtsRes
                Else
                    strErr = "No se encontro información de Agencias."
                    Exit Function
                End If
            Else
                strErr = objAge.ErrorAgencia
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlagencia.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_AGENCIA").ToString
                If Not Me.ddlagencia.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_AGENCIA").ToString Then
                    strErr = "No se encontro información de Agencia, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            'Combo Alianza
            Dim objalianza As New clsAlianzas
            Dim dataset As New DataSet
            objalianza.IDUsuario = iduser ''dtsRes.Tables(0).Rows(0).Item("ID_ALIANZA")
            objalianza.IDEdo = ddledo.SelectedValue
            dataset = objalianza.ManejaAlianza(10)
            If objalianza.ErrorAlianza = "" Then
                If dataset.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dataset, "ALIANZA", "ID_ALIANZA", ddlalianza, strErr)
                    If strErr <> "" Then
                        Exit Function
                    End If
                    ddlalianza.Items.Insert(0, New ListItem("< SELECCIONAR >", "-1"))

                    For Each row In renglon
                        ddlalianza.SelectedValue = row("ID_ALIANZA")
                    Next
                Else
                    strErr = "No se encontro información de Alianza."
                    Exit Function
                End If

            Else
                strErr = objalianza.ErrorAlianza
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlalianza.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_ALIANZA").ToString
                If Not Me.ddlalianza.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_ALIANZA").ToString Then
                    strErr = "No se encontro información de Alianza, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            'Combo Grupo
            Dim objgrupo As New clsGrupos
            objgrupo.IDUsuario = iduser ''dtsRes.Tables(0).Rows(0).Item("ID_GRUPO")
            objgrupo.IDEdo = ddledo.SelectedValue
            dataset = objgrupo.ManejaGrupo(10)
            If objgrupo.ErrorGrupo = "" Then
                If dataset.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dataset, "GRUPO", "ID_GRUPO", ddlgrupo, strErr)
                    If strErr <> "" Then
                        Exit Function
                    End If
                    ddlgrupo.Items.Insert(0, New ListItem("< SELECCIONAR >", "-1"))
                    For Each row In renglon
                        ddlgrupo.SelectedValue = Val(row("ID_GRUPO"))
                    Next
                Else
                    strErr = "No se encontro información de Grupo."
                    Exit Function
                End If
            Else
                strErr = objgrupo.ErrorGrupo
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlgrupo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_GRUPO").ToString
                If Not Me.ddlgrupo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_GRUPO").ToString Then
                    strErr = "No se encontro información de Grupo, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            'Combo División
            Dim objdivision As New clsDivisiones
            objdivision.IDUsuario = iduser ''dtsRes.Tables(0).Rows(0).Item("ID_DIVISION")
            objdivision.IDEdo = ddledo.SelectedValue
            dataset = objdivision.ManejaDivision(10)
            If objdivision.ErrorDivision = "" Then
                If dataset.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dataset, "DIVISION", "ID_DIVISION", ddldivision, strErr)
                    If strErr <> "" Then
                        Exit Function
                    End If
                    ddldivision.Items.Insert(0, New ListItem("< SELECCIONAR >", "-1"))
                    For Each row In renglon
                        ddldivision.SelectedValue = row("ID_DIVISION")
                    Next
                Else
                    strErr = "No se encontro información de División."
                    Exit Function
                End If
            Else
                strErr = objdivision.ErrorDivision
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddldivision.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_DIVISION").ToString
                If Not Me.ddldivision.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_DIVISION").ToString Then
                    strErr = "No se encontro información de División, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            'Combo Vendedores
            objUser.IDAgencia = ddlagencia.SelectedValue
            objUser.IDEstado = ddledo.SelectedValue
            dtsRes = objUser.ManejaUsuario(15)
            If objUser.ErrorUsuario = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_USUARIO", ddlvendedor, strErr)
                    If strErr <> "" Then
                        MensajeError(strErr)
                        Exit Function

                        'Cuando el usuario es de perfil vendedor se selecciona solo su usuario en el combo de usuarios
                        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
                        If objUsuFirma.IDPerfil = 74 Then
                            ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
                        End If
                    End If
                Else
                    strErr = "No se encontro información de Vendedores."
                    Exit Function
                End If
            Else
                strErr = objUser.ErrorUsuario
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlvendedor.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_VENDEDOR").ToString
                If Not Me.ddlvendedor.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_VENDEDOR").ToString Then
                    strErr = "No se encontro información de Vendedores, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            'Combo Promotores
            objUser.IDAgencia = ddlagencia.SelectedValue
            objUser.IDEstado = ddledo.SelectedValue
            dtsRes = objUser.ManejaUsuario(16)
            If objUser.ErrorUsuario = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_USUARIO", ddlejecutivo, strErr)
                    If strErr <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de F&I."
                    Exit Function
                End If
            Else
                strErr = objUser.ErrorUsuario
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlejecutivo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PROMOTOR").ToString
                If Not Me.ddlejecutivo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PROMOTOR").ToString Then
                    strErr = "No se encontro información de F&I, de la cotización seleccionada."
                    Exit Function
                End If
            End If
            ''End If

            ''Combo Marcas
            ''objMarca.IDClasif = ddlclasif.SelectedValue
            objMarca.IDAgencia = ddlagencia.SelectedValue
            dtsRes = objMarca.ManejaMarca(10)
            strErr = objMarca.ErrorMarcas

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_MARCA", ddlmarca, strErr, False, True, "REG_DEFAULT")
                    If Trim$(strErr) <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Marca."
                    Exit Function
                End If
            Else
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlmarca.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_MARCA").ToString
                If Not Me.ddlmarca.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_MARCA").ToString Then
                    strErr = "No se encontro información de Marca, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            ''combo SubMarca
            objProd.IDMarca = ddlmarca.SelectedValue
            objProd.IDAgencia = ddlagencia.SelectedValue
            dtsRes = objProd.ManejaProducto(5)
            strErr = objProd.ErrorProducto

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_SUBMARCA", ddlmodelo, strErr) 'BBVA-P-412 --RQ18
                    If Trim$(strErr) <> "" Then
                        MensajeError(strErr)
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de SubMarca." 'BBVA-P-412 --RQ18
                    Exit Function
                End If
            Else
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlmodelo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_SUBMARCA").ToString
                If Not Me.ddlmodelo.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_SUBMARCA").ToString Then
                    strErr = "No se encontro información de Sub Marca, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            ''Combo Clasificación
            objProd.IDAgencia = ddlagencia.SelectedValue
            objProd.IDMarca = ddlmarca.SelectedValue
            objProd.IDSubmarca = ddlmodelo.SelectedValue
            dtsRes = objProd.ManejaProducto(11)

            If Trim$(objProd.ErrorProducto) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_PARAMETRO", ddlclasif, strErr)
                    If Trim$(strErr) <> "" Then
                        MensajeError(strErr)
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Clasificación."
                    Exit Function
                End If
            Else
                strErr = objProd.ErrorProducto
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlclasif.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_CLASIFICACION").ToString
                If Not Me.ddlclasif.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_CLASIFICACION").ToString Then
                    strErr = "No se encontro información de Clasificación, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            ''Combo Año
            objProd.IDAgencia = ddlagencia.SelectedValue
            objProd.IDMarca = ddlmarca.SelectedValue
            objProd.IDSubmarca = ddlmodelo.SelectedValue
            objProd.IDClasificacion = ddlclasif.SelectedValue
            dtsRes = objProd.ManejaProducto(12)
            strErr = objProd.ErrorProducto

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_ANIO", ddlanio, strErr)
                    If Trim$(strErr) <> "" Then
                        MensajeError(strErr)
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Productos." 'BBVA-P-412 --RQ18
                    Exit Function
                End If
            Else
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlanio.SelectedValue = dsCot.Tables(0).Rows(0).Item("ANIO_MODELO_USADOS").ToString
                If Not Me.ddlanio.SelectedValue = dsCot.Tables(0).Rows(0).Item("ANIO_MODELO_USADOS").ToString Then
                    strErr = "No se encontro información de Año, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            ''Combo Version
            objProd.IDAgencia = ddlagencia.SelectedValue
            objProd.IDMarca = ddlmarca.SelectedValue
            objProd.IDSubmarca = ddlmodelo.SelectedValue
            objProd.IDClasificacion = ddlclasif.SelectedValue
            objProd.IDAnio = ddlanio.SelectedValue
            dtsRes = objProd.ManejaProducto(13)
            strErr = objProd.ErrorProducto

            If Trim$(strErr) = "" Then

                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_VERSION", ddlversion, strErr)
                    If Trim$(strErr) <> "" Then
                        MensajeError(strErr)
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Versiones." 'BBVA-P-412 --RQ18
                    Exit Function
                End If
            Else
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlversion.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_VERSION").ToString
                If Not Me.ddlversion.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_VERSION").ToString Then
                    strErr = "No se encontro información de Versión, de la cotización seleccionada."
                    Exit Function
                End If
            End If



            ''TextBox Precio Producto
            objProd.IDMarca = ddlmarca.SelectedValue
            objProd.IDSubmarca = ddlmodelo.SelectedValue
            objProd.IDVersion = ddlversion.SelectedValue
            objProd.IDAnio = ddlanio.SelectedValue
            objProd.IDClasificacion = ddlclasif.SelectedValue
            dtsRes = objProd.ManejaProducto(8)

            If objProd.ErrorProducto = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then

                    If dtsRes.Tables(0).Rows(0).Item("ID_CLASIFICACION") = 63 Then 'Nuevo
                        txtprecio.Text = Val(CDbl(dtsRes.Tables(0).Rows(0).Item("PRECIO"))).ToString("###,###.00")
                    ElseIf dtsRes.Tables(0).Rows(0).Item("ID_CLASIFICACION") = 64 Then 'Seminuevo
                        txtprecio.Text = Val(CDbl(dtsRes.Tables(0).Rows(0).Item("PRECIO_SEMINUEVO"))).ToString("###,###.00")
                    Else 'Ambos
                        If ddlclasif.SelectedValue = 63 Then 'Nuevo
                            txtprecio.Text = Val(CDbl(dtsRes.Tables(0).Rows(0).Item("PRECIO"))).ToString("###,###.00")
                            ddlGarantia.Enabled = True
                            divmtogarantia.Visible = True
                            divmtogarantia.Attributes("class") = "visible"
                        ElseIf ddlclasif.SelectedValue = 64 Then 'Seminievo
                            txtprecio.Text = Val(CDbl(dtsRes.Tables(0).Rows(0).Item("PRECIO_SEMINUEVO"))).ToString("###,###.00")
                            ddlGarantia.Enabled = False
                            divmtogarantia.Visible = False
                            divmtogarantia.Attributes("class") = "hidden"
                        End If
                    End If
                Else
                    strErr = "No se encontro información de Producto."
                End If
            Else
                strErr = objProd.ErrorProducto
                Exit Function
            End If

            ''Combo Tasas IVA
            objIva.IDEstatus = 2
            dtsRes = objIva.ManejaTasaIVA(1)
            strErr = objIva.ErrorTasasIVA

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_TASA_IVA", ddliva, strErr)
                    If Trim$(strErr) <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de IVA."
                    Exit Function
                End If
            Else
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddliva.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_TASA_IVA").ToString
                If Not Me.ddliva.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_TASA_IVA").ToString Then
                    strErr = "No se encontro información de IVA, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            ''Combo Monedas Factura
            objMon.IDEstatus = 2
            dtsRes = objMon.ManejaMoneda(1)
            strErr = objMon.ErrorMoneda

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_MONEDA", ddlmonedafact, strErr)
                    If Trim$(strErr) <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Moneda."
                    Exit Function
                End If
            Else
                Exit Function
            End If
            'BUG-PC-45:AVH
            If Val(Request("idCotizacion")) <> 0 Then
                Me.ddlmonedafact.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_MONEDA_FACTURA").ToString
                If Not Me.ddlmonedafact.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_MONEDA_FACTURA").ToString Then
                    strErr = "No se encontro información de Moneda Factura, de la cotización seleccionada."
                    Exit Function
                End If
            End If

            ''Combo de Monedas de cotización derivado del combo de monedas de factura
            If ddlmonedafact.SelectedValue > 0 Then

                objMon.IDMoneda = ddlmonedafact.SelectedValue
                dtsRes = objMon.ManejaMoneda(5)
                strErr = objMon.ErrorMoneda

                If Trim$(strErr) = "" Then
                    If dtsRes.Tables(0).Rows.Count > 0 Then
                        objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_MONEDA", ddlmonedafin, strErr)
                        If Trim$(strErr) <> "" Then
                            Exit Function
                        End If
                    Else
                        strErr = "No se encontro información de Moneda."
                        Exit Function
                    End If
                Else
                    Exit Function
                End If
                'BUG-PC-45:AVH
                If Val(Request("idCotizacion")) <> 0 Then
                    Me.ddlmonedafin.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_MONEDA").ToString
                    If Not Me.ddlmonedafin.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_MONEDA").ToString Then
                        strErr = "No se encontro información de Moneda, de la cotización seleccionada."
                        Exit Function
                    End If
                End If
            End If

            ''Combo Paquetes
            prodid = ObtenProducto()

            objPaq.IDMoneda = ddlmonedafin.SelectedValue
            objPaq.IDProducto = prodid
            objPaq.IDAgencia = ddlagencia.SelectedValue
            objPaq.IDClasificacionProd = ddlclasif.SelectedValue

            dtsRes = objPaq.ManejaPaquete(38)

            If objPaq.ErrorPaquete = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_PAQUETE", ddlplan, strErr)
                    If strErr <> "" Then
                        divfinadic.Visible = False
                        Exit Function
                    Else
                        objPaq = New clsPaquetes
                        objPaq.CargaPaquete(ddlplan.SelectedValue)
                        If objPaq.PermitePagosEspeciales = 1 Then
                            chkPagosEsp.Checked = True
                            tbPagosEspeciales.Visible = True
                            chkPagosEsp.Enabled = False
                        Else
                            chkPagosEsp.Enabled = False
                        End If


                        'BUG-PC-34 MAUT 12/01/2017 Si es balloon, se muestran los valores de valor residual
                        If objPaq.IDTipoCalculo <> 167 Then
                            div17.Visible = False
                            tdlblresidual.Visible = False
                            tdtxtresidual.Visible = False
                            txtenganche.Enabled = True
                            txtporeng.Enabled = True
                            tdEngancheCI.Visible = False
                            ddlengancheCI.Visible = False
                        Else
                            div17.Visible = True
                            tdlblresidual.Visible = True
                            tdtxtresidual.Visible = True
                            txtenganche.Enabled = False
                            txtporeng.Enabled = False
                            tdEngancheCI.Visible = True
                            ddlengancheCI.Visible = True
                        End If
                        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
                        VerificaSubsidio(objPaq)
                    End If
                Else
                    strErr = "No existe Paquete Financiero con los parámetros seleccionados."
                    divfinadic.Visible = False
                    Exit Function
                End If
                'BUG-PC-45:AVH
                If Val(Request("idCotizacion")) <> 0 Then
                    Me.ddlplan.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PAQUETE").ToString
                    If Not Me.ddlplan.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PAQUETE").ToString Then
                        strErr = "No se encontro información de Paquete, de la cotización seleccionada."
                        Exit Function
                    End If
                End If
            Else
                strErr = objPaq.ErrorPaquete
                divfinadic.Visible = False
                Exit Function
            End If

            'Leyenda Promoción
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.IDPROMOCION <> 1 Then
                Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
                If objPromo.ErrorPromociono = "" Then
                    lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
                End If
            Else
                lblpromoleyenda.Text = ""
            End If

            ''Combo Plazos
            objPlazos.IDPaquete = ddlplan.SelectedValue
            dtsRes = objPlazos.ManejaPlazos(5)

            If objPlazos.StrErrPlazo = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "DESCRIPCION", "ID_PLAZO", ddlplazos, strErr)
                    If strErr <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Plazo."
                    Exit Function
                End If
                'BUG-PC-45:AVH
                If Val(Request("idCotizacion")) <> 0 Then
                    Me.ddlplazos.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PLAZO").ToString
                    If Not Me.ddlplazos.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PLAZO").ToString Then
                        strErr = "No se encontro información de Plazos, de la cotización seleccionada."
                        Exit Function
                    End If
                End If
            Else
                strErr = objPlazos.StrErrPlazo
                Exit Function
            End If


            ''Tasa
            objPlazos.IDPaquete = ddlplan.SelectedValue
            objPlazos.Id_Plazo = ddlplazos.SelectedValue
            dtsRes = objPlazos.ManejaPlazos(6)

            If objPlazos.StrErrPlazo = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    txttasa.Text = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL")
                Else
                    MensajeError("No se encontro información de la tasa.")
                    Return Nothing
                    Exit Function
                End If
            Else
                MensajeError(objPlazos.StrErrPlazo)
                Exit Function
            End If


            ''Compra Inteligente
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)

            If objPaq.IDTipoCalculo = 167 Then
                Dim Objver As New clsVersiones()
                Objver.IDVersion = ddlversion.SelectedValue
                Objver.Plazo = ddlplazos.SelectedValue

                dtsRes = Objver.ManejaVersion(8)
                If Objver.ErrorVersion = "" Then
                    If dtsRes.Tables.Count > 0 Then
                        If dtsRes.Tables(0).Rows.Count > 0 Then
                            objCombo.LlenaCombos(dtsRes, "PORC_ENGANCHE", "ID", ddlengancheCI, strErr)
                            If strErr <> "" Then
                                Exit Function
                            End If

                            txtporeng.Text = ddlengancheCI.SelectedItem.Text
                            lblengmin.Text = ddlengancheCI.SelectedItem.Text
                            Dim dtsResver As New DataSet
                            Dim clsver As New clsVersiones
                            clsver.IDVersion = ddlversion.SelectedValue
                            clsver.Plazo = ddlplazos.SelectedValue
                            clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)

                            dtsResver = clsver.ManejaVersion(9)
                            txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                            txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
                            txtenganche.Text = Val((CDbl(txtporeng.Text.Trim) / 100) * txtprecio.Text).ToString("###,##0.00")
                        Else
                            ddlengancheCI.Enabled = False
                            CalculaEnganche(0)
                        End If
                    Else
                        ddlengancheCI.Enabled = False
                    End If
                Else
                    strErr = Objver.ErrorVersion
                End If
            Else
                CalculaEnganche(0)
            End If


            ''Combo Tipos Operación
            objTO.IDPaquete = ddlplan.SelectedValue
            dtsRes = objTO.ManejaTipoOperacion(13)
            strErr = objTO.ErrorTipoOperacion

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_TIPO_OPERACION", ddltoperacion, strErr)
                    If Trim$(strErr) <> "" Then
                        MensajeError(strErr)
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Tipo de Operación."
                    Exit Function
                End If
                'BUG-PC-45:AVH
                If Val(Request("idCotizacion")) <> 0 Then
                    Me.ddltoperacion.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_TIPO_OPER").ToString
                    If Not Me.ddltoperacion.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_TIPO_OPER").ToString Then
                        strErr = "No se encontro información de Tipo de Operación, de la cotización seleccionada."
                        Exit Function
                    End If
                End If
            Else
                Exit Function
            End If

            ''Combo Personalidad Jurídica
            objParam.IDPaquete = ddlplan.SelectedValue
            dtsRes = objParam.ManejaParametro(5)
            strErr = objParam.ErrorParametros
            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "TEXTO", "ID_PARAMETRO", ddlpj, strErr)
                    If Trim$(strErr) <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Personalidad Jurídica."
                End If
                'BUG-PC-45:AVH
                If Val(Request("idCotizacion")) <> 0 Then
                    Me.ddlpj.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PER_JURIDICA").ToString
                    If Not Me.ddlpj.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_PER_JURIDICA").ToString Then
                        strErr = "No se encontro información de Personalidad Jurídica, de la cotización seleccionada."
                        Exit Function
                    End If
                End If
            Else
                Exit Function
            End If

            ddlpj_SelectedIndexChanged(ddlpj, Nothing)

            ''Combo Giros
            Dim objGiros As New clsGiros
            objGiros.IDEstatus = 2
            objGiros.TipoOperacion = ddltoperacion.SelectedValue
            dtsRes = objGiros.ManejaGiro(5)
            strErr = objGiros.ErrorGiros

            If Trim$(strErr) = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then
                    objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_GIRO", ddlgiro, strErr, False, True, "REG_DEFAULT")
                    If Trim$(strErr) <> "" Then
                        Exit Function
                    End If
                Else
                    strErr = "No se encontro información de Giro."
                    Exit Function
                End If
                'BUG-PC-45:AVH
                If Val(Request("idCotizacion")) <> 0 Then
                    Me.ddlgiro.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_GIRO").ToString
                    If Not Me.ddlgiro.SelectedValue = dsCot.Tables(0).Rows(0).Item("ID_GIRO").ToString Then
                        strErr = "No se encontro información de Giro, de la cotización seleccionada."
                        Exit Function
                    End If
                End If
            Else
                Exit Function
            End If
            CargaCombos = True
        Catch ex As Exception
            strErr = ex.Message
            CargaCombos = False
        End Try
    End Function

    Private Function CargaCombos2() As Boolean
        Dim dtsRes As New DataSet
        Dim objAseg As New clsAseguradoras
        Dim dsDatos As New DataSet()
        Dim objParam_1 As New clsParametros
        dsDatos = objParam_1.ManejaParametro(10)

        CargaCombos2 = False

        SetInitialRow()
        lbltotalacc.Text = "0.00"
        'BUG-PC-45:AVH
        'If Val(Request("idCotizacion")) <> 0 Then
        '    Dim idCot As Integer = Val(Request("idCotizacion"))
        '    'RecargaCotizacion(idCot)
        '    Dim ds As DataSet
        '    objCot.IDCotizacion = idCot
        '    ds = objCot.ManejaCotizacion(1)

        '    Me.ddlplazos.SelectedValue = ds.Tables(0).Rows(0).Item("ID_PLAZO").ToString
        'End If

        ''Combo Estado Seguros
        objEdo.IDEstatus = 2
        dtsRes = objEdo.ManejaEstado(1)

        If objEdo.ErrorEstados = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_ESTADO", ddledoseg, strErr)
                If strErr <> "" Then
                    MensajeError(strErr)
                    Exit Function
                End If
            Else
                MensajeError("No se encontro información de Estados para Seguros.")
                Exit Function
            End If
        Else
            MensajeError(objEdo.ErrorEstados)
            Exit Function
        End If
        ddledoseg.SelectedValue = ddledo.SelectedValue

        Dim brokerid As Integer = obten_broker()
        ''Combo Tipo Unidad / Seguros
        objCot.IDAlianza = ddlalianza.SelectedValue
        dtsRes = objCot.ManejaCotizacion(21)
        If objCot.ErrorCotizacion = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_TIPO", ddltipounidad, strErr, True)
                If strErr <> "" Then
                    MensajeError(strErr)
                End If
            Else
                MensajeError("No se encontro información de Tipo Unidad")
                ddltipounidad.Items.Clear()
                Exit Function
            End If
        Else
            MensajeError(objCot.ErrorCotizacion)
            Exit Function
        End If


        ''Combo Uso / Seguros
        brokerid = obten_broker()
        objCot.IDAlianza = ddlalianza.SelectedValue
        dtsRes = objCot.ManejaCotizacion(22)
        If objCot.ErrorCotizacion = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_USO", ddluso, strErr, True)
                If strErr <> "" Then
                    MensajeError(strErr)
                    Exit Function
                End If
            Else
                MensajeError("No se encontro información de Usos")
                ddluso.Items.Clear()
                Exit Function
            End If
        Else
            MensajeError(objCot.ErrorCotizacion)
            Exit Function
        End If
        ddluso.Enabled = True

        ''Combo Tipos Seguros
        objPaq.IDPaquete = ddlplan.SelectedValue
        dtsRes = objPaq.ManejaPaquete(40)
        If objPaq.ErrorPaquete = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_PARAMETRO", ddltiposeg, strErr, False)
                If strErr <> "" Then
                    MensajeError(strErr)
                    Exit Function
                End If
            Else
                MensajeError("No se encontro información de Tipos de Seguros.")
                ddltiposeg.Items.Clear()
                Exit Function
            End If
        Else
            MensajeError(objPaq.ErrorPaquete)
            Exit Function
        End If

        ''Combo Tipos Seguros Vida
        objPaq = New clsPaquetes
        objPaq.IDPaquete = ddlplan.SelectedValue
        dtsRes = objPaq.ManejaPaquete(52)
        If strErr = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "TIPO_SEGUROVIDA", "ID_PARAMETRO", ddlsegvida, strErr, False)
                If strErr <> "" Then
                    MensajeError(strErr)
                    Exit Function
                End If
            Else
                MensajeError("No se encontro información de Tipos de Seguros de Vida.")
                ddlsegvida.Items.Clear()
                Exit Function
            End If
        Else
            MensajeError(strErr)
            Exit Function
        End If

        If ViewState("vwsCobertura") <> 0 Or IsNothing(ViewState("vwsCobertura")) Then
            Dim bolLlena As Boolean = False
            Dim intValue As Integer
            'BUG-PC-173: CGARCIA: 05/04/2018: SE MODIFICAN ALIANZAS PARA SEGURO A TU MEDIDA
            For index As Integer = 0 To dsDatos.Tables(0).Rows.Count - 1 Step 1
                intValue = dsDatos.Tables(0).Rows(index).Item("ID_ALIANZA").ToString()
                If ddlalianza.SelectedValue = intValue Then
                    ObtenSubplan()
                    bolLlena = True
                    ViewState("vwsCobertura") = 0
                End If
            Next
            If bolLlena = False Then
                'Combo Cobertura / Seguros
                objCot.IDAlianza = ddlalianza.SelectedValue
                objCot.IDClasificacionProd = ddlclasif.SelectedValue
                dtsRes = objCot.ManejaCotizacion(28)
                If objCot.ErrorCotizacion = "" Then
                    If dtsRes.Tables(0).Rows.Count > 0 Then
                        objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_COBERTURA", ddlcobertura, strErr, True)
                        If strErr <> "" Then
                            MensajeError(strErr)

                            'ddlcobertura.DataTextField = ""
                            'ddlcobertura.DataValueField = "35"
                            'ddlcobertura.DataMember

                            'ddlcobertura.DataSource = "nombre data"
                            'ddlcobertura.DataBind()

                            Dim str1 As String = ddlcobertura.DataMember
                            Exit Function
                        End If
                    Else
                        MensajeError("No se encontro información de Cobertura")
                        ddlcobertura.Items.Clear()
                        Exit Function
                    End If
                Else
                    MensajeError(objCot.ErrorCotizacion)
                    Exit Function
                End If
            End If

        Else

            Dim bolLlena As Boolean = False
            Dim intValue As Integer
            'BUG-PC-173: CGARCIA: 05/04/2018: SE MODIFICAN ALIANZAS PARA SEGURO A TU MEDIDA
            For index As Integer = 0 To dsDatos.Tables(0).Rows.Count - 1 Step 1
                intValue = dsDatos.Tables(0).Rows(index).Item("ID_BROKER").ToString()
                If obten_broker() = intValue Then
                    ObtenSubplan()
                    bolLlena = True
                    ViewState("vwsCobertura") = 0
                    Exit For
                Else
                    ViewState("vwsCobertura") = 1
                End If
            Next
            If ViewState("vwsCobertura") <> 0 Then
                objCot.IDAlianza = ddlalianza.SelectedValue
                objCot.IDClasificacionProd = ddlclasif.SelectedValue
                dtsRes = objCot.ManejaCotizacion(28)
                If objCot.ErrorCotizacion = "" Then
                    If dtsRes.Tables(0).Rows.Count > 0 Then
                        objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_COBERTURA", ddlcobertura, strErr, True)
                        If strErr <> "" Then
                            MensajeError(strErr)
                            Exit Function
                        End If
                    Else
                        MensajeError("No se encontro información de Cobertura")
                        ddlcobertura.Items.Clear()
                        Exit Function
                    End If
                Else
                    MensajeError(objCot.ErrorCotizacion)
                    Exit Function
                End If

            End If

        End If


        ''Combo Aseguradoras
        'BBVA-P-412
        Dim objparam As New clsParametros(178) 'Consulta por Alianza
        If objparam.Valor = 1 Then
            objAseg.IDAlianza = ddlalianza.SelectedValue
        Else
            objAseg.IDPaquete = ddlplan.SelectedValue
        End If


        If brokerid = 2 Then
            ddlGarantia.Items.Clear()
            If ObtenGarantiaOrdas() Then
                Dim dtsplazogar As New DataTable

                dtsplazogar = DirectCast(ViewState("dtsGarantia"), DataTable)
                ddlGarantia.Items.Add(New ListItem("< SELECCIONAR >", "0"))
                For i As Integer = 0 To dtsplazogar.Rows.Count - 1
                    Dim coverid As String = dtsplazogar.Rows(i).Item("idPack").ToString

                    Select Case coverid
                        Case "3627"  ' se agrega garantia de 12 meses cambio urgente rhernandez
                            ddlGarantia.Items.Add(New ListItem("1 AÑO", "12"))
                        Case "3629"
                            ddlGarantia.Items.Add(New ListItem("2 AÑOS", "24"))
                        Case "3639"
                            ddlGarantia.Items.Add(New ListItem("3 AÑOS", "36"))
                    End Select
                Next
            Else
                ddlGarantia.Items.Clear()
                ddlGarantia.Items.Add(New ListItem("< SELECCIONAR >", "0"))
                ddlGarantia.Items.Add(New ListItem("1 AÑO", "12"))
                ddlGarantia.Items.Add(New ListItem("2 AÑOS", "24"))
                ddlGarantia.Items.Add(New ListItem("3 AÑOS", "36"))
            End If
            txtmtogarantia.Enabled = False
            divmtogarantia.Visible = False
            divmtogarantia.Attributes("class") = "hidden"
        Else
            ddlGarantia.Items.Clear()
            ddlGarantia.Items.Add(New ListItem("< SELECCIONAR >", "0"))
            ddlGarantia.Items.Add(New ListItem("1 AÑO", "12"))
            ddlGarantia.Items.Add(New ListItem("2 AÑOS", "24"))
            ddlGarantia.Items.Add(New ListItem("3 AÑOS", "36"))

            txtmtogarantia.Enabled = True
            divmtogarantia.Visible = True
            divmtogarantia.Attributes("class") = "visible"
        End If

        ddlGarantia.SelectedValue = 0
        txtmtogarantia.Text = ""


        dtsRes = objAseg.ManejaAseguradora(8)
        ViewState("vwsBrokerID") = dtsRes.Tables(0).Rows(0).Item("ID_BROKER")
        If objAseg.ErrorAseguradora = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "RAZON_SOCIAL", "ID_ASEGURADORA", ddlaseguradora, strErr, True)
                If strErr <> "" Then
                    MensajeError(strErr)
                End If
            Else
                MensajeError("No se encontro información de Aseguradoras.")
                ddlaseguradora.Items.Clear()
                Exit Function
            End If
        Else
            MensajeError(objAseg.ErrorAseguradora)
            Exit Function
        End If


        If brokerid = 2 Then
            If grvSeguro.Rows.Count = 0 Then
                ddlaseguradora.SelectedValue = 55
            End If
        End If

        'RQ-PC5
        'BUG-PC-191 BUG-PC-193
        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) Or (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
            dvrecurrecte.Visible = True
            dvcodpostal.Visible = True
        Else
            dvrecurrecte.Visible = False
            dvcodpostal.Visible = False
        End If

        If chkPagosEsp.Checked = True Then
            tbPagosEspeciales.Visible = True
        Else
            tbPagosEspeciales.Visible = False
        End If

        If (ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168) Then
            finseg.Visible = False
            btncotizaseg.Enabled = False
            ddlaseguradora.Enabled = False
            ddltipounidad.Enabled = False
            ddluso.Enabled = False
            ddlcobertura.Enabled = False
            txtedad.Enabled = False
            rdbsexh.Enabled = False
            rdbsexm.Enabled = False
            rdbsexh.Checked = False
            rdbsexm.Checked = False
            txtconductor.Enabled = False
            txtconductor.Text = ""
            txtedad.Text = ""
            txtcprecurrente.Enabled = False
            txtcprecurrente.Text = ""
            cmbIndemnizacion.Enabled = False
            cmbDedusibleDaños.Enabled = False
            cmbDeducibleRoboTotal.Enabled = False
            'BUG-PC-196
            If brokerid = 5 OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
                dvrecurrecte.Visible = False
                dvrecurrecte.Style("display") = "none"
        Else
               dvrecurrecte.Style("display") = "contents"
            End If
        Else
            'RQ-PC5 BUG-PC-193
            If brokerid = 5 OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
                txtcprecurrente.Enabled = True
                txtcprecurrente.Text = ""
                txtedad.Visible = False
                rdbsexh.Visible = False
                rdbsexm.Visible = False
                rdbsexh.Checked = False
                rdbsexm.Checked = False
                txtconductor.Visible = False
                txtconductor.Text = ""
                txtedad.Text = ""
                div21.Visible = False
                div22.Visible = False
                div28.Visible = False
                dvrecurrecte.Visible = False
                dvrecurrecte.Style("display") = "none"
                cmbIndemnizacion.Enabled = True
                cmbDedusibleDaños.Enabled = True
                cmbDeducibleRoboTotal.Enabled = True
            Else
                finseg.Visible = True
                btncotizaseg.Enabled = True
                ddlaseguradora.Enabled = True
                ddltipounidad.Enabled = True
                ddluso.Enabled = True
                ddlcobertura.Enabled = True
                txtedad.Enabled = True
                rdbsexh.Enabled = False
                rdbsexm.Enabled = False
                rdbsexh.Enabled = True
                rdbsexm.Enabled = True
                rdbsexh.Checked = False
                rdbsexm.Checked = False
                txtconductor.Enabled = True
                txtconductor.Text = ""
                txtedad.Text = ""
                txtcprecurrente.Enabled = True
                txtcprecurrente.Text = ""
                txtedad.Visible = True
                rdbsexh.Visible = True
                rdbsexm.Visible = True
                txtconductor.Visible = True
                div21.Visible = True
                div22.Visible = True
                div28.Visible = True
                dvrecurrecte.Style("display") = "contents"
            End If
        End If

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        If objPlazos.StrErrPlazo = "" Then
            Dim id_prod As Integer = ObtenProducto()
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, ddlsegvida.SelectedValue, id_prod)
        Else
            MensajeError(objPlazos.StrErrPlazo)
            Exit Function
        End If

        LlenaComboPagEsp()
        LlenaPagEsp(ddlplazos.SelectedValue)

        If brokerid <> 2 Then
            If (ddltipounidad.Items.Count = 0 Or ddluso.Items.Count = 0 Or ddlcobertura.Items.Count = 0 Or ddlaseguradora.Items.Count = 0) And (ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168) Then
                btncotizaseg.Enabled = False
                ddlaseguradora.Enabled = False
                ddltipounidad.Enabled = False
                ddluso.Enabled = False
                ddlcobertura.Enabled = False
                If ddltiposeg.Items.Count > 0 Then
                    ddltiposeg.Enabled = True
                Else
                    ddltiposeg.Enabled = False
                End If
                If ddlsegvida.Items.Count > 0 Then
                    ddlsegvida.Enabled = True
                Else
                    ddlsegvida.Enabled = False
                End If
            Else
                btncotizaseg.Enabled = True
                ddlaseguradora.Enabled = True
                ddltipounidad.Enabled = True
                ddluso.Enabled = True
                ddlcobertura.Enabled = True
                If ddltiposeg.Items.Count > 0 Then
                    ddltiposeg.Enabled = True
                Else
                    ddltiposeg.Enabled = False
                End If
                If ddlsegvida.Items.Count > 0 Then
                    ddlsegvida.Enabled = True
                Else
                    ddlsegvida.Enabled = False
                End If
            End If
        End If

        If ddlsegvida.SelectedValue = 172 Then
            Session("montoSegVida") = "0.00"
            Session("idquotevida") = "0"
            btncotizaseg.Enabled = False
        Else
            btncotizaseg.Enabled = True
        End If

        If ValidaSistema() = True Then
            idSistema = 1
        Else
            idSistema = 0
        End If

        If idSistema = 1 Then
            If ddlpj.SelectedValue = 14 Then
                btnGeneraSol.Visible = True
            End If
        Else
            btnGeneraSol.Visible = False
        End If
        finseg.Visible = False
        'If ddlplan.SelectedValue <> "" Then
        '    ddlplan_SelectedIndexChanged(ddlplan, Nothing)
        'End If
        CargaCombos2 = True

    End Function

    'RQ06
    Private Function LlenaGrvMultiplazos(IDPaq As Integer, Precio As Integer, Enganche As Double, IDPerJur As Integer, IDTipoOper As Integer,
                                         IDClasif As Integer, Unidades As Integer, TasaIVA As Double, MontoAcc As Double, MontoAccContado As Double, Plazo As Integer,
                                         Optional PtjEng As Double = 0, Optional Band As Integer = 0, Optional IDVersion As Integer = Nothing, Optional IDTipoUnidad As Integer = 0,
                                         Optional IDTipoSeg As Integer = 0, Optional Cobertura As Integer = 0, Optional Uso As Integer = 0,
                                         Optional MontoSegProd As Double = 0, Optional MontoSegGAP As Double = 0, Optional MontoSegVida As Double = 0,
                                         Optional Derecho As Double = 0, Optional IDAseguradora As Integer = 0, Optional IDEdo As Integer = 0, Optional broker As Integer = 0,
                                         Optional params As String = "", Optional mtogarantia As Double = 0, Optional tiposegvida As Integer = 0, Optional id_prod As Integer = 0) As Boolean
        Try
            Dim dts As New DataSet
            Dim objCotiza As New clsCotizaciones

            LlenaGrvMultiplazos = False

            objCotiza.IDPaquete = IDPaq ''ddlplan.SelectedValue
            objCotiza.PrecioProducto = Precio ''ddlmodelo.SelectedValue
            objCotiza.MontoEnganche = Enganche ''CDbl(txtenganche.Text.Trim)
            objCotiza.IDPersonalidadJuridica = IDPerJur ''ddlpj.SelectedValue
            objCotiza.IDTipoSeguro = IDTipoSeg ''ddltiposeg.SelectedValue
            objCotiza.IDTipoOperacion = IDTipoOper ''ddltoperacion.SelectedValue
            objCotiza.UnidadesProducto = Unidades ''txtUniProd.Text.Trim
            objCotiza.IDTasaIVA = TasaIVA ''ddliva.SelectedValue
            objCotiza.Cobertura = Cobertura ''""
            objCotiza.IDtipo = IDTipoUnidad
            objCotiza.IDuso = Uso ''ddluso.SelectedValue
            objCotiza.MontoAccesorios = MontoAcc ''CDbl(lbltotalacc.Text.Trim)
            objCotiza.MontoAccesoriosContado = MontoAccContado
            objCotiza.MontoSeguro = MontoSegProd
            objCotiza.MontoSeguro1 = MontoSegGAP
            objCotiza.MontoSeguro2 = MontoSegVida
            objCotiza.MontoSeguro3 = Derecho
            objCotiza.ValorPlazo = Plazo
            objCotiza.IDClasificacionProd = IDClasif
            objCotiza.PtjEnganche = PtjEng
            objCotiza.IDBandera = Band
            objCotiza.IDVersion = IDVersion
            objCotiza.IDAseguradora = IDAseguradora
            objCotiza.IDEstado = IDEdo
            objCotiza.Broker = broker
            objCotiza.Params = params
            objCotiza.MtoGarantia = mtogarantia
            objCotiza.IDAplicacionSeguroVida = IIf(String.IsNullOrEmpty(ddlsegvida.SelectedValue), 0, ddlsegvida.SelectedValue)
            objCotiza.IDProducto = id_prod


            If ViewState("PlazoMod") <> "" Then
                objCotiza.PlazoModifica = ViewState("PlazoMod")
                'End If	 MUAA
            ElseIf ViewState("SubsidioMod") <> "" Then
                objCotiza.PlazoModifica = ViewState("SubsidioMod")
            End If

            dts = objCotiza.LlenaGrid()

            If objCotiza.ErrorCotizacion = "" Then
                If dts.Tables(0).Rows.Count > 0 Then
                    grvMultiCotiza.DataSource = dts
                    grvMultiCotiza.DataBind()

                    'BBVA-P-412 RQ WSC AVH:
                    ViewState("MulPlazos") = Nothing
                    ViewState("MulPlazos") = grvMultiCotiza.DataSource
                Else
                    MensajeError("No se pudo cargar la cotización.")
                    Exit Function
                End If
            Else
                MensajeError(objCotiza.ErrorCotizacion)
                Exit Function
            End If

            LlenaGrvMultiplazos = True
        Catch ex As Exception
            MensajeError(ex.Message)
            LlenaGrvMultiplazos = False
        End Try

    End Function

    Private Function ValidaSistema() As Boolean
        Try
            ValidaSistema = False

            Dim objSist As New SNProcotiza.clsSistema
            Dim dtsRes As New DataSet
            Dim strSistema As Integer = 0
            Dim i As Integer

            objSist.IDEstatus = 2
            dtsRes = objSist.ManejaSistema(1)

            If dtsRes.Tables.Count > 0 Then
                If dtsRes.Tables(0).Rows.Count > 0 Then


                    For i = 0 To dtsRes.Tables(0).Rows.Count - 1
                        strSistema = dtsRes.Tables(0).Rows(i).Item(0)
                        If strSistema = 1 Then
                            ValidaSistema = True
                            Exit Function
                        Else
                            ValidaSistema = False
                        End If

                    Next
                Else
                    MensajeError("No se encontró información con los parámetros proporcionados")
                End If
            Else
                MensajeError("No se encontró información para los parámetros proporcionados")
            End If
        Catch ex As Exception
            MensajeError(ex.Message)
            Return False
        End Try
    End Function

    Protected Sub ButtonAdd_Click(sender As Object, e As EventArgs)
        AddNewRowToGrid()
    End Sub

    Private Sub ResetRowID(dt As DataTable)
        Dim rowNumber As Integer = 1
        If dt.Rows.Count > 0 Then
            For Each row As DataRow In dt.Rows
                row(0) = rowNumber
                rowNumber += 1
            Next
        End If
    End Sub

    Protected Sub grvAccesorios_RowCreated(sender As Object, e As System.Web.UI.WebControls.GridViewRowEventArgs) Handles grvAccesorios.RowCreated
        If e.Row.RowType = DataControlRowType.DataRow Then
            Dim dt As DataTable = DirectCast(ViewState("CurrentTable"), DataTable)
            Dim imgbtn As ImageButton = DirectCast(e.Row.FindControl("ImageButton1"), ImageButton)
            If imgbtn IsNot Nothing Then
                If dt.Rows.Count > 1 Then
                    If e.Row.RowIndex = dt.Rows.Count - 1 Then
                        imgbtn.Visible = False
                    End If
                Else
                    imgbtn.Visible = False
                End If


            End If
        End If
    End Sub

    Protected Sub ImageButton1_Click(sender As Object, e As EventArgs)
        ''Protected Sub LinkButton1_Click(sender As Object, e As EventArgs)

        Dim lb As ImageButton = DirectCast(sender, ImageButton)
        Dim gvRow As GridViewRow = DirectCast(lb.NamingContainer, GridViewRow)
        Dim rowID As Integer = gvRow.RowIndex
        Dim acc As String = String.Empty
        Dim drCurrentRow As DataRow = Nothing

        If ViewState("CurrentTable") IsNot Nothing Then

            Dim dt As DataTable = DirectCast(ViewState("CurrentTable"), DataTable)
            If dt.Rows.Count > 1 Then
                If gvRow.RowIndex < dt.Rows.Count - 1 Then

                    acc = dt.Rows(rowID).Item("Column1").ToString
                    'Remove the Selected Row data and reset row number  
                    dt.Rows.Remove(dt.Rows(rowID))
                    ResetRowID(dt)

                    If acc <> "GARANTIA EXTENDIDA" Then
                        drCurrentRow = dt.NewRow()
                        drCurrentRow("RowNumber") = dt.Rows.Count + 1
                        'add new row to DataTable   
                        dt.Rows.Add(drCurrentRow)
                    End If
                Else
                    acc = dt.Rows(rowID).Item("Column1").ToString
                    If acc = "GARANTIA EXTENDIDA" Then
                        dt.Rows.Remove(dt.Rows(rowID))
                        ResetRowID(dt)
                    ElseIf acc <> "GARANTIA EXTENDIDA" And rowID = 1 Then
                        dt.Rows.Remove(dt.Rows(rowID))
                        ResetRowID(dt)
                        drCurrentRow = dt.NewRow()
                        drCurrentRow("RowNumber") = dt.Rows.Count + 1
                        'add new row to DataTable   
                        dt.Rows.Add(drCurrentRow)
                    End If
                End If
            Else
                acc = dt.Rows(rowID).Item("Column1").ToString
                If acc <> "GARANTIA EXTENDIDA" Then
                    dt.Rows(rowID)("Column1") = ""
                    dt.Rows(rowID)("Column2") = ""
                    dt.Rows(rowID)("Column3") = 0
                Else
                    dt.Rows.Remove(dt.Rows(rowID))
                    ResetRowID(dt)
                    drCurrentRow = dt.NewRow()
                    drCurrentRow("RowNumber") = dt.Rows.Count + 1
                    'add new row to DataTable   
                    dt.Rows.Add(drCurrentRow)
                End If

            End If

            'Store the current data in ViewState for future reference  
            ViewState("CurrentTable") = dt

            'Re bind the GridView for the updated data  
            grvAccesorios.DataSource = dt
            grvAccesorios.DataBind()
        End If

        If acc = "GARANTIA EXTENDIDA" Then
            ddlGarantia.SelectedValue = 0
            txtmtogarantia.Text = ""
        End If

        'Set Previous Data on Postbacks  
        SetPreviousData()

        For Each row As GridViewRow In grvAccesorios.Rows
            Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
            Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)
            Dim ddl2 As DropDownList = TryCast(row.FindControl("DropDownList2"), DropDownList)
            Dim imgbtn As ImageButton = TryCast(row.FindControl("ImageButton1"), ImageButton)

            total = total + CDbl(IIf(txt.Text.Trim() = "", 0, txt.Text.Trim()))

            'BUG-PC-27 MAUT 23/12/2016 Se separan accesorios financiados y de contado
            If ddl2.SelectedValue = 160 Then
                AccFinan = AccFinan + CDbl(Val(txt.Text.Trim()))
            ElseIf ddl2.SelectedValue = 161 Then
                AccConta = AccConta + CDbl(Val(txt.Text.Trim()))
            End If
        Next

        lbltotalacc.Text = Val(total).ToString("###,##0.00")
        '02032017
        lblAccFinan.Text = Val(total)
        lblAccConta.Text = Val(AccConta)

        'CalculaEnganche(0)

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        If objPlazos.StrErrPlazo = "" Then

            prodid = ObtenProducto()

            If Not grvSeguro.Rows.Count > 0 Then
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
            Else
                Dim id_prod As Integer = ObtenProducto()
                Dim intbroker As Integer = obten_broker()
                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                    ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                    CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                    IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                    ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                    0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                    ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

            End If

            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If

            If chkPagosEsp.Checked = True Then
                btnAplicaPE_Click(btnAplicaPE, Nothing)
            End If

        Else
            MensajeError(objPlazos.StrErrPlazo)
            Exit Sub
        End If

        finseg.Visible = False
        grvSeguro.DataBind()

    End Sub

    Private Sub FillDropDownList(ddl As DropDownList, opc As Integer, Optional ByVal intaccesorio As Integer = 0)
        Dim dtsRes As New DataSet
        Dim dt As New DataTable()

        Select Case opc
            Case 1
                'cargamos los accesorios disponibles
                Dim objAcc As New clsAccesorios
                objAcc.IDMarca = IIf(intaccesorio = 1, 1, Val(ddlmarca.SelectedValue))
                objAcc.IDEstatus = IIf(intaccesorio = 1, 0, 2)
                If intaccesorio = 1 Then
                    objAcc.IDAccesorio = intaccesorio
                    dtsRes = objAcc.ManejaAccesorio(6)
                Else
                    dtsRes = objAcc.ManejaAccesorio(1)
                End If

                If objAcc.ErrorAccesorios = "" Then
                    If dtsRes.Tables(0).Rows.Count > 0 Then
                        objCombo.LlenaCombos(dtsRes, "DESCRIPCION", "ID_ACCESORIO", ddl, strErr, IIf(intaccesorio = 1, False, True))
                        If strErr <> "" Then
                            MensajeError(strErr)
                            Exit Sub
                        End If
                    Else
                        MensajeError("No se encontro información de Accesorios.")
                        Exit Sub
                    End If
                Else
                    MensajeError(objAcc.ErrorAccesorios)
                    Exit Sub
                End If

            Case 2
                'Cargamos la condiciones de los accesorios.
                Dim objParams As New clsParametros
                objParams.IDPadre = 159
                objParams.Valor = 2
                dtsRes = objParams.ManejaParametro(1)
                If objParams.ErrorParametros = "" Then
                    If dtsRes.Tables(0).Rows.Count > 0 Then
                        objCombo.LlenaCombos(dtsRes, "TEXTO", "ID_PARAMETRO", ddl, strErr, IIf(intaccesorio = 1, False, True))
                        If strErr <> "" Then
                            Exit Sub
                        End If
                    Else
                        strErr = "No se pudo recuperar información de Accesorios"
                        Exit Sub
                    End If
                Else
                    strErr = objParams.ErrorParametros
                    Exit Sub
                End If
        End Select
    End Sub

    Private Sub SetInitialRow()

        Dim dt As New DataTable()
        Dim dr As DataRow = Nothing

        dt.Columns.Add(New DataColumn("RowNumber", GetType(String)))
        dt.Columns.Add(New DataColumn("Column1", GetType(String)))
        'for DropDownList selected item
        dt.Columns.Add(New DataColumn("Column2", GetType(String)))
        'for DropDownList selected item   
        dt.Columns.Add(New DataColumn("Column3", GetType(String)))
        'for TextBox value   
        dr = dt.NewRow()
        dr("RowNumber") = 1
        dr("Column1") = String.Empty
        dt.Rows.Add(dr)

        'Store the DataTable in ViewState for future reference   
        ViewState("CurrentTable") = dt

        'Bind the Gridview   
        grvAccesorios.DataSource = dt
        grvAccesorios.DataBind()

        'After binding the gridview, we can then extract and fill the DropDownList with Data   
        Dim ddl1 As DropDownList = DirectCast(grvAccesorios.Rows(0).Cells(1).FindControl("DropDownList1"), DropDownList)
        Dim ddl2 As DropDownList = DirectCast(grvAccesorios.Rows(0).Cells(2).FindControl("DropDownList2"), DropDownList)
        FillDropDownList(ddl1, 1)
        FillDropDownList(ddl2, 2)
    End Sub

    Private Sub AddNewRowToGrid(Optional ByVal idaccesorio As Integer = 0)

        If ViewState("CurrentTable") IsNot Nothing Then

            Dim dtCurrentTable As DataTable = DirectCast(ViewState("CurrentTable"), DataTable)
            Dim drCurrentRow As DataRow = Nothing

            If dtCurrentTable.Rows.Count > 0 Then

                If idaccesorio = 1 Then
                    drCurrentRow = dtCurrentTable.NewRow()
                    drCurrentRow("RowNumber") = dtCurrentTable.Rows.Count + 1

                    'add new row to DataTable   
                    dtCurrentTable.Rows.Add(drCurrentRow)

                    'Store the current data to ViewState for future reference   
                    ViewState("CurrentTable") = dtCurrentTable
                End If



                For i As Integer = 0 To dtCurrentTable.Rows.Count - 1

                    'extract the TextBox values   
                    If idaccesorio <> 1 And dtCurrentTable.Rows(i).Item("Column1").ToString = "" Then
                        Dim box1 As TextBox = DirectCast(grvAccesorios.Rows(i).Cells(3).FindControl("TextBox1"), TextBox)
                        If box1.Text = "" Then
                            box1.Text = 0
                        End If
                        dtCurrentTable.Rows(i)("Column3") = box1.Text

                        'extract the DropDownList Selected Items   
                        Dim ddl1 As DropDownList = DirectCast(grvAccesorios.Rows(i).Cells(1).FindControl("DropDownList1"), DropDownList)
                        Dim ddl2 As DropDownList = DirectCast(grvAccesorios.Rows(i).Cells(2).FindControl("DropDownList2"), DropDownList)

                        ' Update the DataRow with the DDL Selected Items   

                        dtCurrentTable.Rows(i)("Column1") = ddl1.SelectedItem.Text
                        dtCurrentTable.Rows(i)("Column2") = ddl2.SelectedItem.Text
                    End If

                Next

                ViewState("CurrentTable") = dtCurrentTable

                'Rebind the Grid with the current data to reflect changes   
                grvAccesorios.DataSource = dtCurrentTable
                grvAccesorios.DataBind()
            End If
        Else

            Response.Write("ViewState Is null")
        End If
        'Set Previous Data on Postbacks   
        SetPreviousData(idaccesorio)
    End Sub

    Private Sub SetPreviousData(Optional ByVal idaccesorio As Integer = 0)


        If ViewState("CurrentTable") IsNot Nothing Then

            Dim dt As DataTable = DirectCast(ViewState("CurrentTable"), DataTable)

            For Each row As DataRow In dt.Rows

                Dim box1 As TextBox = DirectCast(grvAccesorios.Rows(dt.Rows.IndexOf(row)).Cells(3).FindControl("TextBox1"), TextBox)
                Dim ddl1 As DropDownList = DirectCast(grvAccesorios.Rows(dt.Rows.IndexOf(row)).Cells(1).FindControl("DropDownList1"), DropDownList)
                Dim ddl2 As DropDownList = DirectCast(grvAccesorios.Rows(dt.Rows.IndexOf(row)).Cells(2).FindControl("DropDownList2"), DropDownList)
                Dim imgbtn As ImageButton = DirectCast(grvAccesorios.Rows(dt.Rows.IndexOf(row)).Cells(4).FindControl("ImageButton1"), ImageButton)

                If idaccesorio = 1 And dt.Rows.IndexOf(row) = 0 Then

                    If dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString() = "GARANTIA EXTENDIDA" Or dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString() = "" Then
                        FillDropDownList(ddl1, 1, idaccesorio)
                        FillDropDownList(ddl2, 2, idaccesorio)
                        box1.Text = txtmtogarantia.Text.Trim

                        box1.Enabled = False
                        ddl1.Enabled = False
                        ddl2.Enabled = False
                    Else
                        FillDropDownList(ddl1, 1)
                        FillDropDownList(ddl2, 2)
                        ddl1.ClearSelection()
                        ddl1.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString()).Selected = True

                        ddl2.ClearSelection()
                        ddl2.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column2").ToString()).Selected = True

                        box1.Text = dt.Rows(dt.Rows.IndexOf(row))("Column3").ToString()
                        box1.Enabled = False
                        ddl1.Enabled = False
                        ddl2.Enabled = False
                        imgbtn.Visible = True
                    End If
                ElseIf idaccesorio = 1 And dt.Rows.IndexOf(row) > 0 Then
                    Dim index As Integer = dt.Rows.IndexOf(row) - 1
                    If index = 0 And dt.Rows(index)("Column1").ToString() = "GARANTIA EXTENDIDA" Then
                        FillDropDownList(ddl1, 1)
                        FillDropDownList(ddl2, 2)
                    Else
                        FillDropDownList(ddl1, 1, idaccesorio)
                        FillDropDownList(ddl2, 2, idaccesorio)
                        box1.Text = txtmtogarantia.Text.Trim

                        box1.Enabled = False
                        ddl1.Enabled = False
                        ddl2.Enabled = False
                        imgbtn.Visible = True
                    End If

                ElseIf idaccesorio <> 1 And dt.Rows.IndexOf(row) > 0 Then
                    FillDropDownList(ddl1, 1)
                    FillDropDownList(ddl2, 2)

                    If dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString() <> "" Then
                        ddl1.ClearSelection()
                        ddl1.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString()).Selected = True

                        ddl2.ClearSelection()
                        ddl2.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column2").ToString()).Selected = True

                        box1.Text = dt.Rows(dt.Rows.IndexOf(row))("Column3").ToString()
                        box1.Enabled = False
                        ddl1.Enabled = False
                        ddl2.Enabled = False
                        imgbtn.Visible = True
                    End If

                ElseIf dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString() = "GARANTIA EXTENDIDA" And dt.Rows.IndexOf(row) = 0 Then
                    FillDropDownList(ddl1, 1, 1)
                    FillDropDownList(ddl2, 2, 1)
                    box1.Text = txtmtogarantia.Text.Trim

                    box1.Enabled = False
                    ddl1.Enabled = False
                    ddl2.Enabled = False
                    imgbtn.Visible = True

                ElseIf dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString() <> "GARANTIA EXTENDIDA" And dt.Rows.IndexOf(row) = 0 Then
                    FillDropDownList(ddl1, 1)
                    FillDropDownList(ddl2, 2)

                    If Not dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString() = "" Then
                        ddl1.ClearSelection()
                        ddl1.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString()).Selected = True
                        ddl2.ClearSelection()
                        ddl2.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column2").ToString()).Selected = True
                        box1.Text = dt.Rows(dt.Rows.IndexOf(row))("Column3").ToString()
                        box1.Enabled = False
                        ddl1.Enabled = False
                        ddl2.Enabled = False
                        imgbtn.Visible = True
                    End If

                Else
                    FillDropDownList(ddl1, 1)
                    FillDropDownList(ddl2, 2)
                    ddl1.ClearSelection()
                    ddl1.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column1").ToString()).Selected = True

                    ddl2.ClearSelection()
                    ddl2.Items.FindByText(dt.Rows(dt.Rows.IndexOf(row))("Column2").ToString()).Selected = True

                    box1.Text = dt.Rows(dt.Rows.IndexOf(row))("Column3").ToString()
                    box1.Enabled = False
                    ddl1.Enabled = False
                    ddl2.Enabled = False
                    imgbtn.Visible = True
                End If

                If Val(ddl1.SelectedValue) <> 0 Then
                    dt.Rows(dt.Rows.IndexOf(row))("Column1") = ddl1.SelectedItem.Text
                    dt.Rows(dt.Rows.IndexOf(row))("Column2") = ddl2.SelectedItem.Text
                    dt.Rows(dt.Rows.IndexOf(row))("Column3") = Val(box1.Text)
                End If
            Next

            ViewState("CurrentTable") = dt
        End If
    End Sub

    'RQ06
    'Protected Sub cmdAgregaAcc_Click(sender As Object, e As System.Web.UI.ImageClickEventArgs) Handles cmdAgregaAcc.Click
    '    Dim count As Integer = 0

    '    For Each row As GridViewRow In grvAccesorios.Rows
    '        Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
    '        Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)
    '        Dim ddl2 As DropDownList = TryCast(row.FindControl("DropDownList2"), DropDownList)

    '        If ddl1.SelectedValue = 0 Or ddl2.SelectedValue = 0 Then
    '            MensajeError("Debe seleccionar Accesorio y Condición.")
    '            Exit Sub
    '        Else
    '            If txt.Text.Trim.Length = 0 Then
    '                count = count + 1
    '            Else
    '                total = total + CDbl(txt.Text.Trim())
    '            End If
    '        End If
    '    Next

    '    If count > 0 Then
    '        MensajeError("El precio no puede ser $0.00")
    '        Exit Sub
    '    Else
    '        AddNewRowToGrid()
    '    End If

    '    lbltotalacc.Text = Val(total).ToString("###,###.00")
    '    'CalculaEnganche(0)

    '    objPlazos.CargaPlazo(ddlplazos.SelectedValue)
    '    If objPlazos.StrErrPlazo = "" Then

    '        LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
    '            ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
    '            CDbl(lbltotalacc.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue)
    '    Else
    '        MensajeError(objPlazos.StrErrPlazo)
    '        Exit Sub
    '    End If

    'End Sub

    Sub LlenaComboPagEsp()
        Try
            Dim sngRow As Single = 1
            Dim strTexto As String = ""
            Dim strVal As String = ""

            'llenamos el grid de periodos
            Dim dtsPagEsp As New DataSet
            Dim objTabla As New DataTable
            Dim objCol As DataColumn
            Dim objRow As DataRow

            objTabla.TableName = "PagosEsp"
            objCol = New DataColumn
            objCol.DataType = GetType(String)
            objCol.ColumnName = "periodos"
            objTabla.Columns.Add(objCol)

            objCol = New DataColumn
            objCol.DataType = GetType(String)
            objCol.ColumnName = "claves"
            objTabla.Columns.Add(objCol)

            dtsPagEsp.Tables.Add(objTabla)

            For sngRow = 12 To 12
                Select Case sngRow
                    'Case 1
                    '    strTexto = "ENERO"
                    'Case 2
                    '    strTexto = "FEBRERO"
                    'Case 3
                    '    strTexto = "MARZO"
                    'Case 4
                    '    strTexto = "ABRIL"
                    'Case 5
                    '    strTexto = "MAYO"
                    'Case 6
                    '    strTexto = "JUNIO"
                    'Case 7
                    '    strTexto = "JULIO"
                    'Case 8
                    '    strTexto = "AGOSTO"
                    'Case 9
                    '    strTexto = "SEPTIEMBRE"
                    'Case 10
                    '    strTexto = "OCTUBRE"
                    'Case 11
                    '    strTexto = "NOVIEMBRE"
                    Case 12
                        strTexto = "DICIEMBRE"
                End Select

                If sngRow < 10 Then strVal = "0" & sngRow Else strVal = sngRow

                objRow = dtsPagEsp.Tables(0).NewRow
                objRow.Item("periodos") = strTexto
                objRow.Item("claves") = strVal
                dtsPagEsp.Tables(0).Rows.Add(objRow)

            Next

            cmbPeriodos.DataSource = dtsPagEsp.Tables(0)
            cmbPeriodos.DataTextField = "periodos"
            cmbPeriodos.DataValueField = "claves"
            cmbPeriodos.DataBind()


            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String

            objPlazos.CargaPlazo(ddlplazos.SelectedValue)

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If


        Catch ex As Exception
            MensajeError(ex.Message)
        End Try
    End Sub

    Private Sub LlenaPagEsp(ByVal sngPlazo As Single)
        'obtenemos las fechas de pago

        Dim dtsFec As DataSet

        objPlazos.CargaPlazo(sngPlazo)
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        Dim objMon As New SNProcotiza.clsMonedas(ddlmonedafin.SelectedValue)

        objCot.ValorPlazo = objPlazos.Valor
        objCot.IDPeriodicidad = objPaq.IDPeriodicidad
        objCot.IDTipoVencimiento = objPaq.IDTipoVencimiento
        objCot.IDMoneda = objPaq.IDMoneda
        objCot.IDMonedaFactura = ddlmonedafact.SelectedValue
        objCot.ValorTipoCambio = objMon.ValorCambio
        objCot.DiaPago = Microsoft.VisualBasic.DateAndTime.Day(Now)

        dtsFec = objCot.ObtenFechasPagos

        If Trim(objCot.ErrorCotizacion) = "" Then
            If dtsFec.Tables.Count > 0 Then
                If dtsFec.Tables(0).Rows.Count > 0 Then
                    Session("dtsfecpagos") = dtsFec
                    gdvPagEsp.DataSource = dtsFec
                    gdvPagEsp.DataBind()
                Else
                    MensajeError("No se pudieron generar las fechas de pago.")
                End If
            Else
                MensajeError("No se pudieron generar las fechas de pago.")
            End If
        Else
            MensajeError(objCot.ErrorCotizacion)
        End If
    End Sub

    Private Function GuardaAccesorios(idcot As Integer) As Boolean
        Try
            GuardaAccesorios = False

            Dim dtsRes As New DataSet
            Dim objRow As GridViewRow
            Dim objTxt As Object
            Dim dblTotAcc As Double = 0
            Dim objddl1 As New DropDownList
            Dim objddl2 As New DropDownList

            'For Each objRow In grvAccesorios.Rows
            '    objTxt = objRow.Cells(3).Controls(1)
            '    If Trim$(objTxt.Text) <> "" Then
            '        dblTotAcc = dblTotAcc + Val(objTxt.Text)
            '    End If
            'Next

            'objPaq.CargaPaquete(ddlplan.SelectedValue)
            'objCot.CargaCotizacion(idcot)
            'If dblTotAcc > CDbl(objCot.PrecioProducto) * (objPaq.PtjMaximoAccesorios / 100) Then
            '    strErr = "El precio de los accesorio es mayor al porcentaje establecido."
            '    Exit Function
            'End If

            For Each objRow In grvAccesorios.Rows
                objTxt = objRow.Cells(3).Controls(1)
                objddl1 = objRow.Cells(1).Controls(1)
                objddl2 = objRow.Cells(2).Controls(1)

                If Trim$(objTxt.Text) <> "" Then
                    objCot.IDCotizacion = idcot
                    objCot.IDAccesorio = objddl1.SelectedValue
                    objCot.DescripcionAccesorio = objddl1.SelectedItem.Text
                    objCot.PrecioAccesorio = CDbl(Trim$(objTxt.Text))
                    objCot.CondicionAcc = objddl2.SelectedValue
                    'objCot.MontoAccesoriosNoCalculoSeguro = objddl2.SelectedValue
                    'objCot.AccesorioAfectaCalculoSeguro = objddl2.SelectedValue

                    objCot.ManejaCotizacion(29)

                End If
            Next

            GuardaAccesorios = True
        Catch ex As Exception
            strErr = ex.Message
            GuardaAccesorios = False
        End Try
    End Function

    Private Function GuardaPagosEsp(idcot As Integer) As Boolean
        Try
            GuardaPagosEsp = False


            Dim dtsRes As New DataSet
            Dim objRow As GridViewRow
            Dim objTxt As Object
            Dim objCot As New SNProcotiza.clsCotizaciones()
            Dim dblTotPagEsp As Double = 0

            'For Each objRow In gdvPagEsp.Rows
            '    If objRow.Cells(2).Controls.Count > 0 Then
            '        objTxt = objRow.Cells(2).Controls(1)
            '        If Trim$(objTxt.Text) <> "" Then
            '            dblTotPagEsp = dblTotPagEsp + Val(objTxt.Text)
            '        End If
            '    End If
            'Next


            ''se valida que le monto de los pagos especiales no sea mayor al monto a financiar
            'If dblTotPagEsp > (((Val(Trim(Replace(Replace(objCot.PrecioProducto, ",", ""), "$", ""))) * Val(objCot.UnidadesProducto)) + Val(Trim(Replace(Replace(objCot.MontoAccesorios, ",", ""), "$", "")))) - Val(objCot.MontoEnganche)) Then
            '    strErr = "El monto total de pagos especiales no puede ser mayor al valor factura menos el enganche"
            '    GuardaPagosEsp = False
            '    Exit Function
            'End If

            'primero se eliminan los pagos especiales existentes
            objCot.CargaCotizacion(idcot)
            dtsRes = objCot.ManejaCotizacion(5)
            If Trim$(objCot.ErrorCotizacion) <> "" Then
                MensajeError(objCot.ErrorCotizacion)
            End If

            'se guardan los pagos especiales uno por uno
            For Each objRow In gdvPagEsp.Rows
                If objRow.Cells(2).Controls.Count > 0 Then
                    objTxt = objRow.Cells(2).Controls(1)
                    If Trim$(objTxt.Text) <> "" Then
                        objCot.PeriodoPagoEspecial = Val(objRow.Cells(0).Text)
                        objCot.FechaPagoEspecial = objRow.Cells(1).Text
                        objCot.MontoPagoEspecial = Val(objTxt.Text)
                        dtsRes = objCot.ManejaCotizacion(6)
                        If Trim$(objCot.ErrorCotizacion) <> "" Then
                            MensajeError(objCot.ErrorCotizacion)
                            Exit Function
                        End If
                    End If
                End If
            Next

            GuardaPagosEsp = True
        Catch ex As Exception
            MensajeError(ex.Message)
            GuardaPagosEsp = False
        End Try

        Return GuardaPagosEsp
    End Function

    Private Function GuardaCotiza() As Boolean
        Try
            GuardaCotiza = False
            Dim dts As New DataSet

            objCot.IDTipoCotizacion = 105
            objCot.IDEmpresa = 1
            objCot.IDAgencia = ddlagencia.SelectedValue

            If ddlejecutivo.SelectedValue = "" Then
                strErr = "La Agencia seleccionada no tiene F&I asignado."
                Exit Function
            Else
                objCot.IDPromotor = ddlejecutivo.SelectedValue
            End If
            If ddlvendedor.SelectedValue = "" Then
                strErr = "La Agencia seleccionada no tiene Vendedor asignado."
                Exit Function
            Else
                Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
                'If objUsuFirma.IDPerfil = 71 Then
                'objCot.IDVendedor = objUsuFirma.IDUsuario
                'Else
                objCot.IDVendedor = ddlvendedor.SelectedValue
                'End If

            End If
            'BBVA-P-412
            If objPaq.CEROCOMISION = 0 Then
                If txttasa.Text = 0 Then
                    strErr = "Debe proporcionar la tasa de interes"
                    Exit Function
                End If
            End If

            If objPaq.PermitePtjSubsidio = 1 OrElse objPaq.PermiteMontoSubsidio = 1 Then
                '02032017
                If Val(txtmtosub.Text) = 0 And Val(txtporsub.Text) = 0 Then
                    strErr = "Subsidio incorrecto"
                    Exit Function
                End If
            End If

            'BBVA-P-412
            objCot.IDAsesor = 0
            objCot.IDPersonalidadJuridica = ddlpj.SelectedValue
            'objCot.Nombre = txtnombrecte.Text.Trim
            'objCot.Paterno = txtpaterno.Text.Trim
            'objCot.Materno = txtmaterno.Text.Trim
            'objCot.Mail = txtmail.Text.Trim
            'objCot.Telefonos = txttelfijo.Text.Trim
            'objCot.TelefonoMovil = txttelmovil.Text.Trim
            'objCot.Contacto = ""
            'objCot.Ingresos = 0
            'objCot.IDPersonaCliente = 0
            objCot.IDGiro = ddlgiro.SelectedValue
            Dim prod As DataSet = ObtenDatProducto()

            objCot.IDTipoProducto = prod.Tables(0).Rows(0).Item("ID_TIPO_PRODUCTO").ToString ''Automoviles
            objCot.IDMarca = ddlmarca.SelectedValue
            objCot.IDClasificacionProd = ddlclasif.SelectedValue

            prodid = ObtenProducto()
            objCot.IDProducto = prodid

            objProd.CargaProducto(prodid)
            objCot.AñoModeloUsado = objProd.AñoModelo ''ddlanio.SelectedValue

            objCot.PrecioLista = 0
            objCot.PrecioProducto = CDbl(txtprecio.Text.Trim())
            objCot.MontoAccesorios = CDbl(lbltotalacc.Text.Trim())
            objCot.MontoAccesoriosContado = 0
            objCot.MontoAccesoriosNoCalculoSeguro = 0
            objCot.UnidadesProducto = txtUniProd.Text.Trim
            objCot.IDMonedaFactura = ddlmonedafact.SelectedValue
            objCot.IDPaquete = ddlplan.SelectedValue
            objCot.IDTipoOperacion = ddltoperacion.SelectedValue
            objCot.IDMoneda = ddlmonedafin.SelectedValue
            objCot.ValorTipoCambio = 1
            objCot.ConsideraEngancheAccesorios = 0
            objCot.PtjEnganche = CDbl(txtporeng.Text.Trim())
            objCot.PtjEngancheReal = CDbl(txtporeng.Text.Trim())
            objCot.MontoEnganche = CDbl(txtenganche.Text.Trim())
            objPaq.IDPaquete = ddlplan.SelectedValue
            objPaq.IDPlazo = ddlplazos.SelectedValue

            dts = objPaq.ManejaPaquete(39)
            If objPaq.ErrorPaquete = "" Then
                If dts.Tables(0).Rows.Count > 0 Then
                    objCot.CalculaPagoInicial = 0 ''Es un CheckBox
                    objCot.PagosGraciaCapital = 0 ''Es un TextBox
                    objCot.PagosGraciaInteres = 0 ''Es un TextBox
                    objCot.RentasDeposito = 0 ''Es un TextBox
                    objCot.PtjServiciosFinancieros = dts.Tables(0).Rows(0).Item("PTJ_SERV_FINAN")
                    objCot.MontoServiciosFinancieros = (CDbl(dts.Tables(0).Rows(0).Item("PTJ_SERV_FINAN")) / 100) * (CDbl(txtprecio.Text.ToString() - CDbl(txtenganche.Text.Trim) + CDbl(lbltotalacc.Text.Trim))) ''monto de los accesorios + el monto de los seguros
                    objCot.PtjOpcionCompra = dts.Tables(0).Rows(0).Item("PTJ_OPCION_COMPRA")
                    objCot.MontoOpcionCompra = (CDbl(dts.Tables(0).Rows(0).Item("PTJ_OPCION_COMPRA")) / 100) * CDbl(txtprecio.Text.ToString())
                    objCot.UsaTasaPCP = 0 ''Es un CheckBox
                    objCot.TasaPCP = dts.Tables(0).Rows(0).Item("TASA_PCP")
                    objCot.PtjBlindDiscount = dts.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")
                    objCot.MontoValorResidual = (CDbl(dts.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.ToString())
                    objCot.TasaInteresSeguro = dts.Tables(0).Rows(0).Item("TASA_NOMINAL_SEGURO")
                    objCot.ManejaTasaInteresVariable = dts.Tables(0).Rows(0).Item("MANEJA_TASA_INTERES_VARIABLE")
                    objCot.IDCalendario = dts.Tables(0).Rows(0).Item("ID_CALENDARIO")
                    objCot.IDPeriodicidad = dts.Tables(0).Rows(0).Item("ID_PERIODICIDAD")
                    objCot.IDTipoVencimiento = dts.Tables(0).Rows(0).Item("ID_TIPO_VENCIMIENTO")
                    objCot.PrimerPagoIrregular = dts.Tables(0).Rows(0).Item("PRIMER_PAGO_IRREG")
                    objCot.IDTipoCalculoSeguro = dts.Tables(0).Rows(0).Item("ID_TIPO_CALCULO_SEGURO")
                    objCot.CapturaManualSeguro = dts.Tables(0).Rows(0).Item("PERMITE_CAPTURA_SEGURO_MANUAL")
                    objCot.PtjSubsidio = CDbl(IIf(txtporsub.Text.Trim = "", 0, txtporsub.Text.Trim)) '0 ''Es un TextBox
                    objCot.MontoSubsidio = CDbl(IIf(txtmtosub.Text.Trim = "", 0, txtmtosub.Text.Trim)) '0 ''Es un TextBox
                    objCot.FactorSeguroVida = dts.Tables(0).Rows(0).Item("FACTOR_SEGURO_VIDA")
                    objCot.IncentivoVentas = dts.Tables(0).Rows(0).Item("INCENTIVO_VENTAS")
                    objCot.CalcularIVASeguroVida = dts.Tables(0).Rows(0).Item("CALCULAR_IVA_SEGURO_VIDA")
                    objCot.IDTipoCalculoSeguroVida = dts.Tables(0).Rows(0).Item("ID_TIPO_SEGURO_VIDA")
                    objCot.IDEsquemaFinanciamiento = dts.Tables(0).Rows(0).Item("ID_TIPO_CALCULO")

                Else
                    Exit Function
                End If
            Else
                strErr = objPaq.ErrorPaquete
                Exit Function
            End If

            objCot.IDTasaIVA = ddliva.SelectedValue

            objIva.CargaTasaIVA(ddliva.SelectedValue)
            If objIva.ErrorTasasIVA = "" Then
                objCot.TasaIVA = objIva.ValorTasa
            Else
                strErr = objIva.ErrorTasasIVA
                Exit Function
            End If

            objCot.TasaInteres = txttasa.Text.Trim
            objCot.TasaInteresVariable = CDbl(txttasa.Text.Trim)

            objCot.IDPlazo = ddlplazos.SelectedValue
            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            If objPlazos.StrErrPlazo = "" Then
                objCot.ValorPlazo = objPlazos.Valor
            Else
                strErr = objPlazos.StrErrPlazo
                Exit Function
            End If

            objCot.IDTipoSeguro = ddltiposeg.SelectedValue
            objCot.IDAplicacionSeguroVida = ddlsegvida.SelectedValue
            objCot.IDAseguradora = ddlaseguradora.SelectedValue
            objCot.IDEstado = ddledo.SelectedValue
            objCot.IDPaqueteSeguro = 0
            objCot.MontoSeguro = 0
            objCot.MontoSeguroRegalado = 0
            objCot.IDPlazoSeguro = ddlplazos.SelectedValue
            objCot.ValorPlazoSeguro = objPlazos.Valor
            objCot.PuntosSobreTasa = 0 ''Es un TextBox
            objCot.PeriodoPagoEspecial = 0

            objCot._DecDeducible = cmbDedusibleDaños.SelectedValue
            objCot._Indemnizacion = cmbIndemnizacion.SelectedValue
            objCot._DecDeducibleRoboTotal = cmbDeducibleRoboTotal.SelectedValue
            'End If
            ''pago periodo seg
            ''pago periodo seg vida
            ''tasa subsidio
            objCot.ValorAdaptacion = 0 ''Es un TextBox
            objCot.IncluyeRC = 0 ''Es un checkbox
            objCot.UIDEmpresa = 10865
            objCot.UIDAseguradora = 0
            objCot.UIDProducto = 0
            objCot.UIDEstado = ddledoseg.SelectedValue
            objCot.UIDPaqueteSeguro = 0
            objCot.UIDMoneda = ddlmonedafin.SelectedValue
            objCot.UIDTipoPago = 0
            objCot.UIDPlazo = 0
            objCot.UIDFamilia = 0
            objCot.UIDTipoProducto = 0
            objCot.MontoSeguro1 = 0
            objCot.MontoSeguro2 = 0
            objCot.MontoSeguro3 = 0
            objCot.IDFamilia = 0
            objCot.IDOrigen = 0
            objCot.IDcotizador = 2
            objCot.MontoValorResidual = txtresidual.Text
            If ddlengancheCI.Visible = True And ddlengancheCI.Enabled = True Then
                objCot.Enganche_CI = IIf(ddlengancheCI.SelectedItem.Text = "", Nothing, CDbl(ddlengancheCI.SelectedItem.Text))
            End If


            objCot.ManejaCotizacion(2)

            If objCot.ErrorCotizacion <> "" Then
                strErr = objCot.ErrorCotizacion
                Exit Function
            End If

            IDCotizacion = objCot.IDCotizacion
            Session("IDCot") = IDCotizacion
            strErr = "Se genero la cotización " & IDCotizacion.ToString() & "."
            GuardaCotiza = True
            Me.btnImprimeCot.Visible = True
        Catch ex As Exception
            strErr = ex.Message
            GuardaCotiza = False
            Exit Function
        End Try
    End Function

    Private Sub CalculaEnganche(ByVal intOpc As Integer)
        Try
            Dim objTO As New SNProcotiza.clsTiposOperacion(Val(ddltoperacion.SelectedValue))
            Dim objPaq As New SNProcotiza.clsPaquetes(Val(ddlplan.SelectedValue))
            Dim objIVA As New SNProcotiza.clsTasasIVA(Val(ddliva.SelectedValue))
            Dim dblPrecioProd As Double = 0
            Dim dblPaso As Double = 0
            Dim dblBlind As Double = 0
            Dim count As Integer = 0
            Dim poreng As Decimal = 0
            Dim porres As Decimal = 0
            Dim dtsRes As New DataSet

            If objPaq.ConsideraEngancheAccesorios = 1 Then
                dblPrecioProd = ((Val(Trim(Replace(Replace(txtprecio.Text, ",", ""), "$", ""))) * Val(txtUniProd.Text)) + Val(Trim(Replace(Replace(lbltotalacc.Text, ",", ""), "$", ""))))
            Else
                dblPrecioProd = Val(Trim(Replace(Replace(txtprecio.Text, ",", ""), "$", ""))) * Val(txtUniProd.Text)
            End If

            objPaq.IDAgencia = ddlagencia.SelectedValue
            objPaq.IDVersion = ddlversion.SelectedValue
            objPaq.IDPlazo = ddlplazos.SelectedValue
            dtsRes = objPaq.ManejaPaquete(50)
            If objPaq.ErrorPaquete = "" Then
                If dtsRes.Tables(0).Rows.Count Then
                    If objPaq.IDTipoCalculo <> 167 Then
                        count = 1
                        poreng = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                        porres = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")
                    End If
                End If
            Else
                MensajeError(objPaq.ErrorPaquete)
                Exit Sub
            End If

            'CONSIDERAMOS EL BLIND DISCOUNT
            Dim dtsPlazo As New DataSet
            objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
            objPaq.IDPaquete = Val(ddlplan.SelectedValue)
            objPaq.IDEstatusPlazo = 2
            dtsPlazo = objPaq.ManejaPaquete(7)


            dblBlind = IIf(count > 0, porres, dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT"))
            If dblBlind > 0 And objPaq.IDTipoCalculo <> 167 Then
                dblPrecioProd = dblPrecioProd * (1 - (dblBlind / 100))
            End If

            'SI EL CAPITAL NO INCLUYE IVA ESTE SE LE QUITA AL MONTO A FINANCIAR
            If objTO.CapitalFinaciarIncluyeIVA = 0 Then
                dblPrecioProd = dblPrecioProd / (1 + (objIVA.ValorTasa / 100))
            End If


            Select Case intOpc
                Case 0 'Se modifico el monto del producto

                    txtenganche.Text = ((CDbl(IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))) / 100.0) * CDbl(Trim(Replace(Replace(dblPrecioProd, ",", ""), "$", ""))))
                    txtporeng.Text = IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))
                    lblengmin.Text = IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))

                Case 1 'Se modifico el monto

                    dblPaso = Val(txtenganche.Text)
                    dblPaso = dblPaso * 100 / dblPrecioProd
                    Dim EngMax As Double = CDbl(txtprecio.Text) * (99.99 / 100)

                    If CDbl(txtenganche.Text.Trim) < ((CDbl(IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))) / 100.0) * dblPrecioProd) Then
                        MensajeError("El monto ingresado no puede ser menor al establecido en la configuración del Paquete.")
                        txtenganche.Text = ((CDbl(IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))) / 100.0) * CDbl(Trim(Replace(Replace(dblPrecioProd, ",", ""), "$", ""))))
                        txtporeng.Text = IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))
                    Else
                        If CDbl(txtenganche.Text) < EngMax Then
                            txtporeng.Text = System.Math.Round(dblPaso, 2)
                        Else
                            MensajeError("El monto de enganche no puede ser superior al 99.9% del precio del auto.")
                            txtenganche.Text = ((CDbl(IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))) / 100.0) * CDbl(Trim(Replace(Replace(dblPrecioProd, ",", ""), "$", ""))))
                            txtporeng.Text = IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))
                        End If
                    End If
                Case 2 'Se modifico el %

                    If (CDbl(txtporeng.Text.Trim) < IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE")) Or CDbl(txtporeng.Text.Trim) > 100) And objPaq.IDTipoCalculo <> 167 Then
                        If CDbl(txtporeng.Text.Trim) > 100 Then
                        Else
                            MensajeError("El porcentaje ingresado no puede ser menor al establecido en la configuración del Paquete.")
                        End If


                        txtenganche.Text = ((CDbl(IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))) / 100.0) * CDbl(Trim(Replace(Replace(dblPrecioProd, ",", ""), "$", ""))))
                        txtporeng.Text = IIf(count > 0, poreng, dtsPlazo.Tables(0).Rows(0).Item("PTJ_ENGANCHE"))
                    End If

                    If ddltoperacion.SelectedValue = 1 Then
                        dblPaso = Val(txtporeng.Text)
                        txtenganche.Text = System.Math.Round(dblPrecioProd * (dblPaso / 100), 2).ToString("###,###.00")
                    Else
                        dblPaso = IIf(count > 0, porres, dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) 'Val(txtEngPtj.Text)
                        dblPaso = dblPrecioProd * (dblPaso / 100)
                        dblPrecioProd = txtprecio.Text
                        ''txtValResid.Text = System.Math.Round(dblPrecioProd * (dblBlind / 100), 2).ToString("###,###.00")
                        ''txtporvalores.Text = dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")
                        ''txtDepGar.Text = dtsPlazo.Tables(0).Rows(0).Item("RNTSANTCPDS")
                    End If
            End Select

            If objPaq.IDTipoCalculo <> 167 Then
                txtporresidual.Text = IIf(count > 0, porres, dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT"))
                txtresidual.Text = Val((CDbl(IIf(count > 0, porres, dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT"))) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,###.00")
            Else
                If intOpc = 0 Then

                    poreng = 0
                    porres = 0
                    count = 0

                    objPaq.IDPaquete = ddlplan.SelectedValue
                    objPaq.IDVersion = ddlversion.SelectedValue
                    objPaq.IDPlazo = ddlplazos.SelectedValue
                    dtsRes = objPaq.ManejaPaquete(50)

                    If objPaq.ErrorPaquete = "" Then
                        If dtsRes.Tables.Count > 0 Then
                            If dtsRes.Tables(0).Rows.Count > 0 Then
                                count = 1
                                poreng = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                                porres = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")
                            End If
                        End If
                    Else
                        Exit Sub
                    End If

                    objPlazos.IDPaquete = ddlplan.SelectedValue
                    objPlazos.Id_Plazo = ddlplazos.SelectedValue
                    dtsRes = objPlazos.ManejaPlazos(6)
                    If objPlazos.StrErrPlazo = "" Then
                        If dtsRes.Tables(0).Rows.Count > 0 Then

                            txtporeng.Text = IIf(count > 0, poreng, dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN"))
                            txttasa.Text = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL")
                            lblengmin.Text = IIf(count > 0, poreng, dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN"))

                            txtporresidual.Text = IIf(count > 0, porres, dtsRes.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT"))
                            txtresidual.Text = Val((CDbl(IIf(count > 0, CDbl(porres), dtsRes.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT"))) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")

                            txtenganche.Text = Val((CDbl(txtporeng.Text.Trim) / 100) * txtprecio.Text).ToString("###,###.00") ''* txtUniProd.Text

                        Else
                            strErr = "No se encontro información Enganche."
                            Exit Sub
                        End If
                    Else
                        strErr = objPlazos.StrErrPlazo
                        Exit Sub
                    End If
                End If
            End If

            txtprecio.Text = CDbl(txtprecio.Text).ToString("###,###.00")
            txtenganche.Text = CDbl(txtenganche.Text).ToString("###,###.00")
            txtporeng.Text = CDbl(txtporeng.Text).ToString("###,###.00")
            lblengmin.Text = CDbl(lblengmin.Text).ToString("###,###.00")
        Catch ex As Exception
        End Try
    End Sub

    Private Sub CargaCotizacionPDF(IDCot As Integer)

        Dim objCot As New SNProcotiza.clsCotizaciones
        Dim dtsRep As New DataSet
        Dim dtsTA_6 As New DataSet
        Dim dtsFiltros As New DataSet
        Dim dtsCargIni As New DataSet
        Dim dtsLeyendas As New DataSet
        Dim rpvCotiza As New Microsoft.Reporting.WebForms.ReportViewer

        Try
            objCot.CargaCotizacion(IDCot)
            Dim TipOperRG As Integer = objCot.IDTipoOperacion
            ''Dim NoAgenRG As Integer = Val(Request("NoAgen"))

            dtsRep = objCot.ConsultaTablaAmort
            dtsTA_6 = objCot.ConsultaTablaAmort_6
            If Trim$(objCot.ErrorCotizacion) = "" Then

                dtsCargIni = objCot.ObtenCargosIniciales(TipOperRG) 'los cargos iniciales van antes que los filtros
                dtsFiltros = objCot.ObtenFiltros
                dtsLeyendas = objCot.ObtenLeyendasReporte

                Dim objParams(5) As Microsoft.Reporting.WebForms.ReportParameter
                'Parametros
                Dim strCadRep As String = System.Configuration.ConfigurationManager.AppSettings.Item("Reportes")
                Dim strEncabezado As String = System.Configuration.ConfigurationManager.AppSettings.Item("RepEncabezado")
                Dim strImagenProd As String = System.Configuration.ConfigurationManager.AppSettings.Item("ImgProductos")
                Dim strImagenLogo As String = System.Configuration.ConfigurationManager.AppSettings.Item("RepImgLogo")
                Dim strPasoLogo = System.Configuration.ConfigurationManager.AppSettings.Item("imagenLogoReporte")
                Dim strPasoImgProd = System.Configuration.ConfigurationManager.AppSettings.Item("imagenProdReporte")

                Dim objProd As New SNProcotiza.clsProductos(objCot.IDProducto)
                Dim objEmp As New SNProcotiza.clsEmpresas()

                'se maneja que el logo dependa de la url por donde se acceso y no por la empresa del usuario
                objEmp.URLAcceso = Trim(Session("urlAcceso"))
                objEmp.CargaEmpresa(1)

                If objCot.IDTipoOperacion = 1 Then
                    strCadRep += System.Configuration.ConfigurationManager.AppSettings.Item("RepCotizacion")

                    strImagenProd += IIf(objProd.ImagenProducto <> "", objProd.ImagenProducto, strPasoImgProd)
                    strImagenLogo += IIf(objEmp.ImagenLogoReporte <> "", objEmp.ImagenLogoReporte, strPasoLogo)

                    'CALCULAMOS EL CAT Y LO PASAMOS COMO PARAMETRO
                    Dim dblCAT As Double = 0
                    Dim dblCAT_DOS As Double = 0
                    dtsCargIni = objCot.ObtenCargosIniciales(TipOperRG)
                    dblCAT = objCot.CalculaCat(dtsRep, dtsCargIni, dtsFiltros)
                    dblCAT_DOS = objCot.CalculaCat_Dos(dtsTA_6, dtsCargIni, dtsFiltros)

                    'pasamos la ruta de la imagen como parámetro
                    Dim paramImagen = New Microsoft.Reporting.WebForms.ReportParameter("imagenProducto", strImagenProd)

                    'Vacios
                    Dim paramPaquete = New Microsoft.Reporting.WebForms.ReportParameter("leyenda1", dtsFiltros.Tables(0).Rows(0).Item("ASEGURADORA").ToString)
                    Dim paramModelo = New Microsoft.Reporting.WebForms.ReportParameter("leyenda2", dtsFiltros.Tables(0).Rows(0).Item("ESTADO_SEG").ToString)

                    Dim paramCAT = New Microsoft.Reporting.WebForms.ReportParameter("leyenda_CAT", dblCAT.ToString)
                    Dim paramImagenLogo = New Microsoft.Reporting.WebForms.ReportParameter("imagen_logo", strImagenLogo)
                    Dim paramEncabezado = New Microsoft.Reporting.WebForms.ReportParameter("leyenda_encabezado", strEncabezado)

                    objParams(0) = paramImagen
                    objParams(1) = paramPaquete
                    objParams(2) = paramModelo
                    objParams(3) = paramCAT
                    objParams(4) = paramImagenLogo
                    objParams(5) = paramEncabezado

                    'generamos el reporte
                    If dtsRep.Tables.Count > 0 Then
                        If dtsRep.Tables(0).Rows.Count > 0 Then
                            rpvCotiza.ProcessingMode = ProcessingMode.Local
                            rpvCotiza.LocalReport.ReportPath = strCadRep
                            rpvCotiza.LocalReport.EnableExternalImages = True
                            rpvCotiza.LocalReport.SetParameters(objParams)

                            rpvCotiza.LocalReport.DataSources.Clear()
                            Dim objDS As New ReportDataSource("ProcotizaCalculo_spCalculaPagosNC", dtsRep.Tables(0))
                            rpvCotiza.LocalReport.DataSources.Add(objDS)
                            Dim objDSFilt As New ReportDataSource("ProcotizaWebDataSet_spObtenFiltrosCot", dtsFiltros.Tables(0))
                            rpvCotiza.LocalReport.DataSources.Add(objDSFilt)
                            Dim objDSCI As New ReportDataSource("ProcotizaCargosIniciales_spCargosIniciales", dtsCargIni.Tables(0))
                            rpvCotiza.LocalReport.DataSources.Add(objDSCI)
                            Dim objLeyRep As New ReportDataSource("ProcotizaLeyendas_spManejaLeyendasReporte", dtsLeyendas.Tables(0))
                            rpvCotiza.LocalReport.DataSources.Add(objLeyRep)


                            Dim warnings() As Warning = Nothing
                            Dim streams() As String = Nothing
                            Dim renderedBytes() As Byte
                            Dim reportType As String = "PDF"
                            Dim mimeType As String = ""
                            Dim encoding As String = ""
                            Dim fileNameExtension As String = ""
                            'Dim strFile As String = "cot" & Request("idCot") & ".pdf"
                            Dim strFile As String = "cot" & IDCot.ToString() & ".pdf"

                            'The DeviceInfo settings should be changed based on the reportType
                            Dim deviceInfo As String = "<DeviceInfo>" & _
                                                       "  <OutputFormat>PDF</OutputFormat>" & _
                                                       "</DeviceInfo>"

                            renderedBytes = rpvCotiza.LocalReport.Render(reportType, deviceInfo, mimeType, encoding, _
                                                                         fileNameExtension, streams, warnings)

                            fileNameExtension = Server.MapPath(strFile)
                            fileNameExtension = Replace(fileNameExtension, "\aspx\", "\Docs\")
                            My.Computer.FileSystem.WriteAllBytes(fileNameExtension, renderedBytes, False)

                            Try
                                Response.Clear()
                                Response.ClearContent()
                                Response.ClearHeaders()
                                Response.AddHeader("Content-Disposition", "attachment; filename=" + strFile)
                                Response.ContentType = "application/pdf"
                                Response.TransmitFile(fileNameExtension)

                            Catch ex As Exception
                                MensajeError(ex.Message)
                            End Try

                        End If
                    End If
                Else
                End If
            End If
        Catch ex As Exception
            MensajeError(ex.Message)
        End Try
    End Sub

    Protected Sub ddlplazos_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlplazos.SelectedIndexChanged

        Dim datos(0 To 2) As Integer
        Dim dtsRes As New DataSet()

        Dim contAseg As Integer = 0
        Dim contPlazo As Integer = 0
        Dim cad As String = String.Empty

        txtporsub.Text = ""
        txtmtosub.Text = ""

        ObtenTasa()
        CalculaEnganche(0)
        LlenaPagEsp(ddlplazos.SelectedValue)
        Session("band") = 0

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then
            Dim Objver As New clsVersiones()
            Objver.IDVersion = ddlversion.SelectedValue
            Objver.Plazo = ddlplazos.SelectedValue

            dtsRes = Objver.ManejaVersion(8)
            If Objver.ErrorVersion = "" Then
                If dtsRes.Tables.Count > 0 Then
                    If dtsRes.Tables(0).Rows.Count > 0 Then
                        objCombo.LlenaCombos(dtsRes, "PORC_ENGANCHE", "ID", ddlengancheCI, strErr)
                        If strErr <> "" Then
                            Exit Sub
                        End If

                        txtporeng.Text = ddlengancheCI.SelectedItem.Text
                        lblengmin.Text = ddlengancheCI.SelectedItem.Text
                        Dim dtsResver As New DataSet
                        Dim clsver As New clsVersiones
                        clsver.IDVersion = ddlversion.SelectedValue
                        clsver.Plazo = ddlplazos.SelectedValue
                        clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)

                        dtsResver = clsver.ManejaVersion(9)
                        txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                        txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
                        txtenganche.Text = Val((CDbl(txtporeng.Text.Trim) / 100) * txtprecio.Text).ToString("###,##0.00")
                        ddlengancheCI.Enabled = True
                    Else
                        ddlengancheCI.Items.Clear()
                        ddlengancheCI.Enabled = False
                        CalculaEnganche(0)
                    End If
                Else
                    ddlengancheCI.Enabled = False
                End If
            Else
                strErr = Objver.ErrorVersion
            End If
            'ERODRIGUEZ 14/09/2017 Ocultar tasa normal, Mostrar tasa 24 y 36 Meses
            If ddlplazos.SelectedValue = 4 Or ddlplazos.SelectedValue = 6 Then
                ObtenTasa36_72(ddlplazos.SelectedValue) 'textbox tasas 36 y 72 meses erodriguez 14/09/2017

                lblt1.Text = "Tasa" + " 1-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2))).ToString() + " Meses "
                lblt2.Text = "Tasa " + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) + 1).ToString() + "-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) * 2).ToString() + " Meses "
                div36m.Visible = True
                txt36m.Visible = True
                lbltxt36m.Visible = True


                'validacion para etiquetas de valor residual, enganche ci
                div17.Visible = True
                tdlblresidual.Visible = True
                tdtxtresidual.Visible = True
                txtenganche.Enabled = False
                txtporeng.Enabled = False
                tdEngancheCI.Visible = True
                ddlengancheCI.Visible = True
                'validacion para etiquetas de valor residual, enganche ci

            Else
                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = False
                txt36m.Visible = False
                lblt1.Text = "Tasa "
                lbltxt36m.Visible = False

                'validacion para etiquetas de valor residual, enganche ci
                div17.Visible = False
                tdlblresidual.Visible = False
                tdtxtresidual.Visible = False
                txtenganche.Enabled = True
                txtporeng.Enabled = True
                tdEngancheCI.Visible = False
                ddlengancheCI.Visible = False
                'validacion para etiquetas de valor residual, enganche ci

            End If
        Else
            objPaq.IDPaquete = ddlplan.SelectedValue
            objPaq.IDVersion = ddlversion.SelectedValue
            objPaq.IDPlazo = ddlplazos.SelectedValue
            dtsRes = objPaq.ManejaPaquete(50)

            div16.Visible = True
            txttasa.Visible = True
            div36m.Visible = False
            txt36m.Visible = False
            If objPaq.ErrorPaquete = "" Then
                If dtsRes.Tables(0).Rows.Count Then
                    txtporeng.Text = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                    lblengmin.Text = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                    txtporresidual.Text = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON").ToString("###,##0.00")
                    txtresidual.Text = Val((CDbl(dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
                End If
            Else
                MensajeError(objPaq.ErrorPaquete)
                Exit Sub
            End If
            'ERODRIGUEZ 14/09/2017 Ocultar tasa normal, Mostrar tasa 24 y 36 Meses
            div16.Visible = True
            txttasa.Visible = True
            div36m.Visible = False
            txt36m.Visible = False

            'validacion para etiquetas de valor residual, enganche ci
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False
            'validacion para etiquetas de valor residual, enganche ci

        End If

        Dim intbroker As Integer = obten_broker()

        If intbroker = 2 OrElse (usaMulticotiza = 1 AndAlso intbroker = 4) Then 'RQ-PC5 BUG-PC-191
            If grvSeguro.Rows.Count > 0 Then
                For i As Integer = 0 To grvSeguro.Rows.Count - 1
                    If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(i).Cells(7).Text Then
                        contAseg = contAseg + 1

                        If objPlazos.Valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                            contPlazo = contPlazo + 1
                        End If

                    End If
                Next

                If contAseg = 0 Or contPlazo = 0 Then
                    If grvSeguro.Visible = True Then
                        strErr = "La combinación de Aseguradora y/o plazo seleccionado no es válido."
                    End If
                End If

                For i As Integer = 0 To grvSeguro.Rows.Count - 1
                    Dim _Chk As New CheckBox
                    _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")

                    If Val(grvSeguro.Rows(i).Cells(15).Text) > 0 Then
                        If objPlazos.Valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                            If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(i).Cells(7).Text Then
                                _Chk.Checked = True
                            Else
                                _Chk.Checked = False
                            End If
                        Else
                            _Chk.Checked = False
                        End If
                    Else
                        _Chk.Checked = False
                    End If
                Next
            End If
        Else
            If grvSeguro.Rows.Count > 0 Then
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)
                Dim valor As Integer = objPlazos.Valor

                For i = 0 To grvSeguro.Rows.Count - 1
                    Dim _Chk As New CheckBox
                    _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")

                    If valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                        If CDbl(grvSeguro.Rows(i).Cells(15).Text) = 0 Then
                            strErr = "Debe seleccionar un plazo valido, el Broker no regreso valor de ID_COTIZACION."
                            _Chk.Enabled = False
                            _Chk.Checked = False
                            Continue For
                        Else
                            _Chk.Enabled = False
                            _Chk.Checked = True
                        End If
                    Else
                        _Chk.Enabled = False
                        _Chk.Checked = False
                    End If
                Next
            End If
        End If

        If objPaq.IDTipoCalculo = 167 And ddlengancheCI.Enabled = True Then
            ddlengancheCI_SelectedIndexChanged(ddlengancheCI, Nothing)
        End If

        If Not grvSeguro.Rows.Count > 0 Or strErr.Length > 0 Then
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, IIf(String.IsNullOrEmpty(ddlsegvida.SelectedValue), 0, ddlsegvida.SelectedValue), id_prod)
        Else
            If intbroker = 2 OrElse (usaMulticotiza = 1 AndAlso intbroker = 4) Then 'RQ-PC5 BUG-PC-191
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(j).Cells(7).Text Then
                            cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                        End If
                    Next
                End If
            Else
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
            End If
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)
        End If
        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        Dim MulPlazos As DataSet
        Dim Plazo As String
        Dim Monto As Decimal
        Dim Concepto As String

        MulPlazos = ViewState("MulPlazos")
        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
            If objPlazos.Nombre = Plazo Then
                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                    If Concepto = "Pago" Then
                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                    End If
                Next
            End If
        Next
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.ErrorPaquete = "" Then
            txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
        Else
            strErr = objPaq.ErrorPaquete
            Exit Sub
        End If

        If chkPagosEsp.Checked = True Then
            btnAplicaPE_Click(btnAplicaPE, Nothing)
        End If

        If strErr <> "" Then
            MensajeError(strErr)
            Exit Sub
        End If
    End Sub

    Protected Sub chkPagosEsp_CheckedChanged(sender As Object, e As System.EventArgs) Handles chkPagosEsp.CheckedChanged
        If chkPagosEsp.Checked = True Then
            tbPagosEspeciales.Visible = True
        Else
            tbPagosEspeciales.Visible = False
        End If
    End Sub

    Protected Sub txtprecio_TextChanged(sender As Object, e As System.EventArgs) Handles txtprecio.TextChanged
        'BUG-PC-29
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)

        If Val(txtprecio.Text.Trim) = 0 Then
            'prodid = ObtenProducto()
            'objProd.CargaProducto(prodid)
            txtprecio.Text = Val(CDbl(objProd.Precio)).ToString("###,###.00")
            MensajeError("El Precio de Lista no puede ser 0.")
            Exit Sub
        End If

        'objParam = New clsParametros
        ''objProd.CargaProducto(ddlmodelo.SelectedValue)
        'objParam.CargaParametro(181)
        'If CDbl(objProd.Precio) - CDbl(txtprecio.Text.Trim) > (CDbl(Val(objProd.Precio)) * (CDbl(objParam.Valor / 100.0))) Then
        '    'If CDbl(Val(txtprecio.Text.Trim)) < (CDbl(Val(objProd.Precio)) * (1 - CDbl(objParam.Valor / 100.0))) Then
        '    MensajeError("El Precio no puede ser menor al " & objParam.Valor.ToString & "%.")
        '    txtprecio.Text = Val(CDbl(objProd.Precio)).ToString("###,###.00")
        '    Exit Sub
        'End If

        'objParam = New clsParametros
        ''objParam.Descripcion = String.Empty
        'objParam.CargaParametro(182)
        'If CDbl(txtprecio.Text.Trim) - CDbl(objProd.Precio) > (CDbl(Val(objProd.Precio)) * (CDbl(objParam.Valor / 100.0))) Then
        '    'If CDbl(Val(txtprecio.Text.Trim)) > (CDbl(Val(objProd.Precio)) * (1 + CDbl(objParam.Valor / 100.0))) Then
        '    MensajeError("El Precio no puede ser mayor al " & objParam.Valor.ToString & "%.")
        '    txtprecio.Text = Val(CDbl(objProd.Precio)).ToString("###,###.00")
        '    Exit Sub
        'End If

        txtprecio.Text = Replace(txtprecio.Text, ",", "")
        CalculaEnganche(0)
        CargaCombos2()
        txtporsub.Text = ""
        txtmtosub.Text = ""
    End Sub

    Protected Sub txtenganche_TextChanged(sender As Object, e As System.EventArgs) Handles txtenganche.TextChanged

        If txtenganche.Text.Trim.Length = 0 Then
            Dim dtsRes As New DataSet
            Dim count As Integer = 0
            Dim poreng As Decimal = 0
            Dim porres As Decimal = 0

            objPaq.IDAgencia = ddlagencia.SelectedValue
            objPaq.IDVersion = ddlversion.SelectedValue
            objPaq.IDPlazo = ddlplazos.SelectedValue
            dtsRes = objPaq.ManejaPaquete(50)
            If objPaq.ErrorPaquete = "" Then
                If dtsRes.Tables(0).Rows.Count Then
                    count = 1
                    poreng = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                    porres = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")
                End If
            Else
                MensajeError(objPaq.ErrorPaquete)
                Exit Sub
            End If

            objPlazos.IDPaquete = ddlplan.SelectedValue
            objPlazos.Id_Plazo = ddlplazos.SelectedValue
            dtsRes = objPlazos.ManejaPlazos(6)
            If objPlazos.StrErrPlazo = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then

                    txtporeng.Text = IIf(count > 0, poreng, dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN"))
                    txttasa.Text = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL")
                    lblengmin.Text = IIf(count > 0, poreng, dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN"))

                    If CDbl(txtprecio.Text.Trim) >= 0 Then
                        txtenganche.Text = Val((CDbl(txtporeng.Text.Trim) / 100) * txtprecio.Text).ToString("###,###.00") ''* txtUniProd.Text
                    Else
                        MensajeError("El precio no puede ser 0 o menor.")
                        Exit Sub
                    End If

                Else
                    MensajeError("No se encontro información Enganche.")
                    Exit Sub
                End If
            Else
                MensajeError(objPlazos.StrErrPlazo)
                Exit Sub
            End If
            MensajeError("Debe ingresar un monto de Enganche.")
            Exit Sub
        End If


        txtenganche.Text = Replace(txtenganche.Text, ",", "")
        CalculaEnganche(1)
        Session("band") = 1
        'CargaCombos2()
        If Val(txtporeng.Text.Trim) > 100 Then
            MensajeError("El porcentaje no puede ser mayor a 100.")
            CalculaEnganche(2)
            Exit Sub
        End If
        'SetPreviousData()

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        If objPlazos.StrErrPlazo = "" Then

            If Not grvSeguro.Rows.Count > 0 Then
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
            Else

                Dim intbroker As Integer = obten_broker()
                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim id_prod As Integer = ObtenProducto()
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                    ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                    CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                    IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                    ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                    0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                    ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

            End If

            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If
        End If

    End Sub

    Protected Sub txtporeng_TextChanged(sender As Object, e As System.EventArgs) Handles txtporeng.TextChanged

        If Val(txtporeng.Text.Trim) > 100 Then
            MensajeError("El porcentaje no puede ser mayor a 100.")
            CalculaEnganche(2)
            Exit Sub
        End If

        If txtporeng.Text.Trim.Length = 0 Then
            Dim dtsRes As New DataSet
            Dim poreng As Decimal = 0
            Dim porres As Decimal = 0
            Dim count As Integer = 0

            objPaq.IDAgencia = ddlagencia.SelectedValue
            objPaq.IDVersion = ddlversion.SelectedValue
            objPaq.IDPlazo = ddlplazos.SelectedValue
            dtsRes = objPaq.ManejaPaquete(50)
            If objPaq.ErrorPaquete = "" Then
                If dtsRes.Tables(0).Rows.Count Then
                    If objPaq.IDTipoCalculo <> 167 Then
                        count = 1
                        poreng = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                        porres = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")
                    End If
                End If
            Else
                MensajeError(objPaq.ErrorPaquete)
                Exit Sub
            End If

            objPlazos.IDPaquete = ddlplan.SelectedValue
            objPlazos.Id_Plazo = ddlplazos.SelectedValue
            dtsRes = objPlazos.ManejaPlazos(6)
            If objPlazos.StrErrPlazo = "" Then
                If dtsRes.Tables(0).Rows.Count > 0 Then

                    txtporeng.Text = IIf(count > 0, poreng, dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN"))
                    txttasa.Text = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL")
                    lblengmin.Text = IIf(count > 0, poreng, dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN"))

                    If CDbl(txtprecio.Text.Trim) >= 0 Then
                        txtenganche.Text = Val((CDbl(txtporeng.Text.Trim) / 100) * txtprecio.Text).ToString("###,###.00") ''* txtUniProd.Text
                    Else
                        MensajeError("El precio no puede ser 0 o menor.")
                        Exit Sub
                    End If

                Else
                    MensajeError("No se encontro información Enganche.")
                    Exit Sub
                End If
            Else
                MensajeError(objPlazos.StrErrPlazo)
                Exit Sub
            End If
            MensajeError("Debe ingresar un porcentaje de Enganche.")
            Exit Sub
        End If

        txtporeng.Text = Replace(txtporeng.Text, ",", "")
        CalculaEnganche(2)
        Session("band") = 1
        'SetPreviousData()

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        If objPlazos.StrErrPlazo = "" Then

            If Not grvSeguro.Rows.Count > 0 Then
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
            Else

                Dim intbroker As Integer = obten_broker()
                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim id_prod As Integer = ObtenProducto()
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                    ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                    CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                    IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                    ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                    0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                    ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

            End If

            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If

        Else
            MensajeError(objPlazos.StrErrPlazo)
            Exit Sub
        End If

        'CargaCombos2()
    End Sub

    Protected Sub btnAplicaPE_Click(sender As Object, e As System.EventArgs) Handles btnAplicaPE.Click
        Try
            Dim objRow As GridViewRow
            Dim objTxt As Object
            Dim strVal As String = cmbPeriodos.SelectedValue

            For Each objRow In gdvPagEsp.Rows
                If objRow.Cells(2).Controls.Count > 0 Then
                    objTxt = objRow.Cells(2).Controls(1)

                    If strVal = Mid(objRow.Cells(1).Text, 6, 2) Then
                        objTxt.Text = txtPagEsp.Text
                    Else
                        objTxt.Text = ""
                    End If
                End If
            Next
        Catch ex As Exception
            MensajeError(ex.Message)
        End Try
    End Sub
    Public Function ValidaDeducible() As Boolean
        'BUG-PC-128: CGARCIA: 23/11/2017: SE PONE BANDERA PARA APARESER O NO AL DEDUCIBLE
        If MuestraDeducible = 0 Then
            Return False
        Else
            Return True
        End If

    End Function

    Public Function ValidaCobertura() As Boolean
        If MuestraDeducible = 0 Then
            If ddlcobertura.SelectedValue = 0 Then
                Return False
            Else
                Return True
            End If
        Else
            If ddlcobertura.Items.Count > 0 Then
                If ddlcobertura.SelectedValue = 0 Then
                    Return False
                Else
                    Return True
                End If
            Else
                Return False
            End If
        End If
    End Function

    Protected Sub btncotizaseg_Click(sender As Object, e As System.EventArgs) Handles btncotizaseg.Click
        Dim dsDatos As New DataSet()
        dsDatos = objParam.ManejaParametro(10)

        If ddlalianza.SelectedValue = 2225 And ddlaseguradora.SelectedValue = 117 Then
            If CDbl(Replace(lbltotalacc.Text, "$", "")) > 0 Then
                MensajeError("No se puede realizar la cotizacion con accesorios.")
                Exit Sub
            End If
            If ddltiposeg.SelectedValue = 76 Or ddltiposeg.SelectedValue = 188 Then
                MensajeError("No se puede realizar la cotizacion con Seguros Multianual.")
                Exit Sub
            End If
        End If

        If ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168 Then
            ViewState("MulPlazos") = Nothing
        Else
            'BUG-PC-128: CGARCIA: 23/11/2017: SE PONE BANDERA PARA APARESER O NO AL DEDUCIBLE ddlcobertura.SelectedValue = 0 OrElse
            If ddltipounidad.SelectedValue = 0 OrElse ddluso.SelectedValue = 0 OrElse
                 ddlaseguradora.SelectedValue = 0 OrElse ValidaDeducible() = True OrElse ValidaCobertura() = False Then

                If ddltipounidad.SelectedValue = 0 Then
                    MensajeError("Debe seleccionar el tipo de Unidad.")
                    Exit Sub
                End If

                If ddluso.SelectedValue = 0 Then
                    MensajeError("Debe seleccionar el tipo de Uso.")
                    Exit Sub
                End If

                If ddlcobertura.Items.Count = 0 Then
                    MensajeError("Error al cargar las coberturas.")
                    Exit Sub
                Else
                    If ddlcobertura.SelectedValue = 0 Then
                        MensajeError("Debe seleccionar el tipo de Cobertura.")
                        Exit Sub
                    End If
                End If

                If ddlaseguradora.SelectedValue = 0 Then
                    MensajeError("Debe seleccionar una aseguradora.")
                    Exit Sub
                End If
                'BUG-PC-128: CGARCIA: 23/11/2017: SE PONE BANDERA PARA APARESER O NO AL DEDUCIBLE



                If MuestraDeducible = 1 Then
                    Dim bolLlena As Boolean = False
                    Dim intValue As Integer

                    For index As Integer = 0 To dsDatos.Tables(0).Rows.Count - 1 Step 1
                        intValue = dsDatos.Tables(0).Rows(index).Item("ID_ALIANZA").ToString()
                        If ddlalianza.SelectedValue = intValue Then
                            'ObtenSubplan()
                            bolLlena = True
                        End If
                    Next
                    If bolLlena = True Then

                        'If cmbDedusibleDaños.Items.Count = 0 OrElse cmbDeducibleRoboTotal.Items.Count = 0 OrElse cmbIndemnizacion.Items.Count = 0 Then

                        If cmbDedusibleDaños.Items.Count = 0 Then
                            MensajeError("Erro al cargar Deducibles de daños.")
                            Exit Sub
                        Else
                            If cmbDedusibleDaños.SelectedValue = 0 Then
                                MensajeError("Debe seleccionar un tipo de deducible de daños.")
                                Exit Sub
                            End If
                        End If

                        If cmbDeducibleRoboTotal.Items.Count = 0 Then
                            MensajeError("Error al cargar Deducibles de robo total.")
                            Exit Sub
                        Else
                            If cmbDeducibleRoboTotal.SelectedValue = 0 Then
                                MensajeError("Debe seleccionar un tipo de deducible de robo total.")
                                Exit Sub
                            End If
                        End If

                        If cmbIndemnizacion.Items.Count = 0 Then
                            MensajeError("Error al cargar los tipos de indemnización")
                            Exit Sub
                        Else
                            If cmbIndemnizacion.SelectedValue = 0 Then
                                MensajeError("Debe seleccionar un plan de indemnización.")
                                Exit Sub
                            End If
                        End If

                        If txtcprecurrente.Text = String.Empty Then
                            MensajeError("Debe ingresar el código postal.")
                            Exit Sub
                        End If

                        'End If

                    End If

                End If
            End If
            If CotizaSeg() Then
                finseg.Visible = True
                If strErr <> "" Then
                    MensajeError(strErr)
                End If
            Else
                finseg.Visible = False
                MensajeError(strErr)
            End If
        End If
        If ddlsegvida.SelectedValue <> 172 Then
            If Not EmulaCotSegVida() Then
                MensajeError(strErr)
                Exit Sub
            End If
        Else
            Dim intbroker As Integer = obten_broker()
            Session("montoSegVida") = "0.00"
            Session("idquotevida") = "0"
            Dim cad As String = String.Empty
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                For j As Integer = 0 To grvSeguro.Rows.Count - 1
                    cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                Next
            End If
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                            ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                            CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                            IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                            ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                            0, 0, CDbl(Session("montoSegVida").ToString), 0, ddlaseguradora.SelectedValue,
                            ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String
            objPlazos.CargaPlazo(ddlplazos.SelectedValue)

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                MensajeError(strErr)
                Exit Sub
            End If
        End If
    End Sub

    Protected Sub btnGeneraCot_Click(sender As Object, e As System.EventArgs) Handles btnGeneraCot.Click
        Try
            'generarCot = True
            'btnagregarprod_Click(btnagregarprod, Nothing)
            'generarCot = False
            'If Not AccFlag Then
            '    Exit Sub
            'Else
            '    AccFlag = False
            'End If

            If ValidaMontoCredito() Then
                If ValidaDatosCliente() Then
                    If ValidadatosCte() Then  'MUAA
                        If ValidaMontoAcc() Then
                            If ValidaPagosEsp() Then
                                If ValidaCotizarSeg() Then
                                    If GuardaCotiza() Then
                                        ''Accesorios
                                        If CDbl(lbltotalacc.Text.Trim) > 0 Then
                                            If GuardaAccesorios(IDCotizacion) Then
                                                ''strErr = "Datos guardados exitosamente."
                                            Else
                                                MensajeError(strErr)
                                                Exit Sub
                                            End If
                                        End If

                                        ''Pagos Especiales
                                        If chkPagosEsp.Checked = True Then
                                            If GuardaPagosEsp(IDCotizacion) Then
                                                ''strErr = "Datos guardados exitosamente."
                                            Else
                                                MensajeError(strErr)
                                                Exit Sub
                                            End If
                                        End If

                                        Dim brokerid As String = obten_broker()
                                        ''Personas
                                        If chkdatoscte.Checked = True Then
                                            If GuardaPersonas(IDCotizacion) = True Then
                                                'Teléfonos
                                                objCot.IDCotizacion = IDCotizacion
                                                objCot.IDPersonaCliente = idpersona
                                                objCot.Telefonos = txttelfijo.Text.Trim
                                                objCot.TelefonoMovil = txttelmovil.Text.Trim
                                                objCot.UsuReg = Session("usrreg")
                                                objCot.ManejaCotizacion(30)

                                                If objCot.ErrorCotizacion <> "" Then
                                                    strErr = objCot.ErrorCotizacion
                                                    MensajeError(strErr)
                                                    Exit Sub
                                                End If
                                            Else
                                                MensajeError(strErr)
                                            End If
                                        End If

                                        ''Datos del Seguro
                                        If Not GuardaSeg(Session("IDCot")) Then
                                            strErr = "Error al guardar datos del Seguro."
                                            MensajeError(strErr)
                                            Exit Sub
                                        End If

                                        'BUG-PC-166 INI
                                        If (brokerid = 5) Then
                                            If MuestraDeducible = 1 Then
                                            Dim daniosdatos As New clsDaniosDinamico
                                            daniosdatos.CotizacionId = IDCotizacion
                                            daniosdatos.CoberturaId = ddlcobertura.SelectedValue
                                            daniosdatos.CoberturaDesc = ddlcobertura.SelectedItem.Text
                                            daniosdatos.DeducDaniosId = cmbDedusibleDaños.SelectedValue
                                            daniosdatos.DeducDaniosDesc = cmbDedusibleDaños.SelectedItem.Text
                                            daniosdatos.DeducDaniosRoboId = cmbDeducibleRoboTotal.SelectedValue
                                            daniosdatos.DeducDaniosRoboDesc = cmbDeducibleRoboTotal.SelectedItem.Text
                                            daniosdatos.IndemnizacionId = cmbIndemnizacion.SelectedValue
                                            daniosdatos.IndemnizacionDesc = cmbIndemnizacion.SelectedItem.Text
                                            daniosdatos.ManeDaniosDinamico(1)
                                        End If
                                        'BUG-PC-166 FIN


                                        'BUG-PC-177 INI                                   
                                        'BUG-PC-185 BUG-PC-193
                                        If (usaMulticotiza = 1 AndAlso brokerid = 4) OrElse ((brokerid = 5) AndAlso (divDeducible.Visible = True)) Then
                                            Dim _ObjSeg As New SNProcotiza.clsSeguro
                                            _ObjSeg.CodigoPostal = Me.txtcprecurrente.Text.Trim
                                            _ObjSeg._intClaveCotizacion = IDCotizacion
                                            _ObjSeg.ManejaSeguro(7)
                                        End If
                                        'BUG-PC-177 FIN



                                        objCot.IDCotizacion = IDCotizacion
                                        objCot.IDEmpresa = 1
                                        objCot.GeneraTablaAmort()
                                        btnGeneraSol.Enabled = True
                                        btnImprimeCot.Enabled = True
                                        MensajeError(strErr)
                                    Else
                                        MensajeError(strErr)
                                        Exit Sub
                                    End If
                                Else
                                    MensajeError(strErr)
                                End If
                            Else
                                MensajeError(strErr)
                            End If
                        Else
                            MensajeError(strErr)
                        End If
                    Else
                        MensajeError(strErr)
                        If chkdatoscte.Checked = False Then
                            chkdatoscte.Checked = True
                        End If
                        Dim script As String = "muestradiv();"
                        ScriptManager.RegisterStartupScript(Me, GetType(Page), "muestradiv", script, True)
                        txtnombrecte.Focus()
                    End If
                Else
                    MensajeError(strErr)
                End If
            Else
                MensajeError(strErr)
            End If
            End If

            'BBVA-P-412 RQ WSC AVH:
            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String

            MulPlazos = ViewState("MulPlazos")
            If IDCotizacion > 0 Then
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)

                            objCot.IDCotizacion = IDCotizacion
                            objCot.ValorPlazo = Val(Plazo)
                            objCot.Monto = Monto
                            objCot.ManejaCotizacion(32)
                        End If
                    Next
                Next
            End If


        Catch ex As Exception
            MensajeError(ex.Message)
            Exit Sub
        End Try
    End Sub
    Public Function ValidaMontoCredito() As Boolean

        ValidaMontoCredito = False
        Dim MulPlazos As DataSet
        Dim Plazo As String
        Dim Monto As Double
        Dim Concepto As String
        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

        MulPlazos = ViewState("MulPlazos")
        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
            If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                    If Concepto = "Monto A Financiar" Then
                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                    End If
                Next
            End If
        Next

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If Monto < objPaq.ImporteMinG Then
            strErr = "El Monto del crédito no puede ser menor al monto mínimo del plan."
            Exit Function
        End If


        If Monto > objPaq.ImporteMaxG Then
            strErr = "El Monto del crédito no puede ser mayor al monto máximo del plan."
            Exit Function
        End If

        ValidaMontoCredito = True
    End Function
    Protected Sub btnImprimeCot_Click(sender As Object, e As System.EventArgs) Handles btnImprimeCot.Click

        Dim strReporte As String = System.Configuration.ConfigurationManager.AppSettings.Item("EligeRep")
        If strReporte = "1" Then
            CargaCotizacionPDF(Val(Session("IDCot")))
        End If

        If strReporte = "2" Then
            'BBV-P-412 RQCOT-05:AVH
            CargaCotizacion(Val(Session("IDCot")))
        End If

    End Sub

    Protected Sub btnGeneraSol_Click(sender As Object, e As System.EventArgs) Handles btnGeneraSol.Click
        Response.Redirect("cotSolicitud.aspx?idCotizacion=" & Val(Session("IDCot")).ToString() & "&idCotSeguro=" & Val(Request("IdCotSeguro")) & "&Propuesta=" & 0)
    End Sub

    Protected Sub ddlmodelo_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlmodelo.SelectedIndexChanged
        Dim datos(0 To 2) As Integer
        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Version 
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.PermitePagosEspeciales = 1 Then
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = True
            tbPagosEspeciales.Visible = True
        Else
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = False
            tbPagosEspeciales.Visible = False
        End If

        'ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If

            If ddlplazos.SelectedValue = 4 Or ddlplazos.SelectedValue = 6 Then
                ObtenTasa36_72(ddlplazos.SelectedValue) 'textbox tasas 36 y 72 meses erodriguez 14/09/2017
                lblt1.Text = "Tasa" + " 1-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2))).ToString() + " Meses"
                lblt2.Text = "Tasa " + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) + 1).ToString() + "-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) * 2).ToString() + " Meses"
                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = True
                txt36m.Visible = True
                lbltxt36m.Visible = True

                'validacion para etiquetas de valor residual, enganche ci
                div17.Visible = True
                tdlblresidual.Visible = True
                tdtxtresidual.Visible = True
                txtenganche.Enabled = False
                txtporeng.Enabled = False
                tdEngancheCI.Visible = True
                ddlengancheCI.Visible = True
                'validacion para etiquetas de valor residual, enganche ci
            Else

                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = False
                txt36m.Visible = False
                lblt1.Text = "Tasa "
                lbltxt36m.Visible = False

                'validacion para etiquetas de valor residual, enganche ci
                div17.Visible = False
                tdlblresidual.Visible = False
                tdtxtresidual.Visible = False
                txtenganche.Enabled = True
                txtporeng.Enabled = True
                tdEngancheCI.Visible = False
                ddlengancheCI.Visible = False
                'validacion para etiquetas de valor residual, enganche ci


            End If




        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False
            txt36m.Visible = False
        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)

        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If

        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()

    End Sub

    Protected Sub ddlplan_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlplan.SelectedIndexChanged
        Dim datos(1) As Integer

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        txtporsub.Text = ""
        txtmtosub.Text = ""

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        LlenaPagEsp(ddlplazos.SelectedValue)

        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        If CargaCombos2() Then
            Dim brokerid As String = obten_broker()
            'RQ-PC5
            'BUG-PC-191 BUG-PC-193
            If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) OrElse (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
                dvrecurrecte.Visible = True
                dvcodpostal.Visible = True
            Else
                dvrecurrecte.Visible = False
                dvcodpostal.Visible = False
            End If
        Else
            finseg.Visible = False
            If strErr <> "" Then
                MensajeError(strErr)
            End If
            Exit Sub
        End If

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.PermitePagosEspeciales = 1 Then
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = True
            tbPagosEspeciales.Visible = True
        Else
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = False
            tbPagosEspeciales.Visible = False
        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)

        If objPaq.IDTipoCalculo = 167 Then
            ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True
            If ddlplazos.SelectedValue = 4 Or ddlplazos.SelectedValue = 6 Then
                ObtenTasa36_72(ddlplazos.SelectedValue) 'textbox tasas 36 y 72 meses erodriguez 14/09/2017
                lblt1.Text = "Tasa" + " 1-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2))).ToString() + " Meses"
                lblt2.Text = "Tasa " + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) + 1).ToString() + "-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) * 2).ToString() + " Meses"
                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = True
                txt36m.Visible = True
                lbltxt36m.Visible = True
            End If
        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False
            div16.Visible = True
            txttasa.Visible = True
            div36m.Visible = False
            txt36m.Visible = False
            lblt1.Text = "Tasa"
            lbltxt36m.Visible = False
        End If

        If objPaq.PermiteMontoSubsidio Or objPaq.PermitePtjSubsidio Then
            txtmtosub.Visible = True
            txtmtosub.Enabled = objPaq.PermiteMontoSubsidio
            txtporsub.Visible = True
            txtporsub.Enabled = objPaq.PermitePtjSubsidio
        End If
        Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
        Dim id_prod As Integer = ObtenProducto()
        LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, _
    ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, _
    CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), _
    Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)



    End Sub

    Protected Sub ddledo_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddledo.SelectedIndexChanged

        Dim dtsRes As New DataSet
        Dim datos(2) As Integer
        Dim objage As New clsAgencias
        Dim strsql As String = String.Empty
        Dim renglon() As DataRow

        'Combo Agencias
        'datos(0) = 2
        'datos(1) = ddledo.SelectedValue
        'objCombo.LlenaObjs(ddlagencia, datos)

        'BUG-PC-196 INI 
        objage.IDEstatus = 2
        objage.IDEstado = ddledo.SelectedValue
        objage.IDUsuario = iduser
        dtsRes = objage.ManejaAgencia(26)

        'objage.IDAlianza = ddlalianza.SelectedValue
        'objage.IDGrupo = -1
        'objage.IDDivision = -1
        'objage.IDUsuario = iduser
        'objage.IDEstado = ddledo.SelectedValue
        'dtsRes = objage.ManejaAgencia(30)
        'BUG-PC-196 FIN
        If objage.ErrorAgencia = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dtsRes, "NOMBRE", "ID_AGENCIA", ddlagencia, strErr)
                If Trim$(strErr) <> "" Then
                    Exit Sub
                End If
                strsql = "ID_AGENCIA = " + ddlagencia.SelectedValue.ToString
                renglon = dtsRes.Tables(0).Select(strsql)
                Session("dtsagencias") = Nothing
                Session("dtsagencias") = dtsRes
            Else
                strErr = "No se encontro información de Agencias."
                Exit Sub
            End If
        Else
            strErr = objage.ErrorAgencia
            Exit Sub
        End If

        If ddlagencia.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlagencia)
            limpiaobjs("textbox", ddlagencia)
            limpiaobjs("label", ddlagencia)
            MensajeError("No se encontro información de Agencias con los parámetros proporcionados.")
            Exit Sub
        Else
            objage.IDEstatus = 2
            objage.IDEstado = ddledo.SelectedValue
            objage.IDUsuario = iduser
            dtsRes = objage.ManejaAgencia(26)
            If objage.ErrorAgencia = "" Then
                strsql = "ID_AGENCIA = " + ddlagencia.SelectedValue.ToString
                renglon = dtsRes.Tables(0).Select(strsql)
                Session("dtsagencias") = Nothing
                Session("dtsagencias") = dtsRes
            Else
                MensajeError("No se encontro información de Agencias con los parámetros proporcionados.")
                Exit Sub
            End If
        End If

        'Combo Alianza
        'Dim objagencia As New clsAgencias()
        'objagencia.IDAgencia = ddlagencia.SelectedValue
        'dtsRes = objagencia.ManejaAgencia(1)


        ReDim datos(2)
        datos(0) = iduser 'dtsRes.Tables(0).Rows(0).Item("ID_ALIANZA")
        datos(1) = ddledo.SelectedValue

        objCombo.LlenaObjs(ddlalianza, datos)
        For Each row In renglon
            Try
                ddlalianza.SelectedValue = row("ID_ALIANZA")
            Catch ex As Exception
                MensajeError("No se encontro información de Alianzas.")
                Exit Sub
            End Try
        Next

        'Combo Grupo
        ReDim datos(2)
        datos(0) = iduser  'dtsRes.Tables(0).Rows(0).Item("ID_GRUPO")
        datos(1) = ddledo.SelectedValue

        objCombo.LlenaObjs(ddlgrupo, datos)
        For Each row In renglon
            ddlgrupo.SelectedValue = row("ID_GRUPO")
        Next

        'Combo División
        ReDim datos(2)
        datos(0) = iduser  'dtsRes.Tables(0).Rows(0).Item("ID_DIVISION")
        datos(1) = ddledo.SelectedValue

        objCombo.LlenaObjs(ddldivision, datos)
        For Each row In renglon
            ddldivision.SelectedValue = row("ID_DIVISION")
        Next


        'Combo Promotores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlejecutivo, datos)
        If ddlejecutivo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlejecutivo)
            limpiaobjs("textbox", ddlejecutivo)
            limpiaobjs("label", ddlejecutivo)
            MensajeError("No se encontro información de F&I.")
            Exit Sub
        End If

        'Combo Vendedores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlvendedor, datos)
        'Cuando el usuario es de perfil vendedor se selecciona solo su usuario en el combo de usuarios
        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
        If objUsuFirma.IDPerfil = 74 Then
            If ddlvendedor.Items.Count > 0 Then
                ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
            End If
        End If
        If ddlvendedor.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlvendedor)
            limpiaobjs("textbox", ddlvendedor)
            limpiaobjs("label", ddlvendedor)
            MensajeError("No se encontro información de Vendedores.")
            Exit Sub
        End If

        ''Combo Marca
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmarca, datos)
        If ddlmarca.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmarca)
            limpiaobjs("textbox", ddlmarca)
            limpiaobjs("label", ddlmarca)
            MensajeError("La Agencia " & ddlagencia.SelectedItem.Text & " no cuenta con Marcas asignadas.")
            Exit Sub
        End If

        ''Combo SubMarca
        ReDim datos(2)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmodelo, datos)
        If ddlmodelo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmodelo)
            limpiaobjs("textbox", ddlmodelo)
            limpiaobjs("label", ddlmodelo)
            MensajeError("No se encontro información de SubMarcas con los parámetros proporcionados.")
            Exit Sub
        End If
        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then

            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If
        ''Version
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False

        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
        Dim brokerid As String = obten_broker()
        'RQ-PC5
        'BUG-PC-191
        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) OrElse (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
            dvrecurrecte.Visible = True
            dvcodpostal.Visible = True
        Else
            dvrecurrecte.Visible = False
            dvcodpostal.Visible = False
        End If

    End Sub

    Protected Sub ddlagencia_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlagencia.SelectedIndexChanged
        Dim dtsRes As New DataSet
        Dim datos(2) As Integer
        Dim renglon() As DataRow

        dtsRes = Session("dtsagencias")
        Dim strsql = "ID_AGENCIA = " + ddlagencia.SelectedValue.ToString
        renglon = dtsRes.Tables(0).Select(strsql)

        'Combo Alianza, Grupo, División
        For Each row In renglon
            Try
                ddlalianza.SelectedValue = row("ID_ALIANZA")
            Catch ex As Exception
                MensajeError("No se encontro información de Alianza.")
                Exit Sub
            End Try
            Try
                ddlgrupo.SelectedValue = row("ID_GRUPO")
            Catch ex As Exception
                MensajeError("No se encontro información de Grupo.")
                Exit Sub
            End Try
            Try
                ddldivision.SelectedValue = row("ID_DIVISION")
            Catch ex As Exception
                MensajeError("No se encontro información de Division.")
                Exit Sub
            End Try
        Next

        'Combo Promotores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlejecutivo, datos)
        If ddlejecutivo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlejecutivo)
            limpiaobjs("textbox", ddlejecutivo)
            limpiaobjs("label", ddlejecutivo)
            MensajeError("No se encontro información de F&I.")
            Exit Sub
        End If

        'Combo Vendedores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlvendedor, datos)
        'Cuando el usuario es de perfil vendedor se selecciona solo su usuario en el combo de usuarios
        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
        If objUsuFirma.IDPerfil = 74 Then
            If ddlvendedor.Items.Count > 0 Then
                ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
            End If
        End If
        If ddlvendedor.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlvendedor)
            limpiaobjs("textbox", ddlvendedor)
            limpiaobjs("label", ddlvendedor)
            MensajeError("No se encontro información de Vendedores.")
            Exit Sub
        End If

        ''Combo Marca
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmarca, datos)
        If ddlmarca.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmarca)
            limpiaobjs("textbox", ddlmarca)
            limpiaobjs("label", ddlmarca)
            MensajeError("La Agencia " & ddlagencia.SelectedItem.Text & " no cuenta con Marcas asignadas.")
            Exit Sub
        End If

        ''Combo SubMarca
        ReDim datos(2)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmodelo, datos)
        If ddlmodelo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmodelo)
            limpiaobjs("textbox", ddlmodelo)
            limpiaobjs("label", ddlmodelo)
            MensajeError("No se encontro información de SubMarcas con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año 
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Version
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.PermitePagosEspeciales = 1 Then
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = True
            tbPagosEspeciales.Visible = True
        Else
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = False
            tbPagosEspeciales.Visible = False
        End If

        'ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If


        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If

            If ddlplazos.SelectedValue = 4 Or ddlplazos.SelectedValue = 6 Then
                ObtenTasa36_72(ddlplazos.SelectedValue) 'textbox tasas 36 y 72 meses erodriguez 14/09/2017

                lblt1.Text = "Tasa" + " 1-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2))).ToString() + " Meses "
                lblt2.Text = "Tasa " + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) + 1).ToString() + "-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) * 2).ToString() + " Meses "
                div36m.Visible = True
                txt36m.Visible = True
                lbltxt36m.Visible = True
            Else
                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = False
                txt36m.Visible = False
                lblt1.Text = "Tasa "
                lbltxt36m.Visible = False
            End If

        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False


            div16.Visible = True
            txttasa.Visible = True
            div36m.Visible = False
            txt36m.Visible = False
            lblt1.Text = "Tasa "
            lbltxt36m.Visible = False

        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)


        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        If CargaCombos2() Then
            Dim brokerid As String = obten_broker()
            'RQ-PC5
            'BUG-PC-191 BUG-PC-193
            If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) OrElse (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
                dvrecurrecte.Visible = True
                dvcodpostal.Visible = True
            Else
                dvrecurrecte.Visible = False
                dvcodpostal.Visible = False
            End If
        Else
            finseg.Visible = False
            If strErr <> "" Then
                MensajeError(strErr)
            End If
            Exit Sub
        End If
    End Sub

    Protected Sub ddltiposeg_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddltiposeg.SelectedIndexChanged

        Dim brokerid As Integer = obten_broker()
        If brokerid = 2 Then
            'ddlGarantia.Enabled = False
            'txtmtogarantia.Enabled = False
        Else
            'If ddltiposeg.SelectedValue = 32 Then
            'ddlGarantia.SelectedValue = 0
            'txtmtogarantia.Text = ""
            'ddlGarantia.Enabled = False
            'txtmtogarantia.Enabled = False
            'Else
            ddlGarantia.Enabled = True
            txtmtogarantia.Enabled = True
            divmtogarantia.Visible = True
            divmtogarantia.Attributes("class") = "visible"
            'End If
        End If

        If (ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168) Then
            finseg.Visible = False
            ViewState("MulPlazos") = Nothing
            If ddlsegvida.SelectedValue <> 172 Then
                btncotizaseg.Enabled = False
            Else
                Session("montoSegVida") = "0.00"
                Session("idquotevida") = "0"
                btncotizaseg.Enabled = False
            End If


            cmbIndemnizacion.Enabled = False
            cmbDedusibleDaños.Enabled = False
            cmbDeducibleRoboTotal.Enabled = False
            ddlaseguradora.Enabled = False
            ddltipounidad.Enabled = False
            ddluso.Enabled = False
            ddlcobertura.Enabled = False
            txtedad.Enabled = False
            rdbsexh.Enabled = False
            rdbsexm.Enabled = False
            rdbsexh.Checked = False
            rdbsexm.Checked = False
            txtconductor.Enabled = False
            txtconductor.Text = ""
            txtedad.Text = ""
            txtcprecurrente.Enabled = False
            txtcprecurrente.Text = ""
        Else

            cmbIndemnizacion.Enabled = True
            cmbDedusibleDaños.Enabled = True
            cmbDeducibleRoboTotal.Enabled = True
            btncotizaseg.Enabled = True
            ddlaseguradora.Enabled = True
            ddltipounidad.Enabled = True
            ddluso.Enabled = True
            ddlcobertura.Enabled = True
            txtedad.Enabled = True
            rdbsexh.Enabled = True
            rdbsexm.Enabled = True
            rdbsexh.Checked = False
            rdbsexm.Checked = False
            txtconductor.Enabled = True
            txtconductor.Text = ""
            txtedad.Text = ""
            txtcprecurrente.Enabled = True
            txtcprecurrente.Text = ""
        End If

        If ddlsegvida.SelectedValue = 172 Then
            Session("montoSegVida") = "0.00"
            Session("idquotevida") = "0"
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                btncotizaseg.Enabled = True
            Else
                ViewState("MulPlazos") = Nothing
                btncotizaseg.Enabled = False
            End If
        Else
            btncotizaseg.Enabled = True
        End If

        If brokerid <> 2 Then
            If (ddltipounidad.Items.Count = 0 Or ddluso.Items.Count = 0 Or ddlcobertura.Items.Count = 0 Or ddlaseguradora.Items.Count = 0 Or cmbIndemnizacion.Items.Count = 0) And (ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168) Then
                ViewState("MulPlazos") = Nothing
                If ddlsegvida.SelectedValue <> 172 Then
                    btncotizaseg.Enabled = True
                Else
                    Session("montoSegVida") = "0.00"
                    btncotizaseg.Enabled = False
                End If
                ddlaseguradora.Enabled = False
                ddltipounidad.Enabled = False
                ddluso.Enabled = False
                ddlcobertura.Enabled = False
                cmbIndemnizacion.Enabled = False
            Else
                btncotizaseg.Enabled = True
                ddlaseguradora.Enabled = True
                ddltipounidad.Enabled = True
                ddluso.Enabled = True
                ddlcobertura.Enabled = True
                'cmbIndemnizacion.Enabled = True
            End If
        End If

        '02032017
        Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
        Dim id_prod As Integer = ObtenProducto()
        LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
     ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                            CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0,
                            CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)

    End Sub

    Private Function CotizaSeg() As Boolean

        CotizaSeg = False
        Dim dtsRes As New DataSet
        Dim celda As Integer = 0

        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) And (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
            If txtedad.Text.Trim.Length = 0 Then
                strErr = "Debe ingresar la edad del conductor recurrente."   'MUAA
                Exit Function
            End If
            If rdbsexh.Checked = False And rdbsexm.Checked = False Then
                strErr = "Debe seleccionar el Género del conductor recurrente"   'MUAA
                Exit Function
            End If

            If txtcprecurrente.Text.Length < 5 Then
                strErr = "Debe ingresar Código Postal."
                Exit Function
            End If

            If txtconductor.Text.Trim.Length = 0 Then
                strErr = "Debe ingresar el nombre del conductor recurrente."    'MUAA
                Exit Function
            End If
        End If

        Dim intbroker As Integer = obten_broker()
        'RQ-PC5
        If (usaMulticotiza = 1 AndAlso intbroker = 4) Then 'intbroker = 5 Or intbroker = 9
            If (txtcprecurrente.Text.Length < 5) And (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                strErr = "Debe ingresar Código Postal."
                Exit Function
            End If
        End If
        If grvSeguro.Rows.Count > 0 Then
            OcultaColumnas(2)
        End If

        Select Case intbroker
            Case 2 ''ORDAS

                Dim dtsgarantia As New DataSet()
                Dim objcotOrdas As New WCF.clsCotSegOrdas()
                Dim totacc As Double = 0

                For Each row In grvAccesorios.Rows
                    Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)
                    Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
                    If ddl1.SelectedValue <> "" Then
                        If ddl1.SelectedValue = 1 Then  'CAMBIO URGENTE RHERNANDEZ POR ACCESORIOS INEXISTENTES
                            totacc = CDbl(txt.Text.Trim())
                        End If
                    End If
                Next
                'JRHM CONDICION PARA MALA CONFIGURACION AL COTIZAR CON SEGUROS ORDAS 
                If IsNothing(txtedad.Text.Trim) Or (rdbsexm.Checked = False And rdbsexh.Checked = False) Or IsNothing(txtcprecurrente.Text.Trim) Then
                    strErr = "Error del Servicio Web: Datos incompletos para cotizar"
                    Exit Function
                End If

                dtsRes = objcotOrdas.CotizaOrdas(intbroker, ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue,
                                                 ddlversion.SelectedValue, ddlanio.SelectedValue, Convert.ToInt16(txtedad.Text.Trim),
                                                 IIf(rdbsexh.Checked = True, 2, 1), totacc, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                                 CDbl(txtprecio.Text.Trim), ddlpj.SelectedValue, ddledoseg.SelectedValue,
                                                 txtcprecurrente.Text.Trim, ddlaseguradora.SelectedValue, ddlmonedafact.SelectedValue,
                                                 ddltiposeg.SelectedValue, ddlplan.SelectedValue, ddlagencia.SelectedValue)

                If objcotOrdas.StrError <> "" Then
                    strErr = "Respuesta del Servicio Web: " & objcotOrdas.StrError
                    If objcotOrdas.StrError = "Servicio no disponible" Then
                        Exit Function
                    End If
                End If

                ViewState("dtscotizaseg") = dtsRes.Tables(0).Copy()
                ViewState("dtsREcibos") = dtsRes.Tables(1).Copy()

                grvSeguro.DataSource = dtsRes.Tables(0)
                grvSeguro.DataBind()

                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                Dim cont As Integer = 0
                Dim err As Integer = 0
                For i As Integer = 0 To grvSeguro.Rows.Count - 1
                    Dim _Chk As New CheckBox

                    _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")
                    _Chk.Enabled = False

                    If Val(grvSeguro.Rows(i).Cells(15).Text) > 0 Then
                        If objPlazos.Valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                            If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(i).Cells(7).Text Then
                                _Chk.Checked = True
                                cont = 1
                            Else
                                _Chk.Checked = False
                                If Val(grvSeguro.Rows(i).Cells(15).Text) = 0 Then err = err + 1
                            End If
                        Else
                            _Chk.Checked = False
                            If Val(grvSeguro.Rows(i).Cells(15).Text) = 0 Then err = err + 1
                        End If
                    Else
                        _Chk.Checked = False
                        If Val(grvSeguro.Rows(i).Cells(15).Text) = 0 Then err = err + 1
                    End If
                Next

                'If err > 0 Then
                '    strErr = "En la respuesta del broker existe(n) algún(os) plazo(s) no valido(s). Favor de validar."
                'End If

                If cont = 1 Then
                    Dim cad As String = String.Empty

                    If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                        For j As Integer = 0 To grvSeguro.Rows.Count - 1
                            If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(j).Cells(7).Text Then
                                cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                            End If
                        Next
                    End If

                    Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                    Dim id_prod As Integer = ObtenProducto()
                    LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                        ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                        CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                        IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                        1, ddltiposeg.SelectedValue, 1, 1,
                                        0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                        ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

                    Dim MulPlazos As DataSet
                    Dim Plazo As String
                    Dim Monto As Decimal
                    Dim Concepto As String
                    objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                    MulPlazos = ViewState("MulPlazos")
                    For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                        Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                        If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                            For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                                Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                                If Concepto = "Pago" Then
                                    Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                                End If
                            Next
                        End If
                    Next

                    objPaq = New clsPaquetes
                    objPaq.CargaPaquete(ddlplan.SelectedValue)
                    If objPaq.ErrorPaquete = "" Then
                        txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                    Else
                        strErr = objPaq.ErrorPaquete
                        Exit Function
                    End If
                Else

                    grvMultiCotiza.DataBind()
                End If
                OcultaColumnas(2)
                CotizaSeg = True

            Case 3 ''EIKOS
                Dim objcotEikos As New WCF.clsCotSegEikos()
                Dim objprod As New SNProcotiza.clsProductos()
                Dim intBrokerABA As Integer = 0
                objprod.IDMarca = ddlmarca.SelectedValue
                objprod.IDSubmarca = ddlmodelo.SelectedValue
                objprod.IDVersion = ddlversion.SelectedValue
                objprod.IDAnio = ddlanio.SelectedValue
                objprod.CargaProducto()

                If ddlaseguradora.SelectedValue = 122 Then
                    intBrokerABA = 105
                End If

                objcotEikos.BrokerABA = intBrokerABA

                dtsRes = objcotEikos.CotizaEikos(intbroker, ddlanio.SelectedValue, ddltipounidad.SelectedValue, ddluso.SelectedValue, objprod.IDExterno,
                                                ddlclasif.SelectedValue, ddledoseg.SelectedValue, CDbl(txtenganche.Text.Trim), CDbl(Replace(lbltotalacc.Text, "$", "")),
                                                 ddlcobertura.SelectedValue, ddlaseguradora.SelectedValue, ddlagencia.SelectedValue, txtcp.Text.Trim,
                                                 CDbl(txtprecio.Text.Trim), ddlplan.SelectedValue, iduser, txtnombrectepf.Text.Trim, txtnombrecte2.Text.Trim,
                                                 txtpaterno.Text.Trim, txtmaterno.Text.Trim, ddltiposeg.SelectedValue)

                If objcotEikos.StrError <> "" Then
                    strErr = "Respuesta del Servicio Web: " & objcotEikos.StrError
                    Exit Function
                End If

                OcultaColumnas(2)
                grvSeguro.DataSource = dtsRes.Tables(0)
                grvSeguro.DataBind()

                ViewState("dtsREcibos") = dtsRes.Tables(1)

                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


                Dim MulPlazos As DataSet
                Dim Plazo As String
                Dim Monto As Decimal
                Dim Concepto As String
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                MulPlazos = ViewState("MulPlazos")
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                        For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                            Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                            If Concepto = "Pago" Then
                                Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                            End If
                        Next
                    End If
                Next
                objPaq = New clsPaquetes
                objPaq.CargaPaquete(ddlplan.SelectedValue)
                If objPaq.ErrorPaquete = "" Then
                    txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                Else
                    strErr = objPaq.ErrorPaquete
                    Exit Function
                End If
                celda = 15
                CotizaSeg = True
            Case 4 ''MARSH
                If usaMulticotiza = 1 Then
                    Dim objcotMarhs As New WCF.clsCotSegMarshMulti()
                    objcotMarhs.IdPlazo = ddlplazos.SelectedValue 'BUG-PC-175
                    dtsRes = objcotMarhs.CotizaMultiMarsh(intbroker, ddluso.SelectedValue, ddlanio.SelectedValue, ddltipounidad.SelectedValue, ddlclasif.SelectedValue,
                                                     CDbl(txtprecio.Text.Trim), ddledoseg.SelectedValue, CDbl(Replace(lbltotalacc.Text, "$", "")), ddlcobertura.SelectedValue,
                                                     ddltiposeg.SelectedItem.Text,
                                                     ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue, ddlversion.SelectedValue, ddlanio.SelectedValue,
                                                     ddlaseguradora.SelectedValue, ddlagencia.SelectedValue, ddlplan.SelectedValue, , , Me.txtcprecurrente.Text.Trim)


                    If objcotMarhs.StrError <> "" Then
                        strErr = "Respuesta del Servicio Web: " & objcotMarhs.StrError
                        Exit Function
                    End If

                    OcultaColumnas(2)
                    grvSeguro.DataSource = dtsRes.Tables(0)
                    grvSeguro.DataBind()

                    ViewState("dtsREcibos") = dtsRes.Tables(1)
                    ViewState("cotCodigoPostal") = Me.txtcprecurrente.Text.Trim

                    Dim checkCotizacion = False

                    objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                    For i As Integer = 0 To grvSeguro.Rows.Count - 1
                        Dim _Chk As New CheckBox

                        _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")
                        _Chk.Enabled = False

                        If Val(grvSeguro.Rows(i).Cells(15).Text) > 0 Then
                            If objPlazos.Valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                                If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(i).Cells(7).Text Then
                                    _Chk.Checked = True
                                    checkCotizacion = True
                                Else
                                    _Chk.Checked = False
                                End If
                            Else
                                _Chk.Checked = False
                            End If
                        Else
                            _Chk.Checked = False
                        End If
                    Next


                    If checkCotizacion Then
                        Dim cad As String = String.Empty
                        If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                            For j As Integer = 0 To grvSeguro.Rows.Count - 1
                                cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                            Next
                        End If
                        Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                        Dim id_prod As Integer = ObtenProducto()
                        LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                        ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                        CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                        IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                        ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                        0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                        ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


                        Dim MulPlazos As DataSet
                        Dim Plazo As String
                        Dim Monto As Decimal
                        Dim Concepto As String
                        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                        MulPlazos = ViewState("MulPlazos")
                        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                            If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                                    If Concepto = "Pago" Then
                                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                                    End If
                                Next
                            End If
                        Next
                        objPaq = New clsPaquetes
                        objPaq.CargaPaquete(ddlplan.SelectedValue)
                        If objPaq.ErrorPaquete = "" Then
                            txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                        Else
                            strErr = objPaq.ErrorPaquete
                            Exit Function
                        End If
                    Else
                        grvMultiCotiza.DataBind()
                    End If

                Else
                Dim objcotMarhs As New WCF.clsCotSegMarsh()
                dtsRes = objcotMarhs.CotizaMarsh(intbroker, ddluso.SelectedValue, ddlanio.SelectedValue, ddltipounidad.SelectedValue, ddlclasif.SelectedValue,
                                        CDbl(txtprecio.Text.Trim), ddledoseg.SelectedValue, CDbl(Replace(lbltotalacc.Text, "$", "")), ddlcobertura.SelectedValue,
                                        ddltiposeg.SelectedItem.Text,
                                        ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue, ddlversion.SelectedValue, ddlanio.SelectedValue,
                                        ddlaseguradora.SelectedValue, ddlagencia.SelectedValue, ddlplan.SelectedValue)

                If objcotMarhs.StrError <> "" Then
                    strErr = "Respuesta del Servicio Web: " & objcotMarhs.StrError
                    Exit Function
                End If

                OcultaColumnas(2)
                grvSeguro.DataSource = dtsRes.Tables(0)
                grvSeguro.DataBind()

                ViewState("dtsREcibos") = dtsRes.Tables(1)


                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


                Dim MulPlazos As DataSet
                Dim Plazo As String
                Dim Monto As Decimal
                Dim Concepto As String
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                MulPlazos = ViewState("MulPlazos")
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                        For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                            Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                            If Concepto = "Pago" Then
                                Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                            End If
                        Next
                    End If
                Next
                objPaq = New clsPaquetes
                objPaq.CargaPaquete(ddlplan.SelectedValue)
                If objPaq.ErrorPaquete = "" Then
                    txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                Else
                    strErr = objPaq.ErrorPaquete
                    Exit Function
                End If
                End If
                celda = 15

                CotizaSeg = True
            Case 5 ''SEGUROS BBVA
                'BUG-PC-168: CGARCIA: 15/03/2018: SE MODIFICA SERVICO DE DAÑOS PARA MULTIMARCA
                dtsRes = New DataSet
                Dim clssegbbva As New clsCotSegBBVA
                Dim clsSegDanios1 As New clsCotSegDanios
                Dim idveh As String = ObtenidVehicle(intbroker, ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue, ddlversion.SelectedValue, ddlanio.SelectedValue)
                Dim ds_getRateCarQuote As New DataTable()
                Dim row_getRateCarQuote As DataRow
                Dim clsParam As New clsParametros
                Dim dtParametros As New DataSet
                Dim dsDatos As New DataSet()
                dsDatos = objParam.ManejaParametro(10)
                'dtParametros = clsParam.ManejaParametro(8)

                If idveh = "" Then
                    strErr = "El producto seleccionado no tiene idenficador para el broker de seguros."
                    Exit Function
                End If

                ValidaMontoAcc()

                Dim brokerid As String = obten_broker()
                If dsDatos.Tables.Count > 0 AndAlso dsDatos.Tables(0).Rows.Count > 0 Then

                    Dim bolLlena As Boolean = False
                    Dim intValue As Integer
                    'BUG-PC-173: CGARCIA: 05/04/2018: SE MODIFICAN ALIANZAS PARA SEGURO A TU MEDIDA
                    For index As Integer = 0 To dsDatos.Tables(0).Rows.Count - 1 Step 1
                        intValue = dsDatos.Tables(0).Rows(index).Item("ID_ALIANZA").ToString()
                        If ddlalianza.SelectedValue = intValue Then

                            bolLlena = True
                        End If
                    Next
                    If bolLlena = True Then
                        ' If ddlalianza.SelectedValue = CInt(dsDatos.Tables(0).Rows(0).Item("ID_ALIANZA")) Then
                        clsSegDanios1.User = Session("usrreg")
                        clsSegDanios1.IdSesion = ViewState("wvsUsr")
                        clsSegDanios1.IdIndeImnizacion = cmbIndemnizacion.SelectedValue.ToString.Trim
                        clsSegDanios1.SubPlan = ddlcobertura.SelectedValue.ToString.Trim
                        clsSegDanios1.MontoCredito = Regex.Replace(txtprecio.Text.Trim, ",", "")
                        clsSegDanios1.ID_DEDUCDAM = cmbDedusibleDaños.SelectedValue.ToString.Trim
                        clsSegDanios1.STR_DEDUCDAM = cmbDedusibleDaños.SelectedItem.Text.Trim({" "c, "%"c})
                        clsSegDanios1.ID_DEDUCROT = cmbDeducibleRoboTotal.SelectedValue.ToString.Trim
                        clsSegDanios1.STR_DEDUCROT = cmbDeducibleRoboTotal.SelectedItem.Text.Trim({" "c, "%"c})

                        clsSegDanios1.CP = txtcprecurrente.Text.Trim
                        clsSegDanios1.ID_AGENCIA = ddlagencia.SelectedValue.ToString() 'BUG-PC-190

                        ds_getRateCarQuote = ViewState("vws_getRateCarQuote")

                        clsParam.Valor = ddlcobertura.SelectedValue.ToString()
                        dtParametros = clsParam.ManejaParametro(8)

                        If dtParametros.Tables.Count > 0 AndAlso dtParametros.Tables(0).Rows.Count > 0 AndAlso dtParametros.Tables(0).Rows(0).Item("RESULTADO") = 1 Then
                            If dtParametros.Tables(1).Rows.Count > 0 Then

                                clsSegDanios1.ID_SACRCB = dtParametros.Tables(1).Rows(0).Item("ID").ToString() 'row_getRateCarQuote.Item("id")
                                clsSegDanios1.STR_SACRCB = dtParametros.Tables(1).Rows(0).Item("TXT_SACRCB").ToString() 'row_getRateCarQuote.Item("name")

                                clsSegDanios1.ID_SACRCP = dtParametros.Tables(1).Rows(0).Item("ID").ToString() 'row_getRateCarQuote.Item("id")
                                clsSegDanios1.STR_SACRCP = dtParametros.Tables(1).Rows(0).Item("TXT_SACRCP").ToString() 'row_getRateCarQuote.Item("name")

                                clsSegDanios1.ID_SACERC = dtParametros.Tables(1).Rows(0).Item("ID").ToString() 'row_getRateCarQuote.Item("id")
                                clsSegDanios1.STR_SACERC = dtParametros.Tables(1).Rows(0).Item("TXT_SACERC").ToString() 'row_getRateCarQuote.Item("name")

                                clsSegDanios1.ID_SACGMO = dtParametros.Tables(1).Rows(0).Item("ID").ToString() 'row_getRateCarQuote.Item("id")
                                clsSegDanios1.STR_SACGMO = dtParametros.Tables(1).Rows(0).Item("TXT_SACGMO").ToString() 'row_getRateCarQuote.Item("name")

                            End If
                        ElseIf dtParametros.Tables.Count > 0 AndAlso dtParametros.Tables(0).Rows.Count > 0 AndAlso dtParametros.Tables(0).Rows(0).Item("RESULTADO") = 0 Then
                            MensajeError("Error al actualizar parametros de cotización.")
                            Exit Function
                        ElseIf dtParametros.Tables.Count > 0 AndAlso dtParametros.Tables(0).Rows.Count > 0 AndAlso dtParametros.Tables(0).Rows(0).Item("RESULTADO") = 2 Then
                            MensajeError("Sin parámentros complemetarios para cotizar.")
                            Exit Function
                        End If

                        dtsRes = clsSegDanios1.CotizaDanios(5, ddlanio.SelectedValue, idveh, ddlversion.SelectedItem.Text.ToString, txtprecio.Text.ToString, ddlplan.SelectedValue, ddlaseguradora.SelectedItem.Text,
                                                            ddlcobertura.SelectedValue, ddledoseg.SelectedValue, ddledoseg.SelectedItem.Text, ddltiposeg.SelectedValue, ddlcobertura.SelectedItem.Text, SoloAccesorios,
                                                            ddltipounidad.SelectedValue, True)
                    Else

                        clsSegDanios1.User = Session("usrreg")
                        clsSegDanios1.IdSesion = ViewState("wvsUsr")
                        clsSegDanios1.MontoCredito = Regex.Replace(txtprecio.Text.Trim, ",", "")
                        'clsSegDanios1.IdIndeImnizacion = "001"
                        clsSegDanios1.ID_AGENCIA = ddlagencia.SelectedValue.ToString() 'BUG-PC-190 

                        dtsRes = clsSegDanios1.CotizaDanios(5, ddlanio.SelectedValue, idveh, ddlversion.SelectedItem.Text.ToString, txtprecio.Text.ToString, ddlplan.SelectedValue, ddlaseguradora.SelectedItem.Text,
                                                             ddlcobertura.SelectedValue, ddledoseg.SelectedValue, ddledoseg.SelectedItem.Text, ddltiposeg.SelectedValue, ddlcobertura.SelectedItem.Text, SoloAccesorios,
                                                             ddltipounidad.SelectedValue, False)
                    End If

                Else

                    MensajeError("Error al consultar parametros de comparación para seguro de daños.")
                    Exit Function
                End If


                'dtsRes = clssegbbva.CotizaBBVADaños2(5, ddlanio.SelectedValue, idveh, ddlversion.SelectedItem.Text.ToString, txtprecio.Text.ToString, ddlplan.SelectedValue, ddlaseguradora.SelectedValue,
                '                                         ddlcobertura.SelectedValue, ddledoseg.SelectedValue, ddledoseg.SelectedItem.Text, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, SoloAccesorios, ddltipounidad.SelectedValue)
                If clsSegDanios1.StrError <> "" Then
                    strErr = "Respuesta del Servicio Web: " & clsSegDanios1.StrError
                    Exit Function
                End If

                OcultaColumnas(2)
                grvSeguro.DataSource = dtsRes.Tables(0)
                grvSeguro.DataBind()

                ViewState("dtsREcibos") = dtsRes.Tables(1)


                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If

                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, CDbl(Val(txtmtogarantia.Text.Trim)), ddlsegvida.SelectedValue, id_prod)

                Dim MulPlazos As DataSet
                Dim Plazo As String
                Dim Monto As Decimal
                Dim Concepto As String
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                MulPlazos = ViewState("MulPlazos")
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                        For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                            Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                            If Concepto = "Pago" Then
                                Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                            End If
                        Next
                    End If
                Next

                objPaq = New clsPaquetes
                objPaq.CargaPaquete(ddlplan.SelectedValue)
                If objPaq.ErrorPaquete = "" Then
                    txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                Else
                    strErr = objPaq.ErrorPaquete
                    Exit Function
                End If

                CotizaSeg = True

            Case 7 ''CALCÚLO POR FACTOR
                Dim objfactor As New WCF.clsCotSegxFactor()
                Dim dts As New DataSet

                Dim objiva As New SNProcotiza.clsTasasIVA()
                objiva.CargaTasaIVA(ddliva.SelectedValue)
                Dim id_prod As Integer = ObtenProducto()
                Dim totalacc As Double = accesorioXfactor()
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                dts = objfactor.CotizaxFactor(2, ddlaseguradora.SelectedValue, CDbl(txtprecio.Text.Trim), objiva.ValorTasa, CDbl(totalacc),
                                              ddlclasif.SelectedValue, ddlplan.SelectedValue, ddledoseg.SelectedValue, ddlcobertura.SelectedValue,
                                              ddlplazos.SelectedValue, ddltipounidad.SelectedValue, 0, 0, 0, "", 0, mtosegvida, ddltiposeg.SelectedValue, id_prod)

                If objfactor.StrErr <> "" Then
                    strErr = objfactor.StrErr
                    Exit Function
                End If

                OcultaColumnas(2)
                grvSeguro.DataSource = dts.Tables(0)
                grvSeguro.DataBind()

                ViewState("dtsREcibos") = dts.Tables(1)


                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If

                mtosegvida = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                              ddledoseg.SelectedValue, intbroker, cad, CDbl(IIf(txtmtogarantia.Text.Trim = "", 0, txtmtogarantia.Text.Trim)), ddlsegvida.SelectedValue, id_prod)

                Dim MulPlazos As DataSet
                Dim Plazo As String
                Dim Monto As Decimal
                Dim Concepto As String
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                MulPlazos = ViewState("MulPlazos")
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                        For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                            Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                            If Concepto = "Pago" Then
                                Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                            End If
                        Next
                    End If
                Next

                objPaq = New clsPaquetes
                objPaq.CargaPaquete(ddlplan.SelectedValue)
                If objPaq.ErrorPaquete = "" Then
                    txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                Else
                    strErr = objPaq.ErrorPaquete
                    Exit Function
                End If

                CotizaSeg = True

            Case 8, 10 ''Ford-Qualitas
                Dim objfactorFord As New WCF.clsCotSegFordQXFactor()
                Dim dts As New DataSet()

                Dim objiva As New SNProcotiza.clsTasasIVA()
                objiva.CargaTasaIVA(ddliva.SelectedValue)
                Dim id_prod As Integer = ObtenProducto()
                dts = objfactorFord.CotizaFordQxFactor(CDbl(txtprecio.Text.Trim), objiva.ValorTasa, ddledoseg.SelectedValue, ddlaseguradora.SelectedValue,
                                                       ddlclasif.SelectedValue, ddltipounidad.SelectedValue, ddlplan.SelectedValue, id_prod, ddltiposeg.SelectedValue)

                If objfactorFord.StrErr <> "" Then
                    strErr = objfactorFord.StrErr
                    Exit Function
                End If

                OcultaColumnas(2)

                grvSeguro.DataSource = dts.Tables(0)
                grvSeguro.DataBind()

                ViewState("dtsREcibos") = dts.Tables(1)

                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

                Dim MulPlazos As DataSet
                Dim Plazo As String
                Dim Monto As Decimal
                Dim Concepto As String
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                MulPlazos = ViewState("MulPlazos")
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                        For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                            Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                            If Concepto = "Pago" Then
                                Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                            End If
                        Next
                    End If
                Next

                objPaq = New clsPaquetes
                objPaq.CargaPaquete(ddlplan.SelectedValue)
                If objPaq.ErrorPaquete = "" Then
                    txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                Else
                    strErr = objPaq.ErrorPaquete
                    Exit Function
                End If

                CotizaSeg = True
            Case 9 ''SEGUROS BBVA MOTO
                'BUG-PC-168: CGARCIA: 15/03/2018: SE MODIFICA SERVICO DE DAÑOS PARA MULTIMARCA
                dtsRes = New DataSet
                Dim clssegbbva As New clsCotSegBBVA
                Dim clsSegDanios1 As New clsCotSegDanios
                Dim idveh As String = ObtenidVehicle(5, ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue, ddlversion.SelectedValue, ddlanio.SelectedValue)

                If idveh = "" Then
                    strErr = "El producto seleccionado no tiene idenficador para el broker de seguros."
                    Exit Function
                End If

                ValidaMontoAcc()
                'dtsRes = clssegbbva.CotizaBBVADaños2(9, ddlanio.SelectedValue, idveh, ddlversion.SelectedItem.Text.ToString, txtprecio.Text.ToString, ddlplan.SelectedValue, ddlaseguradora.SelectedValue, ddlcobertura.SelectedValue, ddledoseg.SelectedValue, ddledoseg.SelectedItem.Text, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, SoloAccesorios, ddltipounidad.SelectedValue)
                clsSegDanios1.User = Session("usrreg")
                clsSegDanios1.IdSesion = ViewState("wvsUsr")
                clsSegDanios1.MontoCredito = Regex.Replace(txtprecio.Text.Trim, ",", "")
                'clsSegDanios1.IdIndeImnizacion = "001"
                clsSegDanios1.ID_AGENCIA = ddlagencia.SelectedValue.ToString() 'BUG-PC-190

                dtsRes = clsSegDanios1.CotizaDanios(9, ddlanio.SelectedValue, idveh, ddlversion.SelectedItem.Text.ToString, txtprecio.Text.ToString, ddlplan.SelectedValue, ddlaseguradora.SelectedItem.Text,
                                                     ddlcobertura.SelectedValue, ddledoseg.SelectedValue, ddledoseg.SelectedItem.Text, ddltiposeg.SelectedValue, ddlcobertura.SelectedItem.Text, SoloAccesorios,
                                                     ddltipounidad.SelectedValue, False)
                If clsSegDanios1.StrError <> "" Then
                    strErr = "Respuesta del Servicio Web: " & clsSegDanios1.StrError
                    Exit Function
                End If

                OcultaColumnas(2)
                grvSeguro.DataSource = dtsRes.Tables(0)
                grvSeguro.DataBind()

                ViewState("dtsREcibos") = dtsRes.Tables(1)


                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If

                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, CDbl(Val(txtmtogarantia.Text.Trim)), ddlsegvida.SelectedValue, id_prod)

                Dim MulPlazos As DataSet
                Dim Plazo As String
                Dim Monto As Decimal
                Dim Concepto As String
                objPlazos.CargaPlazo(ddlplazos.SelectedValue)

                MulPlazos = ViewState("MulPlazos")
                For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                    Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                    If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                        For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                            Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                            If Concepto = "Pago" Then
                                Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                            End If
                        Next
                    End If
                Next

                objPaq = New clsPaquetes
                objPaq.CargaPaquete(ddlplan.SelectedValue)
                If objPaq.ErrorPaquete = "" Then
                    txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
                Else
                    strErr = objPaq.ErrorPaquete
                    Exit Function
                End If

                CotizaSeg = True

        End Select

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        Dim valor As Integer = objPlazos.Valor

        If (intbroker <> 2 And (IIf(intbroker = 4, IIf(usaMulticotiza <> 1, True, False), True))) Then ''Validacion para Ordas 'RQ-PC5 se incluye multicotizacion Marsh
            For i = 0 To grvSeguro.Rows.Count - 1
                Dim _Chk As New CheckBox
                _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")

                If valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then

                    If Val(grvSeguro.Rows(i).Cells(15).Text) = 0 Then
                        _Chk.Enabled = False
                        _Chk.Checked = False
                        strErr = "Debe seleccionar un plazo valido, el Broker no regreso valor de ID_COTIZACION."
                        Continue For
                    Else
                        _Chk.Enabled = False
                        _Chk.Checked = True
                    End If
                Else
                    _Chk.Enabled = False
                    _Chk.Checked = False
                    If Val(grvSeguro.Rows(i).Cells(15).Text) = 0 Then
                        strErr = "En la respuesta del broker existe(n) algún(os) plazo(s) no valido(s). Favor de validar."
                    End If
                End If
            Next
        End If

        OcultaColumnas(1)

        If strErr.Length > 0 Then
            MensajeError(strErr)
        End If

    End Function

    Private Function GuardaSeg(IDCot As Integer) As Boolean
        GuardaSeg = False

        Dim _ObjSeg As New SNProcotiza.clsSeguro
        Dim objPromocte As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)

        Try
            OcultaColumnas(2)
            objIva.CargaTasaIVA(ddliva.SelectedValue)
            Dim intbroker As Integer = obten_broker()
            If intbroker = 7 And (ddlaseguradora.SelectedValue = 63 Or ddlaseguradora.SelectedValue = 117) And (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then ''BUG-PC-61

                _ObjSeg.IDAseguradora = ddlaseguradora.SelectedValue
                _ObjSeg.Precio = CDbl(txtprecio.Text.Trim)
                _ObjSeg.MontoAcc = CDbl(lbltotalacc.Text)
                _ObjSeg.IVA = objIva.ValorTasa
                _ObjSeg.IDClasif = ddlclasif.SelectedValue
                _ObjSeg.IDPaquete = ddlplan.SelectedValue
                _ObjSeg.IDEstado = ddledoseg.SelectedValue
                _ObjSeg.IDCobertura = ddlcobertura.SelectedValue
                _ObjSeg.IDPlazo = ddlplazos.SelectedValue
                _ObjSeg._intClaveCotizacion = IDCot
                If ddlsegvida.SelectedValue <> 172 Then
                    _ObjSeg._decSegVida = CDec(Session("montoSegVida"))
                    _ObjSeg._strNumCotizacionvida = Session("idquotevida").ToString
                    _ObjSeg._SEG_DS_NOM_COT_AUTO_BBVA = 0
                Else
                    _ObjSeg._decSegVida = 0
                End If
                If objPromocte.IDPROMOCION = 1 Then
                    _ObjSeg._IntAnioGratis = 0
                Else
                    _ObjSeg._IntAnioGratis = 1
                End If

                If objPromocte.IDPROMOCION = 1 And objPlazos.Valor <= objPaq.noperiodos Then
                    MensajeError("El plazo seleccionado no aplica para la promoción " & objPromocte.DESCRIPCION & ".")
                    Exit Function
                End If
                _ObjSeg.intProducto = ObtenProducto()
                _ObjSeg._IntSegDanios = ddltiposeg.SelectedValue
                _ObjSeg.ManejaSeguro(6)

                If _ObjSeg.ErrorSeguro = "" Then
                    GuardaSeg = True

                    _ObjSeg._intClaveCotizacion = IDCot
                    _ObjSeg.ManejaSeguro(1)

                    If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                        If Not GuardaDetSeg(_ObjSeg._intClaveSeguro) Then
                            MensajeError(strErr)
                            Exit Function
                        End If
                    End If
                    Dim cad As String = String.Empty
                    If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                        For j As Integer = 0 To grvSeguro.Rows.Count - 1
                            cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                        Next
                    End If

                    Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                    Dim id_prod As Integer = ObtenProducto()
                    LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                        ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                        CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                        IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                        ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                    0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                  ddledoseg.SelectedValue, intbroker, cad, CDbl(IIf(txtmtogarantia.Text.Trim = "", 0, txtmtogarantia.Text.Trim)), ddlsegvida.SelectedValue, id_prod)
                    Exit Function
                Else
                    strErr = _ObjSeg.ErrorSeguro
                    Exit Function
                End If
            End If


            Dim dsDataSet As New DataSet


            Dim _Chk As New CheckBox
            ''Dim _IdPlazo As Integer = 0
            ''Dim IdPlazoGV As Integer = 0
            Dim _contador As Integer = 0
            Dim _MontoSeguro As Decimal = 0.0
            Dim _MontoSeguro1 As Decimal = 0.0
            Dim _MontoSeguro2 As Decimal = 0.0
            Dim _MontoSeguro3 As Decimal = 0.0
            Dim _IdPaquete As Integer = 0
            Dim _CveCotSeguro As Integer = 0

            prodid = ObtenProducto()
            objProd.CargaProducto(prodid)
            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            objAge.CargaAgencia(ddlagencia.SelectedValue)
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)

            Dim mesAdicional As Integer = 0 ''Para cuando se agrega un mes mas en el plazo para los calculos solo In-Credit

            _ObjSeg._intClaveCotizacion = Val(Session("IDCot"))
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                _ObjSeg._ID_USO = ddluso.SelectedValue
                _ObjSeg.IDEstado = ddledoseg.SelectedValue
                For i = 0 To grvSeguro.Rows.Count - 1
                    If grvSeguro.Rows(i).RowType = DataControlRowType.DataRow Then

                        _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")
                        If Not _Chk Is Nothing AndAlso _Chk.Checked = True Then

                            _ObjSeg._decSegPrimaNeta = (CDec(grvSeguro.Rows(i).Cells(2).Text)) '* (objPlazos.Valor)
                            _ObjSeg._decSegRecargo = CDec(grvSeguro.Rows(i).Cells(3).Text)
                            _ObjSeg._decSegDerecho = CDec(grvSeguro.Rows(i).Cells(4).Text)
                            _ObjSeg._decSegIva = CDec(grvSeguro.Rows(i).Cells(5).Text)
                            '_ObjSeg._decSegIva = ((_ObjSeg._decSegPrimaNeta + _ObjSeg._decSegRecargo + _ObjSeg._decSegDerecho) * (objIva.ValorTasa / 100))
                            If intbroker = 8 Or intbroker = 10 Then
                                _ObjSeg._decSegPrimaTotal = (_ObjSeg._decSegPrimaNeta + _ObjSeg._decSegIva + _ObjSeg._decSegRecargo)
                            Else
                                _ObjSeg._decSegPrimaTotal = (_ObjSeg._decSegPrimaNeta + _ObjSeg._decSegIva + _ObjSeg._decSegRecargo + _ObjSeg._decSegDerecho)
                            End If

                            _ObjSeg._strSegAseguradora = grvSeguro.Rows(i).Cells(7).Text
                            _ObjSeg._strNumCotizacion = grvSeguro.Rows(i).Cells(15).Text
                            '_ObjSeg._decSegPrimaNGap = (CDec(grvSeguro.Rows(i).Cells(11).Text)) * (objPlazos.Valor + mesAdicional)
                            _ObjSeg._decSegPrimaNGap = (CDec(IIf(IsNumeric(grvSeguro.Rows(i).Cells(11).Text) = False, 0.0, grvSeguro.Rows(i).Cells(11).Text))) '* (objPlazos.Valor + mesAdicional)
                            '_ObjSeg._decSegIvaGap = (CDec(grvSeguro.Rows(i).Cells(12).Text)) * (objPlazos.Valor + mesAdicional)
                            _ObjSeg._decSegIvaGap = (CDec(IIf(IsNumeric(grvSeguro.Rows(i).Cells(12).Text) = False, 0.0, grvSeguro.Rows(i).Cells(12).Text))) '* (objPlazos.Valor + mesAdicional)
                            '_ObjSeg._decSegPrimaTotalGap = (CDec(grvSeguro.Rows(i).Cells(13).Text)) * (objPlazos.Valor + mesAdicional)
                            _ObjSeg._decSegPrimaTotalGap = (CDec(IIf(IsNumeric(grvSeguro.Rows(i).Cells(13).Text) = False, 0.0, grvSeguro.Rows(i).Cells(13).Text))) '* (objPlazos.Valor + mesAdicional)


                            If ddlsegvida.SelectedValue <> 172 Then
                                _ObjSeg._decSegVida = CDec(Session("montoSegVida"))
                                _ObjSeg._strNumCotizacionvida = Session("idquotevida").ToString
                                _ObjSeg._SEG_DS_NOM_COT_AUTO_BBVA = 0 'Session("idpolBBVA").ToString
                            Else
                                _ObjSeg._decSegVida = (CDec(IIf(IsNumeric(grvSeguro.Rows(i).Cells(14).Text) = False, 0.0, grvSeguro.Rows(i).Cells(14).Text)))
                            End If
                            '* (objPlazos.Valor + mesAdicional)


                            _IdPaquete = CInt(grvSeguro.Rows(i).Cells(1).Text)
                            If objPromocte.IDPROMOCION = 1 Then
                                _ObjSeg._IntAnioGratis = 0
                            Else
                                _ObjSeg._IntAnioGratis = 1
                            End If

                            If objPromocte.IDPROMOCION = 1 And objPlazos.Valor <= objPaq.noperiodos Then
                                MensajeError("El plazo seleccionado no aplica para la promoción " & objPromocte.DESCRIPCION & ".")
                                Exit Function
                            End If

                            '_ObjSeg._decPrimaTotalSG = grvSeguro.Rows(i).Cells(17).Text
                            _ObjSeg._decPrimaTotalSG = IIf(IsNumeric(grvSeguro.Rows(i).Cells(17).Text) = False, 0.0, grvSeguro.Rows(i).Cells(17).Text)
                            'Finaliza Monto Plazos seguros
                            _MontoSeguro = _MontoSeguro + _ObjSeg._decSegPrimaTotal + _ObjSeg._decSegPrimaTotalGap + _ObjSeg._decSegVida
                            'Inicia Monto Plazos seguros
                            Dim mtoseg As Decimal

                            If (ddltiposeg.SelectedValue = 76 And objPlazos.Valor = 12) Then
                                mtoseg = 0
                            Else
                                mtoseg = _ObjSeg._decSegPrimaTotal '/ (objPlazos.Valor / 12)
                            End If

                            _MontoSeguro1 = mtoseg
                            _ObjSeg._decSegPrimaTotal1 = mtoseg
                            _ObjSeg._decSegPrimaNeta1 = _ObjSeg._decSegPrimaTotal1 / (1 + (objIva.ValorTasa / 100))
                            _ObjSeg._decSegIva1 = _ObjSeg._decSegPrimaTotal1 - (_ObjSeg._decSegPrimaTotal1 / (1 + (objIva.ValorTasa / 100)))

                            If objPlazos.Valor > 12 Then
                                _MontoSeguro2 = mtoseg
                                _ObjSeg._decSegPrimaTotal2 = mtoseg
                                _ObjSeg._decSegPrimaNeta2 = _ObjSeg._decSegPrimaTotal1 / (1 + (objIva.ValorTasa / 100))
                                _ObjSeg._decSegIva2 = _ObjSeg._decSegPrimaTotal1 - (_ObjSeg._decSegPrimaTotal1 / (1 + (objIva.ValorTasa / 100)))
                            Else
                                _MontoSeguro2 = 0
                                _ObjSeg._decSegPrimaTotal2 = 0
                                _ObjSeg._decSegPrimaNeta2 = 0
                                _ObjSeg._decSegIva2 = 0
                            End If

                            If objPlazos.Valor > 24 Then
                                _MontoSeguro3 = mtoseg
                                _ObjSeg._decSegPrimaTotal3 = mtoseg
                                _ObjSeg._decSegPrimaNeta3 = _ObjSeg._decSegPrimaTotal1 / (1 + (objIva.ValorTasa / 100)) '
                                _ObjSeg._decSegIva3 = _ObjSeg._decSegPrimaTotal1 - (_ObjSeg._decSegPrimaTotal1 / (1 + (objIva.ValorTasa / 100)))
                            Else
                                _MontoSeguro3 = 0
                                _ObjSeg._decSegPrimaTotal3 = 0
                                _ObjSeg._decSegPrimaNeta3 = 0
                                _ObjSeg._decSegIva3 = 0
                            End If
                            'Finaliza Monto Plazos seguros
                            _contador = _contador + 1
                        End If
                    End If
                Next

                If _contador = 0 Then
                    MensajeError("No a seleccionado ningun registro.")
                    finseg.Visible = True
                    Exit Function
                ElseIf _contador > 1 Then
                    grvSeguro.Enabled = True
                    MensajeError("Solo se debe seleccionar un registro.")
                    Exit Function
                Else
                    _CveCotSeguro = _ObjSeg._intClaveSeguro
                End If
                'BBVA-P-412

                'With objWS
                '    .Usuario = "INCREDIT"
                '    .Password = "INCREDIT"
                '    .ID_PAQUETE = _IdPaquete
                '    .ID_ESTADO = ddledoseg.SelectedValue
                '    .ID_NUEVAS = 1
                '    .ID_EMPLEADO = 1
                '    .ID_PLAZO = objPlazos.Valor
                '    .ID_TIPO_UNIDAD = ddltipounidad.SelectedValue
                '    .ID_USO = ddluso.SelectedValue
                '    .ID_DESCRIPCION = CInt(objProd.IDExterno)
                '    .MODELO = objProd.AñoModelo
                '    .NUMERO_AGENCIA = 100 ''objAge.IDAgencia
                '    .ID_ASEGURADORA = 0
                '    .ID_FORMA_PAGO = 2
                '    .SUMA_ASEGURADA = CDbl(txtprecio.Text.Trim)
                '    .SUMA_ACCESORIO = CDbl(lbltotalacc.Text)
                '    .SUMA_EQUIPO_ESPECIAL = 0
                '    .ID_TIPO_IVA = 2
                '    .ID_CLIENTE = objPromocte.IDCLIENTE
                '    .PRIMA_TOTAL = _ObjSeg._decSegPrimaTotal
                '    .NUMERO_CREDITO = Val(Session("IDCot")) ''IDCot Session("idpoliza")
                '    .SALDO_INSOLUTO = CDbl(txtprecio.Text.Trim) - CDbl(txtenganche.Text.Trim)
                '    .ID_TIPO_PERSONA = ddlpj.SelectedValue
                '    .ID_OPERACION = IIf(ddltoperacion.SelectedValue = 1, ddltoperacion.SelectedValue, 4)
                '    .ID_COTIZACION_REF = _ObjSeg._strNumCotizacion
                '    .ID_PROMOCION = objPromocte.IDEXTERNO
                '    .MESES = objPaq.noperiodos
                'End With

                'dsDataSet = objWSCot.envia_cotizacion2(objWS)
                'If UCase(dsDataSet.DataSetName) = "ERROR" Then
                '    MensajeError(dsDataSet.Tables(0).Rows(0).Item(0).ToString)
                '    GuardaSeg = False
                '    Exit Function
                'End If

            Else ''Seguro por cuenta del cliente
                _ObjSeg._decSegPrimaNeta = 0
                _ObjSeg._decSegRecargo = 0
                _ObjSeg._decSegDerecho = 0
                _ObjSeg._decSegIva = 0
                _ObjSeg._decSegPrimaTotal = 0
                _ObjSeg._strSegAseguradora = "POR CUENTA DEL CLIENTE"
                _ObjSeg._strNumCotizacion = 0
                If ddlsegvida.SelectedValue <> 172 Then
                    _ObjSeg._SEG_DS_NOM_COT_AUTO_BBVA = 0 ' Session("idpolBBVA").ToString
                Else
                    _ObjSeg._SEG_DS_NOM_COT_AUTO_BBVA = 0
                End If

                _ObjSeg._decSegPrimaNGap = 0
                _ObjSeg._decSegIvaGap = 0
                _ObjSeg._decSegPrimaTotalGap = 0
                If ddlsegvida.SelectedValue <> 172 Then
                    _ObjSeg._decSegVida = CDec(Session("montoSegVida"))
                    _ObjSeg._strNumCotizacionvida = Session("idquotevida").ToString
                Else
                    _ObjSeg._decSegVida = 0
                End If
                _IdPaquete = 0
                _ObjSeg._IntAnioGratis = 0
                _MontoSeguro = 0
                _MontoSeguro1 = 0
                _ObjSeg._decSegPrimaTotal1 = 0
                _MontoSeguro2 = 0
                _ObjSeg._decSegPrimaTotal2 = 0
                _MontoSeguro3 = 0
                _ObjSeg._decSegPrimaTotal3 = 0
                _ObjSeg._intClaveSeguro = 0
            End If

            If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) And (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                _ObjSeg.EdadRec = txtedad.Text.Trim
                _ObjSeg.SexoRec = IIf(rdbsexh.Checked, 6, 5)
                _ObjSeg.NombreRec = txtconductor.Text.Trim.ToUpper
                _ObjSeg.CodigoPostal = txtcprecurrente.Text.Trim
            End If

            _ObjSeg.IDCobertura = ddlcobertura.SelectedValue

            _ObjSeg.ManejaSeguro(2)
            If _ObjSeg.ErrorSeguro <> "" Then
                MensajeError(_ObjSeg.ErrorSeguro)
                Exit Function
            End If

            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                If Not GuardaDetSeg(_ObjSeg._intClaveSeguro) Then
                    MensajeError(strErr)
                    Exit Function
                End If
            End If


            OcultaColumnas(1)
            GuardaSeg = True

        Catch ex As Exception
            OcultaColumnas(1)
            MensajeError(ex.Message)
            GuardaSeg = False
        End Try
    End Function

    Private Function ObtenProducto() As Integer
        Dim ProductoID As Integer = 0
        Dim objProdID As New SNProcotiza.clsProductos
        Dim dts As New DataSet

        objProdID.IDMarca = ddlmarca.SelectedValue
        objProdID.IDSubmarca = ddlmodelo.SelectedValue
        objProdID.IDVersion = ddlversion.SelectedValue
        objProdID.IDAnio = ddlanio.SelectedValue
        objProdID.IDClasificacion = ddlclasif.SelectedValue
        objProdID.IDEstatus = 2 'BUG-PC-196
        dts = objProdID.ManejaProducto(1)

        If objProdID.ErrorProducto = "" Then
            If dts.Tables(0).Rows.Count > 0 Then
                ProductoID = dts.Tables(0).Rows(0).Item("ID_PRODUCTO")
            End If
        Else
            strErr = objProdID.ErrorProducto
            Return Nothing
            Exit Function
        End If

        Return ProductoID
    End Function
    Private Function ObtenDatProducto() As DataSet
        Dim ProductoID As Integer = 0
        Dim objProdID As New SNProcotiza.clsProductos
        Dim dts As New DataSet

        objProdID.IDMarca = ddlmarca.SelectedValue
        objProdID.IDSubmarca = ddlmodelo.SelectedValue
        objProdID.IDVersion = ddlversion.SelectedValue
        objProdID.IDAnio = ddlanio.SelectedValue
        objProdID.IDClasificacion = ddlclasif.SelectedValue
        objProdID.IDEstatus = 2 'BUG-PC-196
        dts = objProdID.ManejaProducto(1)

        If objProdID.ErrorProducto <> "" Then
            strErr = objProdID.ErrorProducto
            Return Nothing
            Exit Function
        End If

        Return dts
    End Function

    Protected Sub ddlversion_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlversion.SelectedIndexChanged
        Dim datos(0 To 5) As Integer

        ' ''Año
        'datos(0) = ddlmarca.SelectedValue
        'datos(1) = ddlagencia.SelectedValue
        'datos(2) = ddlmodelo.SelectedValue
        'datos(3) = ddlversion.SelectedValue
        'objCombo.LlenaObjs(ddlanio, datos)
        'If ddlanio.SelectedValue = 0 Then
        '    divfinadic.Visible = False
        '    limpiaobjs("dropdownlist", ddlanio)
        '    limpiaobjs("textbox", ddlanio)
        '    limpiaobjs("label", ddlanio)
        '    MensajeError("No se encontro información de Productos con los parámetros proporcionados.")
        '    Exit Sub
        'End If

        ' ''Combo Clasificación
        'ReDim datos(4)
        'datos(0) = ddlagencia.SelectedValue
        'datos(1) = ddlmarca.SelectedValue
        'datos(2) = ddlmodelo.SelectedValue
        'datos(3) = ddlversion.SelectedValue
        'datos(4) = ddlanio.SelectedValue
        'objCombo.LlenaObjs(ddlclasif, datos)
        'If ddlclasif.SelectedValue = 0 Then
        '    divfinadic.Visible = False
        '    limpiaobjs("dropdownlist", ddlclasif)
        '    limpiaobjs("textbox", ddlclasif)
        '    limpiaobjs("label", ddlclasif)
        '    MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
        '    Exit Sub
        'End If

        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.PermitePagosEspeciales = 1 Then
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = True
            tbPagosEspeciales.Visible = True
        Else
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = False
            tbPagosEspeciales.Visible = False
        End If

        'ddlplan_SelectedIndexChanged(ddlplan, Nothing)s

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If


        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False

        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()

        'BUG-PC-27 MAUT 23/12/2016 Compra Inteligente
        Dim dtsRes As New DataSet
        objPaq.IDPaquete = ddlplan.SelectedValue
        objPaq.IDVersion = ddlversion.SelectedValue
        objPaq.IDPlazo = ddlplazos.SelectedValue
        dtsRes = objPaq.ManejaPaquete(50)
        If objPaq.ErrorPaquete = "" Then
            If dtsRes.Tables(0).Rows.Count Then
                txtporeng.Text = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                lblengmin.Text = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                txtporresidual.Text = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")
                txtresidual.Text = Val((CDbl(dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            MensajeError(objPaq.ErrorPaquete)
            Exit Sub
        End If

    End Sub

    Protected Sub ddlanio_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlanio.SelectedIndexChanged
        Dim datos(0 To 4) As Integer
        Dim dtsRes As New DataSet

        ''Version 
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString("###,##0.00")
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString("###,##0.00")
                    divmtogarantia.Visible = False
                    ddlGarantia.Enabled = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.PermitePagosEspeciales = 1 Then
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = True
            tbPagosEspeciales.Visible = True
        Else
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = False
            tbPagosEspeciales.Visible = False
        End If

        'ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False

        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)


        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
    End Sub

    Protected Sub ddlmarca_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlmarca.SelectedIndexChanged
        Dim datos(0 To 2) As Integer

        ''Combo SubMarca
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmodelo, datos)
        If ddlmodelo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmodelo)
            limpiaobjs("textbox", ddlmodelo)
            limpiaobjs("label", ddlmodelo)
            MensajeError("No se encontro información de SubMarcas con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año 
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Version
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    divmtogarantia.Visible = False
                    ddlGarantia.Enabled = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.PermitePagosEspeciales = 1 Then
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = True
            tbPagosEspeciales.Visible = True
        Else
            chkPagosEsp.Enabled = False
            chkPagosEsp.Checked = False
            tbPagosEspeciales.Visible = False
        End If


        'ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If


        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False

        End If

        'MAPH 17/03/17 BUG-PC-49 Visibilidad y deshabilitacion de cajas de texto de subsidio
        VerificaSubsidio(objPaq)



        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
        Dim brokerid As String = obten_broker()
        'RQ-PC5
        'BUG-PC-191 BUG-PC-193
        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) OrElse (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
            dvrecurrecte.Visible = True
            dvcodpostal.Visible = True
        Else
            dvrecurrecte.Visible = False
            dvcodpostal.Visible = False
        End If

    End Sub
    Private Sub ObtenTasa36_72(id_plazo As Integer)

        Dim dtsRes As New DataSet
        objPlazos.IDPaquete = ddlplan.SelectedValue
        objPlazos.Id_Plazo = id_plazo 'plazo 
        dtsRes = objPlazos.ManejaPlazos(6)
        If objPlazos.StrErrPlazo = "" Then
            If (Not IsDBNull(dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL_DOS"))) Then
                txt36m.Text = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL_DOS")
            Else
                txt36m.Text = ""
            End If


        Else
            MensajeError("No se encontro información de la tasa para el plazo.")
            Exit Sub
        End If



    End Sub
    Private Function ObtenTasa36_72_(plazo As Integer, idpaquete As Integer) As Double()
        Dim ArD() As Double
        ReDim ArD(1)
        Dim dtsRes As New DataSet
        objPlazos.IDPaquete = idpaquete
        objPlazos.Id_Plazo = plazo 'plazo
        dtsRes = objPlazos.ManejaPlazos(6)
        If objPlazos.StrErrPlazo = "" Then
            If Not IsDBNull(dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL_DOS")) Then
                ArD(0) = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL_DOS")
            Else
                ArD(0) = 0
            End If
            If Not IsDBNull(dtsRes.Tables(0).Rows(0).Item("PTJ_SERV_FINAN_DOS")) Then
                ArD(1) = dtsRes.Tables(0).Rows(0).Item("PTJ_SERV_FINAN_DOS")
        Else
                ArD(1) = 0
            End If
            Return ArD
        Else
            Return Nothing
        End If

    End Function
    Private Function ObtenTasa() As Double
        Dim tasa As Double = 0
        Dim dtsRes As New DataSet
        Dim intTipoCalculo As Integer

        objPlazos.IDPaquete = ddlplan.SelectedValue
        objPlazos.Id_Plazo = ddlplazos.SelectedValue
        dtsRes = objPlazos.ManejaPlazos(6)
        'intTipoCalculo = dtsRes.Tables(0).Rows(0).Item("ID_TIPO_CALCULO")
        'ViewState("vwsTipoCalculo") = dtsRes.Tables(0).Rows(0).Item("ID_TIPO_CALCULO")
        If objPlazos.StrErrPlazo = "" Then
            If dtsRes.Tables(0).Rows.Count > 0 Then

                txtporeng.Text = dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN")
                txttasa.Text = dtsRes.Tables(0).Rows(0).Item("TASA_NOMINAL")
                lblengmin.Text = dtsRes.Tables(0).Rows(0).Item("PTJ_ENGANCHE_MIN")
            Else
                MensajeError("No se encontro información de la tasa.")
                Return Nothing
                Exit Function
            End If
        Else
            MensajeError(objPlazos.StrErrPlazo)
            Return Nothing
            Exit Function
        End If


        If Not ViewState("MulPlazosMerge") Is Nothing Then
            dst.Tables.Add(ViewState("MulPlazosMerge"))
            If dst.Tables(0).Rows.Count > 0 Then
                For x = 0 To dst.Tables(0).Rows.Count - 1
                    If Val(ddlplazos.SelectedItem.Text) = Val(dst.Tables(0).Rows(x)("Plazo")) Then
                        Me.txttasa.Text = dst.Tables(0).Rows(x)("Tasa")
                    End If
                Next
            End If
        End If



        Return tasa
    End Function

    Protected Sub ddlclasif_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlclasif.SelectedIndexChanged
        Dim datos(0 To 3) As Integer

        'BUG-PC-173: CGARCIA:
        If ddlclasif.SelectedValue = 64 Then
            If cmbIndemnizacion.Items.Count > 0 Then
                cmbIndemnizacion.SelectedValue = "0003"
                cmbIndemnizacion.Enabled = False
            End If
        Else
            cmbIndemnizacion.Enabled = True
        End If


            ''Año 
            ReDim datos(4)
            datos(0) = ddlmarca.SelectedValue
            datos(1) = ddlagencia.SelectedValue
            datos(2) = ddlmodelo.SelectedValue
            datos(3) = ddlclasif.SelectedValue
            objCombo.LlenaObjs(ddlanio, datos)
            If ddlanio.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlanio)
                limpiaobjs("textbox", ddlanio)
                limpiaobjs("label", ddlanio)
                MensajeError("No se encontro información de Años con los parámetros proporcionados.")
                Exit Sub
            End If


            ''Version 
            ReDim datos(5)
            datos(0) = ddlmarca.SelectedValue
            datos(1) = ddlagencia.SelectedValue
            datos(2) = ddlmodelo.SelectedValue
            datos(3) = ddlclasif.SelectedValue
            datos(4) = ddlanio.SelectedValue
            objCombo.LlenaObjs(ddlversion, datos)
            If ddlversion.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlversion)
                limpiaobjs("textbox", ddlversion)
                limpiaobjs("label", ddlversion)
                MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
                Exit Sub
            End If



            ''Precio Producto
            prodid = ObtenProducto()
            objProd.CargaProducto(prodid)
            If objProd.ErrorProducto = "" Then
                Select Case ddlclasif.SelectedValue
                    Case 63 ''Nuevos
                        txtprecio.Text = objProd.Precio.ToString()
                        ddlGarantia.Enabled = True
                        divmtogarantia.Visible = True
                        divmtogarantia.Attributes("class") = "visible"
                    Case 64 ''SemiNuevos
                        txtprecio.Text = objProd.PrecioSemi.ToString()
                        ddlGarantia.Enabled = False
                        divmtogarantia.Visible = False
                        divmtogarantia.Attributes("class") = "hidden"
                End Select
            Else
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlclasif)
                limpiaobjs("textbox", ddlclasif)
                limpiaobjs("label", ddlclasif)
                MensajeError(objProd.ErrorProducto)
            End If

            ''Combo Tasas IVA
            ReDim datos(1)
            datos(0) = 2
            objCombo.LlenaObjs(ddliva, datos)
            If ddliva.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddliva)
                limpiaobjs("textbox", ddliva)
                limpiaobjs("label", ddliva)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If

            ''Combo Monedas Factura
            ReDim datos(1)
            datos(0) = 2
            objCombo.LlenaObjs(ddlmonedafact, datos)
            If ddlmonedafact.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafact)
                limpiaobjs("textbox", ddlmonedafact)
                limpiaobjs("label", ddlmonedafact)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If

            ''Combo de Monedas de cotización derivado del combo de monedas de factura
            If ddlmonedafact.SelectedValue > 0 Then
                ReDim datos(1)
                datos(0) = ddlmonedafact.SelectedValue
                objCombo.LlenaObjs(ddlmonedafin, datos)
                If ddlmonedafin.SelectedValue = 0 Then
                    divfinadic.Visible = False
                    limpiaobjs("dropdownlist", ddlmonedafin)
                    limpiaobjs("textbox", ddlmonedafin)
                    limpiaobjs("label", ddlmonedafin)
                    MensajeError("No existe información de Tasas de IVA.")
                    Exit Sub
                End If
            End If

            ''Paquetes
            ReDim datos(3)
            datos(0) = ddlmonedafin.SelectedValue
            datos(1) = prodid
            datos(2) = ddlagencia.SelectedValue
            datos(3) = ddlclasif.SelectedValue
            objCombo.LlenaObjs(ddlplan, datos)
            If ddlplan.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlplan)
                limpiaobjs("textbox", ddlplan)
                limpiaobjs("label", ddlplan)
                MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
                Exit Sub
            End If

            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.PermitePagosEspeciales = 1 Then
                chkPagosEsp.Enabled = False
                chkPagosEsp.Checked = True
                tbPagosEspeciales.Visible = True
            Else
                chkPagosEsp.Enabled = False
                chkPagosEsp.Checked = False
                tbPagosEspeciales.Visible = False
            End If

            'Para cuando sea, compra inteligente ocultar input y etiqueta  BUG-PC-136
            If objPaq.IDTipoCalculo = 167 Then
                If ddlplazos.SelectedValue = 4 Or ddlplazos.SelectedValue = 6 Then
                    ObtenTasa36_72(ddlplazos.SelectedValue)
                    lblt1.Text = "Tasa" + " 1-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2))).ToString() + " Meses"
                    lblt2.Text = "Tasa " + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) + 1).ToString() + "-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) * 2).ToString() + " Meses"
                    div16.Visible = True
                    txttasa.Visible = True
                    div36m.Visible = True
                    txt36m.Visible = True
                    lbltxt36m.Visible = True
                Else

                    div16.Visible = True
                    txttasa.Visible = True
                    div36m.Visible = False
                    txt36m.Visible = False
                    lblt1.Text = "Tasa "
                    lbltxt36m.Visible = False
                End If
            Else

                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = False
                txt36m.Visible = False
                lblt1.Text = "Tasa "
                lbltxt36m.Visible = False
            End If
            'Para cuando sea, compra inteligente ocultar input y etiqueta

            'Para cuando sea, compra inteligente ocultar input y etiqueta  BUG-PC-136
            If objPaq.IDTipoCalculo = 167 Then
                If ddlplazos.SelectedValue = 4 Or ddlplazos.SelectedValue = 6 Then
                    ObtenTasa36_72(ddlplazos.SelectedValue)
                    lblt1.Text = "Tasa" + " 1-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2))).ToString() + " Meses"
                    lblt2.Text = "Tasa " + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) + 1).ToString() + "-" + (Convert.ToInt16(ddlplazos.SelectedItem.Text.Substring(0, 2)) * 2).ToString() + " Meses"
                    div16.Visible = True
                    txttasa.Visible = True
                    div36m.Visible = True
                    txt36m.Visible = True
                    lbltxt36m.Visible = True

                    'validacion para etiquetas de valor residual, enganche ci
                    div17.Visible = True
                    tdlblresidual.Visible = True
                    tdtxtresidual.Visible = True
                    txtenganche.Enabled = False
                    txtporeng.Enabled = False
                    tdEngancheCI.Visible = True
                    ddlengancheCI.Visible = True
                    'validacion para etiquetas de valor residual, enganche ci


                Else

                    div16.Visible = True
                    txttasa.Visible = True
                    div36m.Visible = False
                    txt36m.Visible = False
                    lblt1.Text = "Tasa "
                    lbltxt36m.Visible = False

                    'validacion para etiquetas de valor residual, enganche ci
                    div17.Visible = False
                    tdlblresidual.Visible = False
                    tdtxtresidual.Visible = False
                    txtenganche.Enabled = True
                    txtporeng.Enabled = True
                    tdEngancheCI.Visible = False
                    ddlengancheCI.Visible = False
                    'validacion para etiquetas de valor residual, enganche ci

                End If
            Else

                div16.Visible = True
                txttasa.Visible = True
                div36m.Visible = False
                txt36m.Visible = False
                lblt1.Text = "Tasa "
                lbltxt36m.Visible = False

                'validacion para etiquetas de valor residual, enganche ci
                div17.Visible = False
                tdlblresidual.Visible = False
                tdtxtresidual.Visible = False
                txtenganche.Enabled = True
                txtporeng.Enabled = True
                tdEngancheCI.Visible = False
                ddlengancheCI.Visible = False
                'validacion para etiquetas de valor residual, enganche ci

            End If
            'Para cuando sea, compra inteligente ocultar input y etiqueta

            VerificaSubsidio(objPaq)

            'ddlplan_SelectedIndexChanged(ddlplan, Nothing)

            'Leyenda Promoción
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.IDPROMOCION <> 1 Then
                Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
                If objPromo.ErrorPromociono = "" Then
                    lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
                End If
            Else
                lblpromoleyenda.Text = ""
            End If

            ''Plazos
            ReDim datos(1)
            datos(0) = ddlplan.SelectedValue
            objCombo.LlenaObjs(ddlplazos, datos)
            If ddlplazos.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlplazos)
                limpiaobjs("textbox", ddlplazos)
                limpiaobjs("label", ddlplazos)
                MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If
        VerificaSubsidio(objPaq)

        'Compra Inteligente
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then

            div17.Visible = True
            tdlblresidual.Visible = True
            tdtxtresidual.Visible = True
            txtenganche.Enabled = False
            txtporeng.Enabled = False
            tdEngancheCI.Visible = True
            ddlengancheCI.Visible = True

            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            div17.Visible = False
            tdlblresidual.Visible = False
            tdtxtresidual.Visible = False
            txtenganche.Enabled = True
            txtporeng.Enabled = True
            tdEngancheCI.Visible = False
            ddlengancheCI.Visible = False

        End If

            ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
            ObtenTasa()
            CalculaEnganche(0)
            'ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
            ''Tipos Operación
            ReDim datos(1)
            datos(0) = ddlplan.SelectedValue
            objCombo.LlenaObjs(ddltoperacion, datos)
            If ddltoperacion.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddltoperacion)
                limpiaobjs("textbox", ddltoperacion)
                limpiaobjs("label", ddltoperacion)
                MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
                Exit Sub
            End If

            ''Combo Personalidad Jurídica
            ReDim datos(1)
            datos(0) = ddlplan.SelectedValue
            objCombo.LlenaObjs(ddlpj, datos)
            If ddlpj.SelectedValue = 0 Then
                divfinadic.Visible = False
                MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
                Exit Sub
            End If
            ddlpj_SelectedIndexChanged(ddlpj, Nothing)

            ''Combo Giros
            ReDim datos(2)
            datos(0) = 2
            datos(1) = ddltoperacion.SelectedValue
            objCombo.LlenaObjs(ddlgiro, datos)

            divfinadic.Visible = True
            CargaCombos2()
    End Sub

    Private Sub limpiaobjs(tipoobj As String, Optional obj As Object = 0)
        Dim objetos() As Object
        Dim index As Integer = 0
        Dim totalobj As Integer = 0
        ''ReDim objetos(10)

        Select Case tipoobj
            Case "dropdownlist"
                ReDim objetos(14)
                objetos(0) = ddlejecutivo
                objetos(1) = ddlvendedor
                objetos(2) = ddlmarca
                objetos(3) = ddlmodelo
                objetos(4) = ddlclasif
                objetos(5) = ddlanio
                objetos(6) = ddlversion
                objetos(7) = ddliva
                objetos(8) = ddlmonedafact
                objetos(9) = ddlmonedafin
                objetos(10) = ddlplan
                objetos(11) = ddltoperacion
                objetos(12) = ddlpj
                objetos(13) = ddlgiro
            Case "textbox"
                If obj.id = "ddlplan" Then
                    ReDim objetos(2)
                    objetos(0) = txtenganche
                    objetos(1) = txtporeng
                    objetos(2) = txttasa
                Else
                    ReDim objetos(3)
                    objetos(0) = txtprecio
                    objetos(1) = txtenganche
                    objetos(2) = txtporeng
                    objetos(3) = txttasa
                End If

            Case "label"
                ReDim objetos(1)
                objetos(0) = lblengmin
                objetos(1) = lblpromoleyenda
        End Select


        Select Case tipoobj
            Case "dropdownlist"
                Select Case obj.id
                    Case "ddlejecutivo"
                        index = 0
                        totalobj = 12
                    Case "ddlvendedor"
                        index = 1
                        totalobj = 12
                    Case "ddlmarca"
                        index = 2
                        totalobj = 12
                    Case "ddlmodelo"
                        index = 3
                        totalobj = 12
                    Case "ddlclasif"
                        index = 4
                        totalobj = 12
                    Case "ddlanio"
                        index = 5
                        totalobj = 12
                    Case "ddlversion"
                        index = 6
                        totalobj = 12
                    Case "ddliva"
                        index = 7
                        totalobj = 12
                    Case "ddlmonedafact"
                        index = 8
                        totalobj = 12
                    Case "ddlmonedafin"
                        index = 9
                        totalobj = 12
                    Case "ddlplan"
                        index = 10
                        totalobj = 12
                    Case "ddltoperacion"
                        index = 11
                        totalobj = 12
                End Select

                For x = index To totalobj
                    objetos(x).Items.Clear()
                    objetos(x).Items.Insert(0, New ListItem("", "0"))
                    objetos(x).AppendDataBoundItems = True
                Next
            Case "textbox"
                If obj.id = "ddlplan" Then
                    index = 0
                    totalobj = 2
                Else
                    index = 0
                    totalobj = 3
                End If

                For x = index To totalobj
                    objetos(x).Text = ""
                Next
            Case "label"
                index = 0
                totalobj = 1

                For x = index To totalobj
                    objetos(x).Text = ""
                Next
        End Select

    End Sub

    Protected Sub ddltoperacion_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddltoperacion.SelectedIndexChanged
        Dim datos(1) As Integer

        ''Combo Personalidad Jurídica
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
    End Sub

    Private Function ValidaPagosEsp() As Boolean
        Dim objTxt As New TextBox
        Dim dblTotPagEsp As Double = 0
        ValidaPagosEsp = False

        If chkPagosEsp.Checked = True Then
            For Each objRow In gdvPagEsp.Rows
                If objRow.Cells(2).Controls.Count > 0 Then
                    objTxt = objRow.Cells(2).Controls(1)
                    If Trim$(objTxt.Text) <> "" Then
                        dblTotPagEsp = dblTotPagEsp + Val(objTxt.Text)
                    End If
                End If
            Next

            If dblTotPagEsp = 0 Then
                strErr = "El monto total de pagos especiales no puede ser $0.00"
                ValidaPagosEsp = False
                Exit Function
            End If

            'se valida que le monto de los pagos especiales no sea mayor al monto a financiar
            If dblTotPagEsp > (((Val(Trim(Replace(Replace(txtprecio.Text, ",", ""), "$", ""))) * Val(txtUniProd.Text.Trim)) + Val(Trim(Replace(Replace(lbltotalacc.Text, ",", ""), "$", "")))) - CDbl(txtenganche.Text.Trim)) Then
                strErr = "El monto total de pagos especiales no puede ser mayor al valor factura menos el enganche"
                ValidaPagosEsp = False
                Exit Function
            End If
        Else
            ValidaPagosEsp = True
            Exit Function
        End If

        ValidaPagosEsp = True
    End Function

    Private Function ValidaMontoAcc() As Boolean
        Dim objTxt As New TextBox
        Dim objddl As New DropDownList  'TryCast(row.FindControl("DropDownList1"), DropDownList)
        Dim dblTotAcc As Double = 0
        Dim NomAcc As New DropDownList
        'CDbl(lbltotalacc.Text)
        ValidaMontoAcc = False

        For Each objRow In grvAccesorios.Rows
            objTxt = objRow.Cells(3).Controls(1)
            objddl = objRow.Cells(2).Controls(1)
            NomAcc = objRow.Cells(1).Controls(1)
            'BUG-PC-90:MPUESTO:10/07/2017:CORRECCIÓN DE VALIDACION DE MONTO DE ACCESORIOS
            If Not NomAcc.SelectedItem Is Nothing AndAlso NomAcc.SelectedItem.ToString.Contains("ACCESORIO") Then
                SoloAccesorios = Val(objTxt.Text)
            End If
            If Trim$(objTxt.Text) <> "" And (objddl.SelectedValue.ToString().Contains("FINANC") Or objddl.SelectedItem.ToString().Contains("FINANC")) Then
                dblTotAcc = dblTotAcc + Val(objTxt.Text)
            End If
        Next
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If dblTotAcc > CDbl(txtprecio.Text.Trim) * (objPaq.PtjMaximoAccesorios / 100) Then
            'BUG-PC-90:MPUESTO:10/07/2017:CAMBIO EN LA LEYENDA DE VALIDACION DE ACCESORIOS
            strErr = "El precio de los accesorios y/o garantía extendida es mayor al porcentaje establecido."
            Exit Function
        End If
        ValidaMontoAcc = True

    End Function
    'Private Function ValidaMontoGarantia(ByVal monto As Double) As Boolean
    'ValidaMontoGarantia = False
    'Dim dblTotAcc As Double = CDbl(lbltotalacc.Text)

    'dblTotAcc = dblTotAcc + monto
    'objPaq = New clsPaquetes
    'objPaq.CargaPaquete(ddlplan.SelectedValue)
    'If dblTotAcc > CDbl(txtprecio.Text.Trim) * (objPaq.PtjMaximoAccesorios / 100) Then
    'strErr = "El precio de los accesorio es mayor al porcentaje establecido."
    'Exit Function
    'End If
    'ValidaMontoGarantia = True
    'End Function

    Private Function ValidaCotizarSeg() As Boolean
        Dim _Chk As New CheckBox
        Dim _contador As Integer = 0

        ValidaCotizarSeg = False

        'If ddltiposeg.SelectedValue = 32 Then
        '    ValidaCotizarSeg = True
        '    Exit Function
        'End If


        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) And (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
            If txtedad.Text.Trim.Length = 0 Or Not IsNumeric(txtedad.Text.Trim) Then
                strErr = "Debe ingresar la edad del conductor recurrente."
                Exit Function
            End If
            If rdbsexh.Checked = False And rdbsexm.Checked = False Then
                strErr = "Debe seleccionar el Genero del conductor recurrente"
                Exit Function
            End If

            If txtcprecurrente.Text.Length < 5 Then
                strErr = "Debe ingresar Código Postal."
                Exit Function
            End If

            If txtconductor.Text.Trim.Length = 0 Then
                strErr = "Debe ingresar el nombre del conductor recurrente."
                Exit Function
            End If
        End If

        'RQ06
        'If ddlaseguradora.SelectedValue = 10 Or ddlaseguradora.SelectedValue = 34 Then
        '    ValidaCotizarSeg = True
        '    Exit Function
        'End If

        'If grvSeguro.Rows.Count > 0 Then
        '    ValidaCotizarSeg = True
        '    Exit Function
        'End If

        If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
            For i = 0 To grvSeguro.Rows.Count - 1
                If grvSeguro.Rows(i).RowType = DataControlRowType.DataRow Then
                    _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")
                    If Not _Chk Is Nothing AndAlso _Chk.Checked = True Then
                        _contador = _contador + 1
                    End If
                End If
            Next

            'BUG-PC-34 MAUT 12/01/2017 Se valida que haya seguro cotizado
            If grvSeguro.Rows.Count = 0 Then
                strErr = "Debe cotizar un tipo de seguro."
                Exit Function
            End If

            If _contador = 0 Then
                strErr = "Debe seleccionar una opción de seguro."
                Exit Function
            ElseIf _contador > 1 Then
                strErr = "Debe seleccionar solo una opción."
            End If
        End If

        If ddlsegvida.SelectedValue <> 172 Then
            If Session("montoSegVida").ToString() = "0.00" Or Session("idquotevida") = "0" Then
                strErr = "Debe cotizar seguro de vida."
                Exit Function
            End If
        End If

        'BUG-PC-183 INI
        Dim brokerid As String = obten_broker()
        If usaMulticotiza = 1 AndAlso brokerid = 4 AndAlso Me.txtcprecurrente.Enabled = True Then
            If Not IsNothing(ViewState("cotCodigoPostal")) AndAlso (Not (ViewState("cotCodigoPostal").ToString().Trim() = Me.txtcprecurrente.Text.Trim)) Then
                strErr = "El Código Postal no corresponde con la cotización del seguro."
                Exit Function
            End If
        End If
        'BUG-PC-183 FIN

        'BUG-PC-183 INI
        'Dim brokerid As String = obten_broker()
        If usaMulticotiza = 1 AndAlso brokerid = 4 AndAlso Me.txtcprecurrente.Enabled = True Then
            If Not IsNothing(ViewState("cotCodigoPostal")) AndAlso (Not (ViewState("cotCodigoPostal").ToString().Trim() = Me.txtcprecurrente.Text.Trim)) Then
                strErr = "El Código Postal no corresponde con la cotización del seguro."
                Exit Function
            End If
        End If
        'BUG-PC-183 FIN

        ValidaCotizarSeg = True
    End Function

    Protected Sub ddlpj_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlpj.SelectedIndexChanged

        If ddlpj.SelectedValue = 15 Then
            trnom2.Visible = False
            trpaterno.Visible = False
            trmaterno.Visible = False
            trnac.Visible = False
            lblnomcte.Text = "Razón Social"    'RQ06
            tooltiprfc.InnerText = "Persona moral: AAA999999XXX"
            Toolnommorfis.InnerText = "Nombre tal y como aparece en el alta de SHCP. "
        Else
            trnom2.Visible = True
            trpaterno.Visible = True
            trmaterno.Visible = True
            trnac.Visible = True
            lblnomcte.Text = "Nombre"  'RQ06
            tooltiprfc.InnerText = "Persona física: AAAA999999XXX"
            Toolnommorfis.InnerText = "Nombre tal y como aparece en la identificación oficial."
        End If

        txtnombrectepf.Text = ""
        txtnombrecte.Text = ""
        txtnombrecte2.Text = ""
        txtpaterno.Text = ""
        txtmaterno.Text = ""
        txtfecnac.Text = ""
        txtrfc.Text = ""
        txtcp.Text = ""
        txttelfijo.Text = ""
        txttelmovil.Text = ""
        txtmail.Text = ""
        Personalidad()

    End Sub

    'BUG-PC-38 MAUT 23/01/2017 Ya no se ocupa
    'Protected Sub txtfecnac_TextChanged(sender As Object, e As System.EventArgs) Handles txtfecnac.TextChanged
    '    Dim objpersona As New clsPersonas
    '    If ddlpj.SelectedValue <> 15 Then
    '        Dim nombre As String = ""
    '        Dim snombre As String = ""
    '        Dim paterno As String = ""
    '        Dim materno As String = ""

    '        'If (txtnombrecte.Text <> "") Then
    '        '    nombre = Replace(txtnombrecte.Text.Trim.ToUpper, "Á", "A").Replace("É", "E").Replace("Í", "I").Replace("Ó", "O").Replace("Ú", "U")
    '        'End If

    '        ''BUG-PC-22 MAUT Se agrega segundo nombre
    '        'If (txtnombrecte2.Text <> "") Then
    '        '    snombre = Replace(txtnombrecte2.Text.Trim.ToUpper, "Á", "A").Replace("É", "E").Replace("Í", "I").Replace("Ó", "O").Replace("Ú", "U")
    '        'End If

    '        'If (txtpaterno.Text <> "") Then
    '        '    paterno = Replace(txtpaterno.Text.Trim.ToUpper, "Á", "A").Replace("É", "E").Replace("Í", "I").Replace("Ó", "O").Replace("Ú", "U")
    '        'End If

    '        'If (txtmaterno.Text <> "") Then
    '        '    materno = Replace(txtmaterno.Text.Trim.ToUpper, "Á", "A").Replace("É", "E").Replace("Í", "I").Replace("Ó", "O").Replace("Ú", "U")
    '        'End If

    '        'If (txtnombrecte.Text <> "" And txtpaterno.Text <> "" And txtmaterno.Text <> "") Then
    '        ''se agrega segundo nombre para calcular correctamente el rfc
    '        'BUG-PC-38 MAUT 23/01/2017 Se quita calculo automatico de RFC
    '        'txtrfc.Text = objpersona.CalculaRFC(paterno, materno, nombre, txtfecnac.Text.Trim, strErr, snombre)
    '        'End If

    'End If
    'End Sub
    Protected Sub txtcp_TextChanged(sender As Object, e As System.EventArgs) Handles txtcp.TextChanged
        Dim longitud As Integer = 5
        If txtcp.Text = "00000" Then
            MensajeError("Código postal incorrecto")
            txtcp.Text = ""
            Exit Sub
        End If
        If Len(Trim$(txtcp.Text)) < longitud Or Not IsNumeric(txtcp.Text) Then
            MensajeError("El código postal debe contener " & longitud.ToString & " caracteres")
            txtcp.Text = ""
            Me.txtcp.Focus()
            Exit Sub
        Else
            If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
                WS()
            End If
        End If
    End Sub
    Private Function GuardaPersonas(IDCot As Integer) As Boolean
        GuardaPersonas = False
        Dim dts As New DataSet

        Try
            Dim objpersona As New clsPersonas

            objpersona.cvePerJuridica = ddlpj.SelectedValue
            If ddlpj.SelectedValue = 16 Then
                objpersona.Nombre = txtnombrecte.Text.Trim.ToUpper
            Else
                objpersona.Nombre = txtnombrectepf.Text.Trim.ToUpper
            End If
            'objpersona.Nombre = txtnombrectepf.Text.Trim.ToUpper
            objpersona.Nombre2 = txtnombrecte2.Text.Trim.ToUpper
            objpersona.Paterno = txtpaterno.Text.Trim.ToUpper
            objpersona.Materno = txtmaterno.Text.Trim.ToUpper

            'BUG-PC-25 MAUT 15/12/2016 Se cambia el formato de fecha
            Dim fecNac As String()
            fecNac = Split(txtfecnac.Text.Trim, "-")
            objpersona.FechaNacimiento = fecNac(2) & "-" & fecNac(1) & "-" & fecNac(0)

            objpersona.RFC = txtrfc.Text.Trim.ToUpper
            objpersona.Mail = txtmail.Text.Trim
            objpersona.CodPost = txtcp.Text.Trim
            objpersona.Estatus = 2
            objpersona.UsuReg = Session("usrreg")
            dts = objpersona.ManejaPersona(2)

            If objpersona.ErrorPersona = "" Then
                idpersona = dts.Tables(0).Rows(0).Item("ID_PERSONA")
            Else
                strErr = objpersona.ErrorPersona
                Exit Function
            End If

            GuardaPersonas = True

        Catch ex As Exception
            strErr = ex.Message
        End Try
    End Function

    Protected Sub ddlalianza_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlalianza.SelectedIndexChanged

        Dim dts As New DataSet
        Dim datos(5) As Integer

       

        ddlgrupo.SelectedValue = -1
        ddldivision.SelectedValue = -1

        objAge.IDAlianza = ddlalianza.SelectedValue
        objAge.IDGrupo = -1
        objAge.IDDivision = -1
        objAge.IDUsuario = iduser
        objAge.IDEstado = ddledo.SelectedValue

        dts = objAge.ManejaAgencia(30)
        If objAge.ErrorAgencia = "" Then
            If dts.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dts, "NOMBRE", "ID_AGENCIA", ddlagencia, strErr, False)
            Else
                ddlagencia.Items.Insert(0, New ListItem("", "0"))
            End If
        End If

        If ddlagencia.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlagencia)
            limpiaobjs("textbox", ddlagencia)
            limpiaobjs("label", ddlagencia)
            MensajeError("No se encontro información de Agencias con los parámetros proporcionados.")
            Exit Sub
        End If

        'Combo Promotores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlejecutivo, datos)
        If ddlejecutivo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlejecutivo)
            limpiaobjs("textbox", ddlejecutivo)
            limpiaobjs("label", ddlejecutivo)
            MensajeError("No se encontro información de F&I.")
            Exit Sub
        End If

        'Combo Vendedores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlvendedor, datos)
        'Cuando el usuario es de perfil vendedor se selecciona solo su usuario en el combo de usuarios
        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
        If objUsuFirma.IDPerfil = 74 Then
            If ddlvendedor.Items.Count > 0 Then
                ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
            End If
        End If

        If ddlvendedor.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlvendedor)
            limpiaobjs("textbox", ddlvendedor)
            limpiaobjs("label", ddlvendedor)
            MensajeError("No se encontro información de Vendedores.")
            Exit Sub
        End If

        ''Combo Marca
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmarca, datos)
        If ddlmarca.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmarca)
            limpiaobjs("textbox", ddlmarca)
            limpiaobjs("label", ddlmarca)
            MensajeError("La Agencia " & ddlagencia.SelectedItem.Text & " no cuenta con Marcas asignadas.")
            Exit Sub
        End If

        ''Combo SubMarca
        ReDim datos(2)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmodelo, datos)
        If ddlmodelo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmodelo)
            limpiaobjs("textbox", ddlmodelo)
            limpiaobjs("label", ddlmodelo)
            MensajeError("No se encontro información de SubMarcas con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año 
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Version
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
        'RQ-PC5
        Dim brokerid As String = obten_broker() 'BUG-PC-191 
        'BUG-PC-193
        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) Or (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
            dvrecurrecte.Visible = True
            dvcodpostal.Visible = True
        Else
            dvrecurrecte.Visible = False
            dvcodpostal.Visible = False
        End If

    End Sub
    'RQ-PI7-PC7: CGARCIA: 27/12/2017: CREACION DE LOS SERVICIOS DE SUBPLANES, INDEMNIZACION Y DEDUCIBLES (comobo de coberturas es subplan) unicamente para seguros bancomer
    Protected Sub ObtenSubplan()

        Dim listResult As New List(Of String)
        Dim clsSub As New clsSubplanes
        Dim listGet As New List(Of clsSubplanes.catalogItemBase)
        Dim dt As New DataTable
        Dim dr As DataRow
        Dim ds As New DataSet()
        Dim idSession As String = Session("usrreg")
        Dim idUser = ViewState("wvsUsr")

        listGet = clsSub.obtieneSubplan(idSession, idUser)

        If IsNothing(listGet) Then

            MensajeError("No se encontro información de subplanes")
            ddlcobertura.Items.Clear()
            Exit Sub
        Else
            dt.Columns.Add("id")
            dt.Columns.Add("name")

            For Each catalogItemBase In listGet

                dr = dt.NewRow()
                dr("id") = catalogItemBase.id.ToString()
                dr("name") = catalogItemBase.name.ToString()
                dt.Rows.Add(dr)

            Next
            ds.Tables.Add(dt)

            ddlcobertura.Items.Clear()
            objCombo.LlenaCombos(ds, "name", "id", ddlcobertura, strErr, True)
            If strErr <> "" Then
                MensajeError(strErr)
                Exit Sub
            End If

        End If

    End Sub
    'RQ-PI7-PC7: CGARCIA: 27/12/2017: CREACION DE LOS SERVICIOS DE SUBPLANES, INDEMNIZACION Y DEDUCIBLES (comobo de coberturas es subplan) unicamente para seguros bancomer
    Protected Sub obtieneDeducibles()
        Dim listResult As New List(Of String)
        Dim clsDec As New clsDeducible
        Dim listGet As New List(Of planParticularData)
        Dim listGet_2 As New List(Of particularData)
        Dim listGet_3 As New List(Of transformer)
        Dim aliasCriterion As String
        'daños materiales
        Dim dt As New DataTable
        Dim dr As DataRow
        Dim ds As New DataSet()
        Dim Bandera_dt As Integer = 0
        'robo total
        Dim dt2 As New DataTable
        Dim dr2 As DataRow
        Dim ds2 As New DataSet()
        Dim Bandera_dt2 As Integer = 0
        'Lan banderas de 1 al 6 corresponden ha si ya hay registros de los datos (DEDUCDAM,DEDUCROT, SACRCB,SACRCP,  SACERC SACGMO)
        'Datos_getRateCarQuote
        Dim dtDatos_getRateCarQuote As New DataTable
        Dim drDatos_getRateCarQuote As DataRow
        Dim dsDatos_getRateCarQuote As New DataSet()
        Dim Bandera_dt3 As Integer = 0
        Dim Bandera_dt4 As Integer = 0
        Dim Bandera_dt5 As Integer = 0
        Dim Bandera_dt6 As Integer = 0


        Dim idSession As String = Session("usrreg")
        Dim idUser = ViewState("wvsUsr")
        Dim idSubplan As String = ddlcobertura.SelectedValue
        'BUG-PC-171: CGARCIA: 27/03/2018: SE AGREGA EL FILTRO 
        clsDec.SubPlan = idSubplan


        listGet = clsDec.ObtieneDeducible(idSession, idUser)

        If IsNothing(listGet) Then
            MensajeError("No se encontrol información sobre deducible de robo total.")
            cmbDeducibleRoboTotal.Items.Clear()
            Exit Sub
        Else
            'daños materiales
            dt.Columns.Add("id")
            dt.Columns.Add("name")
            dt.Columns.Add("description")
            'robo total
            dt2.Columns.Add("id")
            dt2.Columns.Add("name")
            dt2.Columns.Add("description")
            'Datos_getRateCarQuote
            dtDatos_getRateCarQuote.Columns.Add("aliasCriterion")
            dtDatos_getRateCarQuote.Columns.Add("id")
            dtDatos_getRateCarQuote.Columns.Add("name")
            dtDatos_getRateCarQuote.Columns.Add("description")

            For Each planParticularData In listGet
                listGet_2 = planParticularData.particularData
                For index As Integer = 0 To listGet_2.Count - 1 Step 1
                    aliasCriterion = listGet_2.Item(index).aliasCriterion
                    'daños materiales
                    If aliasCriterion = "DEDUCDAM" Then
                        If Bandera_dt = 0 Then
                            listGet_3 = listGet_2.Item(index).transformer
                            For index_2 As Integer = 0 To listGet_3.Count - 1 Step 1
                                dr = dt.NewRow()
                                dr("id") = listGet_3.Item(index_2).catalogItemBase.Item(0).id.ToString()
                                dr("name") = listGet_3.Item(index_2).catalogItemBase.Item(0).name.ToString()
                                dr("description") = listGet_3.Item(index_2).catalogItemBase.Item(0).description.ToString()
                                dt.Rows.Add(dr)
                            Next
                            Bandera_dt = 1
                        End If
                        'robo total
                    ElseIf aliasCriterion = "DEDUCROT" Then
                        If Bandera_dt2 = 0 Then
                            listGet_3 = listGet_2.Item(index).transformer
                            For index_3 As Integer = 0 To listGet_3.Count - 1 Step 1
                                dr2 = dt2.NewRow()
                                dr2("id") = listGet_3.Item(index_3).catalogItemBase.Item(0).id.ToString()
                                dr2("name") = listGet_3.Item(index_3).catalogItemBase.Item(0).name.ToString()
                                dr2("description") = listGet_3.Item(index_3).catalogItemBase.Item(0).description.ToString()
                                dt2.Rows.Add(dr2)
                            Next
                            Bandera_dt2 = 1
                        End If
                    ElseIf aliasCriterion = "SACRCB" Then
                        If Bandera_dt3 = 0 Then
                            listGet_3 = listGet_2.Item(index).transformer
                            drDatos_getRateCarQuote = dtDatos_getRateCarQuote.NewRow()

                            drDatos_getRateCarQuote("aliasCriterion") = aliasCriterion.ToString().Trim
                            drDatos_getRateCarQuote("id") = listGet_3.Item(0).catalogItemBase.Item(0).id.ToString().Trim
                            drDatos_getRateCarQuote("name") = listGet_3.Item(0).catalogItemBase.Item(0).name.ToString().Trim
                            drDatos_getRateCarQuote("description") = listGet_3.Item(0).catalogItemBase.Item(0).description.ToString().Trim

                            dtDatos_getRateCarQuote.Rows.Add(drDatos_getRateCarQuote)
                            Bandera_dt3 = 1
                        End If
                    ElseIf aliasCriterion = "SACRCP" Then
                        If Bandera_dt4 = 0 Then
                            listGet_3 = listGet_2.Item(index).transformer
                            drDatos_getRateCarQuote = dtDatos_getRateCarQuote.NewRow()

                            drDatos_getRateCarQuote("aliasCriterion") = aliasCriterion.ToString().Trim
                            drDatos_getRateCarQuote("id") = listGet_3.Item(0).catalogItemBase.Item(0).id.ToString().Trim
                            drDatos_getRateCarQuote("name") = listGet_3.Item(0).catalogItemBase.Item(0).name.ToString().Trim
                            drDatos_getRateCarQuote("description") = listGet_3.Item(0).catalogItemBase.Item(0).description.ToString().Trim

                            dtDatos_getRateCarQuote.Rows.Add(drDatos_getRateCarQuote)
                            Bandera_dt4 = 1
                        End If
                    ElseIf aliasCriterion = "SACERC" Then
                        If Bandera_dt5 = 0 Then
                            listGet_3 = listGet_2.Item(index).transformer
                            drDatos_getRateCarQuote = dtDatos_getRateCarQuote.NewRow()

                            drDatos_getRateCarQuote("aliasCriterion") = aliasCriterion.ToString().Trim
                            drDatos_getRateCarQuote("id") = listGet_3.Item(0).catalogItemBase.Item(0).id.ToString().Trim
                            drDatos_getRateCarQuote("name") = listGet_3.Item(0).catalogItemBase.Item(0).name.ToString().Trim
                            drDatos_getRateCarQuote("description") = listGet_3.Item(0).catalogItemBase.Item(0).description.ToString().Trim

                            dtDatos_getRateCarQuote.Rows.Add(drDatos_getRateCarQuote)
                            Bandera_dt5 = 1
                        End If
                    ElseIf aliasCriterion = "SACGMO" Then
                        If Bandera_dt6 = 0 Then
                            listGet_3 = listGet_2.Item(index).transformer
                            drDatos_getRateCarQuote = dtDatos_getRateCarQuote.NewRow()

                            drDatos_getRateCarQuote("aliasCriterion") = aliasCriterion.ToString().Trim
                            drDatos_getRateCarQuote("id") = listGet_3.Item(0).catalogItemBase.Item(0).id.ToString().Trim
                            drDatos_getRateCarQuote("name") = listGet_3.Item(0).catalogItemBase.Item(0).name.ToString().Trim
                            drDatos_getRateCarQuote("description") = listGet_3.Item(0).catalogItemBase.Item(0).description.ToString().Trim

                            dtDatos_getRateCarQuote.Rows.Add(drDatos_getRateCarQuote)
                            Bandera_dt6 = 1
                        End If
                    End If
                Next
            Next

            ds.Tables.Add(dt)
            ds2.Tables.Add(dt2)
            dsDatos_getRateCarQuote.Tables.Add(dtDatos_getRateCarQuote)
            ViewState.Add("vws_getRateCarQuote", dtDatos_getRateCarQuote)
            'ViewState("vws_getRateCarQuote") = dsDatos_getRateCarQuote
            'daños materiales
            objCombo.LlenaCombos(ds, "description", "id", cmbDedusibleDaños, strErr, True)
            If strErr <> "" Then
                MensajeError(strErr)
                Exit Sub
            End If
            'robo total
            objCombo.LlenaCombos(ds2, "description", "id", cmbDeducibleRoboTotal, strErr, True)
            If strErr <> "" Then
                MensajeError(strErr)
                Exit Sub
            End If

        End If

    End Sub
    'RQ-PI7-PC7: CGARCIA: 27/12/2017: CREACION DE LOS SERVICIOS DE SUBPLANES, INDEMNIZACION Y DEDUCIBLES (comobo de coberturas es subplan) unicamente para seguros bancomer
    Protected Sub obtieneIndemnizacion()
        Dim listResult As New List(Of String)
        Dim clsIndem As New clsIndemnizacion
        Dim listGet As New List(Of clsIndemnizacion.catalogItemBase)
        Dim dt As New DataTable
        Dim dr As DataRow
        Dim ds As New DataSet()

        Dim idSession As String = Session("usrreg")
        Dim idUser = ViewState("wvsUsr")
        Dim idSubplan As String = ddlcobertura.SelectedValue

        listGet = clsIndem.ObtenIndemnizacion(idSubplan, idSession, idUser)

        If IsNothing(listGet) Then
            MensajeError("No se encontro información sobre indemnización.")
            cmbIndemnizacion.Items.Clear()
            Exit Sub
        Else
            dt.Columns.Add("id")
            dt.Columns.Add("name")

            For Each catalogItemBase In listGet

                dr = dt.NewRow()
                dr("id") = catalogItemBase.id.ToString()
                dr("name") = catalogItemBase.name.ToString()
                dt.Rows.Add(dr)

            Next
            ds.Tables.Add(dt)

            objCombo.LlenaCombos(ds, "name", "id", cmbIndemnizacion, strErr, True)
            If strErr <> "" Then
                MensajeError(strErr)
                Exit Sub
            End If
            If ddlclasif.SelectedValue = 64 Then              
                cmbIndemnizacion.SelectedValue = "0003"
                cmbIndemnizacion.Enabled = False
            Else
                cmbIndemnizacion.Enabled = True
            End If
        End If


    End Sub

    Protected Sub ddlgrupo_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddlgrupo.SelectedIndexChanged
        Dim dts As New DataSet
        Dim datos(5) As Integer

        ddldivision.SelectedValue = -1

        objAge.IDAlianza = ddlalianza.SelectedValue
        objAge.IDGrupo = ddlgrupo.SelectedValue
        objAge.IDDivision = -1
        objAge.IDUsuario = iduser
        objAge.IDEstado = ddledo.SelectedValue
        dts = objAge.ManejaAgencia(30)
        If objAge.ErrorAgencia = "" Then
            If dts.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dts, "NOMBRE", "ID_AGENCIA", ddlagencia, strErr, False)
            Else
                ddlagencia.Items.Clear()
                ddlagencia.Items.Insert(0, New ListItem("", "0"))
            End If
        End If

        If ddlagencia.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlagencia)
            limpiaobjs("textbox", ddlagencia)
            limpiaobjs("label", ddlagencia)
            MensajeError("No se encontro información de Agencias con los parámetros proporcionados.")
            Exit Sub
        End If

        'Combo Promotores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlejecutivo, datos)
        If ddlejecutivo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlejecutivo)
            limpiaobjs("textbox", ddlejecutivo)
            limpiaobjs("label", ddlejecutivo)
            MensajeError("No se encontro información de F&I.")
            Exit Sub
        End If

        'Combo Vendedores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlvendedor, datos)
        'Cuando el usuario es de perfil vendedor se selecciona solo su usuario en el combo de usuarios
        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
        If objUsuFirma.IDPerfil = 74 Then
            If ddlvendedor.Items.Count > 0 Then
                ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
            End If
        End If
        If ddlvendedor.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlvendedor)
            limpiaobjs("textbox", ddlvendedor)
            limpiaobjs("label", ddlvendedor)
            MensajeError("No se encontro información de Vendedores.")
            Exit Sub
        End If

        ''Combo Marca
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmarca, datos)
        If ddlmarca.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmarca)
            limpiaobjs("textbox", ddlmarca)
            limpiaobjs("label", ddlmarca)
            MensajeError("La Agencia " & ddlagencia.SelectedItem.Text & " no cuenta con Marcas asignadas.")
            Exit Sub
        End If

        ''Combo SubMarca
        ReDim datos(2)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmodelo, datos)
        If ddlmodelo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmodelo)
            limpiaobjs("textbox", ddlmodelo)
            limpiaobjs("label", ddlmodelo)
            MensajeError("No se encontro información de SubMarcas con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año 
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Version
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
        Dim brokerid As String = obten_broker()
        'RQ-PC5 'BUG-PC-193
        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) Or (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
            dvrecurrecte.Visible = True
            dvcodpostal.Visible = True
        Else
            dvrecurrecte.Visible = False
            dvcodpostal.Visible = False
        End If

    End Sub

    Protected Sub ddldivision_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles ddldivision.SelectedIndexChanged
        Dim dts As New DataSet
        Dim datos(5) As Integer

        objAge.IDAlianza = ddlalianza.SelectedValue
        objAge.IDGrupo = ddlgrupo.SelectedValue
        objAge.IDDivision = ddldivision.SelectedValue
        objAge.IDUsuario = iduser
        objAge.IDEstado = ddledo.SelectedValue
        dts = objAge.ManejaAgencia(30)
        If objAge.ErrorAgencia = "" Then
            If dts.Tables(0).Rows.Count > 0 Then
                objCombo.LlenaCombos(dts, "NOMBRE", "ID_AGENCIA", ddlagencia, strErr, False)
            Else
                ddlagencia.Items.Clear()
                ddlagencia.Items.Insert(0, New ListItem("", "0"))
            End If
        End If

        If ddlagencia.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlagencia)
            limpiaobjs("textbox", ddlagencia)
            limpiaobjs("label", ddlagencia)
            MensajeError("No se encontro información de Agencias con los parámetros proporcionados.")
            Exit Sub
        End If

        'Combo Promotores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlejecutivo, datos)
        If ddlejecutivo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlejecutivo)
            limpiaobjs("textbox", ddlejecutivo)
            limpiaobjs("label", ddlejecutivo)
            MensajeError("No se encontro información de F&I.")
            Exit Sub
        End If

        'Combo Vendedores
        ReDim datos(2)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddledo.SelectedValue
        objCombo.LlenaObjs(ddlvendedor, datos)
        'Cuando el usuario es de perfil vendedor se selecciona solo su usuario en el combo de usuarios
        Dim objUsuFirma As New SNProcotiza.clsUsuariosSistema(Val(Session("cveAcceso")), Val(Session("cveUsu")))
        If objUsuFirma.IDPerfil = 74 Then
            If ddlvendedor.Items.Count > 0 Then
                ddlvendedor.SelectedValue = objUsuFirma.IDUsuario
            End If
        End If

        If ddlvendedor.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlvendedor)
            limpiaobjs("textbox", ddlvendedor)
            limpiaobjs("label", ddlvendedor)
            MensajeError("No se encontro información de Vendedores.")
            Exit Sub
        End If

        ''Combo Marca
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmarca, datos)
        If ddlmarca.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmarca)
            limpiaobjs("textbox", ddlmarca)
            limpiaobjs("label", ddlmarca)
            MensajeError("La Agencia " & ddlagencia.SelectedItem.Text & " no cuenta con Marcas asignadas.")
            Exit Sub
        End If

        ''Combo SubMarca
        ReDim datos(2)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        objCombo.LlenaObjs(ddlmodelo, datos)
        If ddlmodelo.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmodelo)
            limpiaobjs("textbox", ddlmodelo)
            limpiaobjs("label", ddlmodelo)
            MensajeError("No se encontro información de SubMarcas con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Clasificación 
        ReDim datos(3)
        datos(0) = ddlagencia.SelectedValue
        datos(1) = ddlmarca.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        objCombo.LlenaObjs(ddlclasif, datos)
        If ddlclasif.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError("No existe configuración de CLASIFICACIÓN con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Año 
        ReDim datos(4)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlanio, datos)
        If ddlanio.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlanio)
            limpiaobjs("textbox", ddlanio)
            limpiaobjs("label", ddlanio)
            MensajeError("No se encontro información de Años con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Version
        ReDim datos(5)
        datos(0) = ddlmarca.SelectedValue
        datos(1) = ddlagencia.SelectedValue
        datos(2) = ddlmodelo.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        datos(4) = ddlanio.SelectedValue
        objCombo.LlenaObjs(ddlversion, datos)
        If ddlversion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlversion)
            limpiaobjs("textbox", ddlversion)
            limpiaobjs("label", ddlversion)
            MensajeError("No se encontro información de Versiones con los parámetros proporcionados.")
            Exit Sub
        End If


        ''Precio Producto
        prodid = ObtenProducto()
        objProd.CargaProducto(prodid)
        If objProd.ErrorProducto = "" Then
            Select Case ddlclasif.SelectedValue
                Case 63 ''Nuevos
                    txtprecio.Text = objProd.Precio.ToString()
                    ddlGarantia.Enabled = True
                    divmtogarantia.Visible = True
                    divmtogarantia.Attributes("class") = "visible"
                Case 64 ''SemiNuevos
                    txtprecio.Text = objProd.PrecioSemi.ToString()
                    divmtogarantia.Visible = False
                    ddlGarantia.Enabled = False
                    divmtogarantia.Visible = False
                    divmtogarantia.Attributes("class") = "hidden"
            End Select
        Else
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlclasif)
            limpiaobjs("textbox", ddlclasif)
            limpiaobjs("label", ddlclasif)
            MensajeError(objProd.ErrorProducto)
        End If

        ''Combo Tasas IVA
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddliva, datos)
        If ddliva.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddliva)
            limpiaobjs("textbox", ddliva)
            limpiaobjs("label", ddliva)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo Monedas Factura
        ReDim datos(1)
        datos(0) = 2
        objCombo.LlenaObjs(ddlmonedafact, datos)
        If ddlmonedafact.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlmonedafact)
            limpiaobjs("textbox", ddlmonedafact)
            limpiaobjs("label", ddlmonedafact)
            MensajeError("No existe información de Tasas de IVA.")
            Exit Sub
        End If

        ''Combo de Monedas de cotización derivado del combo de monedas de factura
        If ddlmonedafact.SelectedValue > 0 Then
            ReDim datos(1)
            datos(0) = ddlmonedafact.SelectedValue
            objCombo.LlenaObjs(ddlmonedafin, datos)
            If ddlmonedafin.SelectedValue = 0 Then
                divfinadic.Visible = False
                limpiaobjs("dropdownlist", ddlmonedafin)
                limpiaobjs("textbox", ddlmonedafin)
                limpiaobjs("label", ddlmonedafin)
                MensajeError("No existe información de Tasas de IVA.")
                Exit Sub
            End If
        End If

        ''Paquetes
        ReDim datos(3)
        datos(0) = ddlmonedafin.SelectedValue
        datos(1) = prodid
        datos(2) = ddlagencia.SelectedValue
        datos(3) = ddlclasif.SelectedValue
        objCombo.LlenaObjs(ddlplan, datos)
        If ddlplan.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplan)
            limpiaobjs("textbox", ddlplan)
            limpiaobjs("label", ddlplan)
            MensajeError("No se encontró paquete financiero con los parámetros proporcionados.")
            Exit Sub
        End If

        ddlplan_SelectedIndexChanged(ddlplan, Nothing)

        'Leyenda Promoción
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDPROMOCION <> 1 Then
            Dim objPromo As New SNProcotiza.clsPromocionesCte(objPaq.IDPROMOCION)
            If objPromo.ErrorPromociono = "" Then
                lblpromoleyenda.Text = "Promoción: " & objPromo.DESCRIPCION & " " & IIf(objPromo.IDPERIODICIDAD = 83, objPaq.noperiodos / 12, objPaq.noperiodos / 24) & IIf(objPromo.IDPERIODICIDAD = 83, " AÑO(S).", " QUINCENA(S)")
            End If
        Else
            lblpromoleyenda.Text = ""
        End If

        ''Plazos
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlplazos, datos)
        If ddlplazos.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddlplazos)
            limpiaobjs("textbox", ddlplazos)
            limpiaobjs("label", ddlplazos)
            MensajeError("No existen plazos para el paquete " & ddlplan.SelectedItem.Text & ".")
            Exit Sub
        End If

        ''TextBox's Monto Enganche, % Enganche, Enganche Minimo, Tasa de Interes
        ObtenTasa()
        CalculaEnganche(0)
        ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
        ''Tipos Operación
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddltoperacion, datos)
        If ddltoperacion.SelectedValue = 0 Then
            divfinadic.Visible = False
            limpiaobjs("dropdownlist", ddltoperacion)
            limpiaobjs("textbox", ddltoperacion)
            limpiaobjs("label", ddltoperacion)
            MensajeError("No se encontró Tipo de Operación con los parámetros proporcionados.")
            Exit Sub
        End If

        ''Combo Personalidad Jurídica
        ReDim datos(1)
        datos(0) = ddlplan.SelectedValue
        objCombo.LlenaObjs(ddlpj, datos)
        If ddlpj.SelectedValue = 0 Then
            divfinadic.Visible = False
            MensajeError("No se encontraron Tipos de Personalidad Jurídica con los parámetros proporcionados.")
            Exit Sub
        End If
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)

        ''Combo Giros
        ReDim datos(2)
        datos(0) = 2
        datos(1) = ddltoperacion.SelectedValue
        objCombo.LlenaObjs(ddlgiro, datos)

        divfinadic.Visible = True
        CargaCombos2()
        Dim brokerid As String = obten_broker()
        'RQ-PC5 'BUG-PC-193
        If (ddlalianza.SelectedValue = 2224 Or ddlalianza.SelectedValue = 2232) Or (brokerid = 5) OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then
            dvrecurrecte.Visible = True
            dvcodpostal.Visible = True
        Else
            dvrecurrecte.Visible = False
            dvcodpostal.Visible = False
        End If

    End Sub

    Protected Sub cmbPeriodos_SelectedIndexChanged(sender As Object, e As System.EventArgs) Handles cmbPeriodos.SelectedIndexChanged
        Dim dts As DataSet = Session("dtsfecpagos")
        Dim mes As Integer = Val(cmbPeriodos.SelectedValue)
        Dim renglon() As DataRow

        Dim strsql = "NO_PAGO IN(1,2)"
        renglon = dts.Tables(0).Select(strsql)

        For Each row In renglon
            If mes = Month(row("EXIGIBILIDAD")) Then
                cmbPeriodos.SelectedValue = IIf(Month(dts.Tables(0).Rows(2).Item("exigibilidad")) < 10, "0" & Month(dts.Tables(0).Rows(2).Item("exigibilidad")).ToString, Month(dts.Tables(0).Rows(2).Item("exigibilidad")).ToString)
                btnAplicaPE_Click(btnAplicaPE, Nothing)
                MensajeError("El pago de la anualidad tiene que ser a partir del tercer vencimiento.")
                Exit Sub
            Else
                btnAplicaPE_Click(btnAplicaPE, Nothing)
            End If
        Next

    End Sub

    Private Function ValidadatosCte() As Boolean
        ValidadatosCte = False

        If chkdatoscte.Checked = False Then
            ValidadatosCte = True
            Exit Function
        End If

        If txtnombrecte.Text.Trim = "" Then
            strErr = "Falta información en la sección de Cliente."
            Exit Function
        End If

        If txtrfc.Text.Trim = "" Then
            strErr = "Falta información en la sección de Cliente."
            Exit Function
        End If

        If txtcp.Text.Trim = "" Then
            strErr = "Falta información en la sección de Cliente."
            Exit Function
        End If

        If txtnombrecte.Text.Trim.Length < 3 Then
            strErr = "El nombre o Razón Social debe tener al menos 3 caracteres."
            Exit Function
        End If
        'MUAA
        If ddlpj.SelectedValue = 15 Then 'Morales
            If txtrfc.Text.Trim.Length < 9 Then
                strErr = "El RFC no tiene la longitud correcta."
                Exit Function
            End If

        Else 'Fisicas
            If txtrfc.Text.Trim.Length < 10 Then
                strErr = "El RFC no tiene la longitud correcta."
                Exit Function
            End If
        End If

        If txtcp.Text.Trim = "" Then
            strErr = "El Código Postal debe tener 5 caracteres."
            Exit Function
        End If

        ValidadatosCte = True
    End Function

    'Protected Sub txtPagEsp_TextChanged(sender As Object, e As System.EventArgs) Handles txtPagEsp.TextChanged
    '    objPaq.CargaPaquete(ddlplan.SelectedValue)
    '    If objPaq.ErrorPaquete = "" Then
    '        If CDbl(Val(txtPagEsp.Text)) < CDbl(txtprecio.Text.Trim) * CDbl(objPaq.PorPagEspeciales / 100.0) Then
    '            MensajeError("El monto de la anualidad no puede ser menor a la establecida en la configuración del plan.")
    '            txtPagEsp.Text = CDbl(txtprecio.Text.Trim) * CDbl(objPaq.PorPagEspeciales / 100.0)
    '        End If
    '    Else
    '        strErr = objPaq.ErrorPaquete
    '        Exit Sub
    '    End If
    'End Sub

    Private Sub CargaCotizacion(IDCot As Integer) 'BBV-P-412 RQCOT-05:AVH
        Dim Fname As String
        Dim crReportDocument As ReportDocument
        Dim crDiskFileDestinationOptions As DiskFileDestinationOptions
        Dim crExportOptions As ExportOptions
        Dim strRuta As String

        Dim dtsDatos As New DataSet
        Dim dtsTabla As New DataSet
        Dim objRep As New SNProcotiza.clsReportes
        Dim objTab As New SNProcotiza.clsCotizaciones
        Dim objCot As New SNProcotiza.clsCotizaciones
        Dim dtsFiltros As New DataSet
        Dim dtsCargIni As New DataSet
        Dim dtsRep As New DataSet
        Dim dtsTA_6 As New DataSet 'RQ-MN2-2.3.1

        objRep.IDCotizacion = IDCot
        objTab.CargaCotizacion(IDCot)

        Dim objPaq As New clsPaquetes
        objPaq.CargaPaquete(objTab.IDPaquete)

        If objPaq.IDTipoCalculo = 167 Then
            strRuta = Server.MapPath("..\Reportes\rptCotizacion2int.rpt")
        Else
            strRuta = Server.MapPath("..\Reportes\rptCotizacion2.rpt")
        End If

        dtsDatos = objRep.ManejaReporte(1)

        dtsDatos.Tables(0).TableName = "Datos"
        dtsDatos.Tables(1).TableName = "TablaAmort"
        dtsDatos.Tables(2).TableName = "Leyendas"
        dtsDatos.Tables(3).TableName = "TablaPorc"

        If objPaq.IDTipoCalculo = 167 Then
            dtsDatos.Tables(4).TableName = "AditionalData"
            dtsDatos.Tables(5).TableName = "MontosCI"
            dtsDatos.Tables(6).TableName = "LeyendaComparativo"
            dtsDatos.Tables(7).TableName = "Tabla_Amort_6"
        End If

        dtsDatos.Tables(8).TableName = "PER_SEG_DANIOS"

        crReportDocument = New ReportDocument
        crReportDocument.Load(strRuta)

        Fname = Server.MapPath("Cotizacion_" & IDCot & "_" & Format$(Now(), "dd-MM-yyyy HH-mm-ss") & ".pdf")
        Fname = Replace(Fname, "\aspx\", "\Docs\")

        System.IO.File.Delete(Fname)

        crDiskFileDestinationOptions = New DiskFileDestinationOptions
        crDiskFileDestinationOptions.DiskFileName = Fname
        crExportOptions = crReportDocument.ExportOptions
        With crExportOptions
            .DestinationOptions = crDiskFileDestinationOptions
            .ExportDestinationType = ExportDestinationType.DiskFile
            .ExportFormatType = ExportFormatType.PortableDocFormat

        End With


        crReportDocument.SetDataSource(dtsDatos)

        Dim IMG As String
        If dtsDatos.Tables(0).Rows.Count > 0 Then
            IMG = dtsDatos.Tables(0).Rows(0).Item("IMG_REP").ToString
        End If

        If IMG <> "" Then
            crReportDocument.SetParameterValue("PicturePath", IMG)
        Else
            crReportDocument.SetParameterValue("PicturePath", "")
        End If

        crReportDocument.SetParameterValue("No_Cotizacion", IDCot.ToString)

        objCot.CargaCotizacion(IDCot)
        Dim TipOperRG As Integer = objCot.IDTipoOperacion
        dtsCargIni = objCot.ObtenCargosIniciales(TipOperRG) 'los cargos iniciales van antes que los filtros
        dtsFiltros = objCot.ObtenFiltros
        dtsRep = objCot.ConsultaTablaAmort
        dtsTA_6 = objCot.ConsultaTablaAmort_6  'RQ-MN2-2.3.1

        Dim dblCAT As Double = 0
        Dim dblCAT_DOS As Double = 0
        Dim strFechaPeriodoT6 As String = ""
        dblCAT = objCot.CalculaCat(dtsRep, dtsCargIni, dtsFiltros)
        dblCAT_DOS = objCot.CalculaCat_Dos(dtsTA_6, dtsCargIni, dtsFiltros)  'RQ-MN2-2.3.1

        crReportDocument.SetParameterValue("leyenda_CAT", FormatNumber(CDbl(dblCAT.ToString()), 1))

        If objPaq.IDTipoCalculo = 167 Then
            If dtsTA_6.Tables(0).Rows.Count > 0 Then
        strFechaPeriodoT6 = dtsTA_6.Tables(0).Rows(0).Item("FEC_PAGO")
            End If
            crReportDocument.SetParameterValue("FechaPeriodo6", strFechaPeriodoT6)
            crReportDocument.SetParameterValue("Valor_Garantizado", CDbl(objTab.MontoValorResidual))
            crReportDocument.SetParameterValue("leyenda_CAT_DOS", FormatNumber(CDbl(dblCAT_DOS.ToString()), 1))  'RQ-MN2-2.3.1

            'If objCot.IDPlazo = 4 Or objCot.IDPlazo = 6 Then
            Dim ArD() As Double
            ReDim ArD(1)
            ArD = ObtenTasa36_72_(objCot.IDPlazo, objPaq.IDPaquete)
            Dim t32 As String = ArD(0)
            Dim tr32 As String = ArD(1)
                If Not t32.Contains(".") Then
                    t32 = t32 + ".00"
                Else
                    Dim i As Integer
                    i = t32.IndexOf(".")
                    Dim pdec As String
                    pdec = t32.Substring(i)
                    If (pdec.Length < 3) Then
                        t32 = t32 + "0"
                    End If

                End If




                crReportDocument.SetParameterValue("Tasa_32", ":" + t32 + "%")
            crReportDocument.SetParameterValue("Tasa_R", tr32)
            crReportDocument.SetParameterValue("Tasa_R_S", tr32)

                Dim t1 As String = "1-" + objCot.ValorPlazo.ToString() + " Meses"
                Dim t2 As String = (Convert.ToInt16(objCot.ValorPlazo.ToString()) + 1).ToString() + "-" + (Convert.ToInt16(objCot.ValorPlazo.ToString()) * 2).ToString() + " Meses"

                crReportDocument.SetParameterValue("tasa1label", t1)
                crReportDocument.SetParameterValue("tasa2label", t2)
            crReportDocument.SetParameterValue("tasa2label_2", t2)
            'Else
            '    crReportDocument.SetParameterValue("Valor_Garantizado", 0)
            '    crReportDocument.SetParameterValue("leyenda_CAT_DOS", "")

            '    crReportDocument.SetParameterValue("FechaPeriodo6", "")
            '    crReportDocument.SetParameterValue("Tasa_32", "")
            '    crReportDocument.SetParameterValue("Tasa_R", "")
            '    crReportDocument.SetParameterValue("tasa1label", "Auto")
            '    crReportDocument.SetParameterValue("tasa2label", "")
            '    crReportDocument.SetParameterValue("tasa2label_2", "")
            'End If

        End If

        crReportDocument.Export()
        crReportDocument.Close()
        crReportDocument.Dispose()


        'Dim psi As New ProcessStartInfo()
        'psi.UseShellExecute = True
        'psi.FileName = Fname
        'Process.Start(psi)

        Response.Clear()
        Response.ClearContent()
        Response.ClearHeaders()
        Response.AddHeader("Content-Disposition", "attachment; filename=" + Fname)
        Response.ContentType = "application/pdf"
        Response.TransmitFile(Fname)

        'Response.TransmitFile(Fname)
        'Response.Flush()
        'Response.Close()
        'Response.Clear()
        'Response.ClearContent()


    End Sub

    Private Sub RecargaCotizacion(IDCot As Integer)
        Dim objpersona As New clsPersonas
        Dim ds As DataSet
        objCot.IDCotizacion = IDCot
        ds = objCot.ManejaCotizacion(1)


        'BUG-PC-25 MAUT 16/12/2016 Se carga informacion


        'AGENCIA
        Me.ddledo.SelectedValue = ds.Tables(0).Rows(0).Item("ID_ESTADO").ToString
        ddledoseg.SelectedValue = ddledo.SelectedValue
        Me.ddlalianza.SelectedValue = ds.Tables(0).Rows(0).Item("ID_ALIANZA").ToString
        Me.ddlgrupo.SelectedValue = ds.Tables(0).Rows(0).Item("ID_GRUPO").ToString
        Me.ddldivision.SelectedValue = ds.Tables(0).Rows(0).Item("ID_DIVISION").ToString
        Me.ddlagencia.SelectedValue = ds.Tables(0).Rows(0).Item("ID_AGENCIA").ToString
        Me.ddlejecutivo.SelectedValue = ds.Tables(0).Rows(0).Item("ID_PROMOTOR").ToString
        Me.ddlvendedor.SelectedValue = ds.Tables(0).Rows(0).Item("ID_VENDEDOR").ToString

        'PRODUCTO
        Me.ddlmarca.SelectedValue = ds.Tables(0).Rows(0).Item("ID_MARCA").ToString
        Me.ddlmodelo.SelectedValue = ds.Tables(0).Rows(0).Item("ID_SUBMARCA").ToString
        Me.ddlversion.SelectedValue = ds.Tables(0).Rows(0).Item("ID_VERSION").ToString
        Me.ddlanio.SelectedValue = ds.Tables(0).Rows(0).Item("ANIO_MODELO_USADOS").ToString
        Me.ddlclasif.SelectedValue = ds.Tables(0).Rows(0).Item("ID_CLASIFICACION").ToString
        Me.txtprecio.Text = ds.Tables(0).Rows(0).Item("PRECIO_PRODUCTO").ToString
        Me.ddliva.SelectedValue = ds.Tables(0).Rows(0).Item("ID_TASA_IVA").ToString
        Me.ddlmonedafact.SelectedValue = ds.Tables(0).Rows(0).Item("ID_MONEDA_FACTURA").ToString
        Me.txtUniProd.Text = ds.Tables(0).Rows(0).Item("UNIDADES_PRODUCTO").ToString

        'FINANCIAMIENTO
        Me.ddlmonedafin.SelectedValue = ds.Tables(0).Rows(0).Item("ID_MONEDA").ToString
        Me.ddlplan.SelectedValue = ds.Tables(0).Rows(0).Item("ID_PAQUETE").ToString
        ddlplan_SelectedIndexChanged(ddlplan, Nothing)
        Me.ddlplazos.SelectedValue = ds.Tables(0).Rows(0).Item("ID_PLAZO").ToString
        Me.txtenganche.Text = ds.Tables(0).Rows(0).Item("ENGANCHE").ToString
        Me.txtporeng.Text = ds.Tables(0).Rows(0).Item("PTJ_ENGANCHE").ToString
        txtporeng_TextChanged(txtporeng, Nothing)

        'Me.txttasa.Text = ds.Tables(0).Rows(0).Item("TASA_IVA").ToString
        'Me.txtresidual.Text = ds.Tables(0).Rows(0).Item("VALOR_RESIDUAL").ToString
        'Me.txtporresidual.Text = ds.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT").ToString
        Me.txtmtosub.Text = ds.Tables(0).Rows(0).Item("MONTO_SUBSIDIO").ToString
        Me.txtporsub.Text = ds.Tables(0).Rows(0).Item("PTJ_SUBSIDIO").ToString
        If ds.Tables(0).Rows(0).Item("ENGANCHE_CI").ToString <> "" And ds.Tables(0).Rows(0).Item("ENGANCHE_CI").ToString <> "0.00" And ddlengancheCI.Enabled = True Then
            Me.ddlengancheCI.SelectedIndex = ddlengancheCI.Items.IndexOf(ddlengancheCI.Items.FindByText(ds.Tables(0).Rows(0).Item("ENGANCHE_CI").ToString))
            ddlengancheCI_SelectedIndexChanged(ddlengancheCI, Nothing)
        End If


        'SEGURO
        'Me.ddltiposeg.SelectedValue = CInt(ds.Tables(0).Rows(0).Item("ID_TIPO_SEGURO").ToString)

        'ddltiposeg_SelectedIndexChanged(ddltiposeg, Nothing)


        'ACCESORIOS

        Dim datos As DataSet

        objCot.IDCotizacion = IDCot
        datos = objCot.ManejaCotizacion(31)

        ViewState("CurrentTable") = datos.Tables(0)
        grvAccesorios.DataSource = ViewState("CurrentTable")
        grvAccesorios.DataBind()
        'SetPreviousData()

        Dim rowIndex As Integer = 0
        If ViewState("CurrentTable") IsNot Nothing Then

            Dim dt As DataTable = DirectCast(ViewState("CurrentTable"), DataTable)
            If dt.Rows.Count > 0 Then

                For i As Integer = 0 To dt.Rows.Count - 1

                    Dim box1 As TextBox = DirectCast(grvAccesorios.Rows(i).Cells(3).FindControl("TextBox1"), TextBox)

                    Dim ddl1 As DropDownList = DirectCast(grvAccesorios.Rows(rowIndex).Cells(1).FindControl("DropDownList1"), DropDownList)
                    Dim ddl2 As DropDownList = DirectCast(grvAccesorios.Rows(rowIndex).Cells(2).FindControl("DropDownList2"), DropDownList)
                    Dim imgbtn As ImageButton = TryCast(grvAccesorios.Rows(rowIndex).Cells(4).FindControl("ImageButton1"), ImageButton)

                    ddl1.Items.Clear()
                    ddl1.Items.Add(New ListItem((dt.Rows(i)(2).ToString()), (dt.Rows(i)(1).ToString())))
                    ddl2.Items.Clear()
                    ddl2.Items.Add(New ListItem((dt.Rows(i)(3).ToString()), IIf(dt.Rows(i)(3).ToString().Contains("FINANC"), 160, 0)))

                    If i < dt.Rows.Count Then

                        box1.Text = dt.Rows(i)("Column3").ToString()
                        box1.Enabled = False

                        ddl1.ClearSelection()
                        ddl1.SelectedIndex = ddl1.Items.IndexOf(ddl1.Items.FindByText(dt.Rows(i).Item("Column1")))

                        ddl2.ClearSelection()
                        ddl2.SelectedIndex = ddl2.Items.IndexOf(ddl2.Items.FindByText(dt.Rows(i).Item("Column2")))

                        ddl1.Enabled = False
                        ddl2.Enabled = False

                        imgbtn.Visible = True
                    End If

                    rowIndex += 1
                Next
            Else
                SetInitialRow()
                'AddNewRowToGrid()
            End If
        End If

        For Each row As GridViewRow In grvAccesorios.Rows
            Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
            total = total + CDbl(IIf(txt.Text.Trim() = "", 0, txt.Text.Trim()))
        Next
        lbltotalacc.Text = Val(total).ToString("###,##0.00")

        'INFO DE CLIENTE
        Me.ddlpj.SelectedValue = ds.Tables(0).Rows(0).Item("ID_PER_JURIDICA")
        ddlpj_SelectedIndexChanged(ddlpj, Nothing)
        Me.ddltoperacion.SelectedValue = ds.Tables(0).Rows(0).Item("ID_TIPO_OPER").ToString
        Me.ddlgiro.SelectedValue = ds.Tables(0).Rows(0).Item("ID_GIRO").ToString

        'DATOS DEL CLIENTE
        If ds.Tables(0).Rows(0).Item("NOMBRE").ToString <> "" Then
            Me.chkdatoscte.Checked = True
            If ddlpj.SelectedValue = 15 Then
                Me.txtnombrecte.Text = ds.Tables(0).Rows(0).Item("NOMBRE").ToString
            Else
                Me.txtnombrectepf.Text = ds.Tables(0).Rows(0).Item("NOMBRE").ToString
                Me.txtnombrecte.Text = Me.txtnombrectepf.Text
            End If
            'Me.txtnombrecte.Text = ds.Tables(0).Rows(0).Item("NOMBRE").ToString
            Me.txtnombrecte2.Text = ds.Tables(0).Rows(0).Item("NOMBRE2").ToString
            Me.txtpaterno.Text = ds.Tables(0).Rows(0).Item("PATERNO").ToString
            Me.txtmaterno.Text = ds.Tables(0).Rows(0).Item("MATERNO").ToString
            Me.txtfecnac.Text = ds.Tables(0).Rows(0).Item("FECHA_NAC").ToString

            'BUG-PC-34 MAUT 12/01/2017
            'como la fecha se guarda en formato aaaa-MM-dd, se cambia el formato
            Dim fecNac As String()
            fecNac = ds.Tables(0).Rows(0).Item("FECHA_NAC").ToString.Split("-")
            txtfecnac.Text = fecNac(2) & "-" & fecNac(1) & "-" & fecNac(0)

            txtrfc.Text = objpersona.CalculaRFC(txtpaterno.Text.Trim.ToUpper, txtmaterno.Text.Trim.ToUpper, txtnombrecte.Text.Trim.ToUpper, txtfecnac.Text.Trim, strErr, txtnombrecte2.Text)
            Me.txtcp.Text = ds.Tables(0).Rows(0).Item("CP").ToString
            Me.txttelfijo.Text = ds.Tables(0).Rows(0).Item("TELEFONO").ToString
            Me.txttelmovil.Text = ds.Tables(0).Rows(0).Item("MOVIL").ToString
        End If

        Dim id_prod As Integer = ObtenProducto()
        LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
            ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
            CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)


    End Sub

    Protected Sub btnagregarprod_Click(sender As Object, e As System.EventArgs) Handles btnagregarprod.Click

        AgregaAccesorios(1)
        If strErr <> "" Then
            MensajeError(strErr)
            Exit Sub
        End If

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        If objPlazos.StrErrPlazo = "" Then

            If Not grvSeguro.Rows.Count > 0 Then
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
            Else

                Dim intbroker As Integer = obten_broker()
                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                    ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                    CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                    IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                    ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                    0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                    ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

            End If

            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If

            If chkPagosEsp.Checked = True Then
                btnAplicaPE_Click(btnAplicaPE, Nothing)
            End If

        Else
            MensajeError(objPlazos.StrErrPlazo)
            AccFlag = False
            Exit Sub
        End If
        AccFlag = True
        finseg.Visible = False
        grvSeguro.DataBind()
    End Sub

    Public Sub WS()

        If txtcp.Text <> "" And txtrfc.Text <> "" Then
            Try
				   Exit Sub
                Dim tableWS As DataTable
                tableWS = New System.Data.DataTable()
                tableWS.Columns.Add("RowNumber")
                tableWS.Columns.Add("Origen")
                tableWS.Columns.Add("SubProducto")
                tableWS.Columns.Add("Tasa")
                tableWS.Columns.Add("Plazo")



                Dim ds As DataSet = ViewState("MulPlazos")
                Dim Concepto As String
                Dim tasa As Decimal
                Dim PlazoDes As String
                Dim plazo As Integer
                Dim MejorPropuesta As String = ""

                Dim drCurrentRow As DataRow = Nothing

                If ds Is Nothing Then Exit Sub

                For C = 1 To ds.Tables(0).Columns.Count - 1
                    PlazoDes = ds.Tables(0).Columns(C).ColumnName
                    For R = 0 To ds.Tables(0).Rows.Count - 1
                        Concepto = ds.Tables(0).Rows(R)("CONCEPTO")

                        If Concepto = "% Tasa Nominal" Then
                            tasa = ds.Tables(0).Rows(R)(PlazoDes)
                            plazo = Val(PlazoDes)

                            drCurrentRow = tableWS.NewRow()
                            drCurrentRow("RowNumber") = tableWS.Rows.Count + 1
                            tableWS.Rows.Add(drCurrentRow)
                            tableWS.Rows(C - 1)("Origen") = "Procotiza"
                            tableWS.Rows(C - 1)("SubProducto") = ""
                            tableWS.Rows(C - 1)("Tasa") = tasa
                            tableWS.Rows(C - 1)("Plazo") = plazo

                            Exit For
                        End If
                    Next
                Next


                Dim userID As String = CType(System.Web.HttpContext.Current.Session.Item("userID"), String)
                Dim iv_ticket1 As String = CType(System.Web.HttpContext.Current.Session.Item("iv_ticket"), String)

                Dim restGT As WCF.RESTful = New WCF.RESTful()

                'Dim rest As New WCF.RESTful

                ''************************************  BUSCA CLIENTE   ************************
                Dim fecha As Date
                fecha = Me.txtfecnac.Text
                Dim FechaN As String = fecha.ToString("yyyy-MM-dd")

                'restGT.Uri = System.Configuration.ConfigurationManager.AppSettings.Item("Customer") + "?$filter=(customerName==" + Me.txtnombrecte.Text + " " + Me.txtnombrecte2.Text + ",customerLastName==" + Me.txtpaterno.Text + ",customerMotherLastName==" + Me.txtmaterno.Text + ",federalTaxpayerRegistry==" + Left(Me.txtrfc.Text, 10) + ",homonimia==" + Right(Me.txtrfc.Text, 3) + ",postalCode==" + Me.txtcp.Text + ",birthDate==" + FechaN + ")&$fields=id,person(id,segment)"
                restGT.Uri = System.Configuration.ConfigurationManager.AppSettings.Item("Customer") + "?$filter=(customerName==" + Me.txtnombrecte.Text + " " + Me.txtnombrecte2.Text + ",customerLastName==" + Me.txtpaterno.Text + IIf(Me.txtmaterno.Text.Trim <> "", ",customerMotherLastName==", "") + IIf(Me.txtmaterno.Text.Trim <> "", Me.txtmaterno.Text, "") + ",federalTaxpayerRegistry==" + Left(Me.txtrfc.Text, 10) + ",homonimia==" + Right(Me.txtrfc.Text, 3) + ",postalCode==" + Me.txtcp.Text + ",birthDate==" + FechaN + ")&$fields=id,person(id,segment)"
                Dim respuestaBC As String = restGT.ConnectionGet(userID, iv_ticket1, String.Empty)

                Dim serializerBC As New System.Web.Script.Serialization.JavaScriptSerializer()
                Dim jresultBC = serializerBC.Deserialize(Of Customer)(respuestaBC)

                ''Error
                Dim srrSerialer As New System.Web.Script.Serialization.JavaScriptSerializer()
                Dim alert = srrSerialer.Deserialize(Of msjerr)(respuestaBC)

                If restGT.IsError Then
                    If restGT.MensajeError <> "" Then
                        MensajeError("Error de WS - " & restGT.MensajeError)
                    Else
                        MensajeError("Error de WS - " & alert.message & " Estatus: " & alert.status & ".")
                    End If
                    Exit Sub
                End If



                Dim Cliente_BBVA As String = jresultBC.Person.id
                Dim segment As String = jresultBC.Person.segment.name.id



                If Cliente_BBVA <> "" Then

                    '    ''************************************  CONSULTA PREAPROBADOS   ************************
                    '    MensajeError("Entra Preaprobados")


                    restGT.Uri = System.Configuration.ConfigurationManager.AppSettings.Item("Loans") + "listLoanAlternatives/?customerId=" + Cliente_BBVA + ""
                    Dim respuestaCP As String = restGT.ConnectionGet(userID, iv_ticket1, String.Empty)
                    'Dim respuesta = "{""loanAlternatives"":[{""productAmount"":{""amount"":""214,100.00""},""subproductDescription"":""ADULTOS MAYORES (>=70 A#OS)"",""monthlyPayment"":""10,392.88"",""referenceNumber"":54665,""loanBase"":{""loan"":{""loanProduct"":{""term"":{""timeUnit"":{""name"":""36""}},""interestRate"":""39.50%""}},""subProductCode"":""CP35"",""productDescription"":""PRESTAMO PERSONAL INMEDIATO"",""productCode"":""0PPI""}},{""productAmount"":{""amount"":""266,500.00""},""subproductDescription"":""PRE EVALUADOS > 10K"",""monthlyPayment"":""10,240.00"",""referenceNumber"":54665,""loanBase"":{""loan"":{""loanProduct"":{""term"":{""timeUnit"":{""name"":""60""}},""interestRate"":""39.50%""}},""subProductCode"":""CP47"",""productDescription"":""PRESTAMO PERSONAL INMEDIATO"",""productCode"":""0PPI""}},{""productAmount"":{""amount"":""392,800.00""},""subproductDescription"":""SEM MED PREAPROB SUC 12Y13 13.75 12A48 E"",""referenceNumber"":54665,""loanBase"":{""loan"":{""loanProduct"":{""term"":{""timeUnit"":{""name"":""60 MESES""}},""interestRate"":""16.22%""}},""subProductCode"":""5952"",""productDescription"":""AUTO"",""productCode"":""AUTO""}},{""productAmount"":{""amount"":""402,900.00""},""subproductDescription"":""PREAPROBADO F- PER SUC 11.99% 12A60 E"",""referenceNumber"":54665,""loanBase"":{""loan"":{""loanProduct"":{""term"":{""timeUnit"":{""name"":""60 MESES""}},""interestRate"":""15.06%""}},""subProductCode"":""5953"",""productDescription"":""AUTO"",""productCode"":""AUTO""}}]}"

                    Dim serializer As New System.Web.Script.Serialization.JavaScriptSerializer()
                    Dim jresult = serializer.Deserialize(Of loanAlternativesBase)(respuestaCP)

                    ''Error
                    Dim srrSerialer2 As New System.Web.Script.Serialization.JavaScriptSerializer()
                    Dim alert2 = srrSerialer.Deserialize(Of msjerr)(respuestaCP)

                    If restGT.IsError Then
                        If restGT.MensajeError <> "" Then
                            MensajeError(restGT.MensajeError)
                        Else
                            MensajeError(alert2.message & " Estatus: " & alert2.status & ".")
                        End If
                        Exit Sub
                    End If


                    For i As Integer = 0 To jresult.loanAlternatives.Count - 1
                        If jresult.loanAlternatives(i).loanBase.productCode = "AUTO" Then

                            tasa = Replace((jresult.loanAlternatives(i).loanBase.loan.loanProduct.interestRate), """", "").Replace("%", "")
                            PlazoDes = jresult.loanAlternatives(i).loanBase.loan.loanProduct.term.timeUnit.name

                            Dim existe = 0
                            For r = 0 To tableWS.Rows.Count - 1
                                If Val(PlazoDes) = tableWS.Rows(r)("Plazo") Then
                                    Dim tasa2 As Decimal = tableWS.Rows(r)("Tasa")
                                    existe = 1
                                    If tasa < tasa2 Then
                                        tableWS.Rows(r)("Tasa") = tasa
                                        PlazoMod = PlazoMod + PlazoDes.ToString + "|" + tasa.ToString + ", "
                                        ViewState("PlazoMod") = PlazoMod
                                    End If
                                End If
                            Next

                            If existe = 0 Then
                                drCurrentRow = tableWS.NewRow()
                                Dim row As Integer = tableWS.Rows.Count
                                drCurrentRow("RowNumber") = tableWS.Rows.Count + 1
                                tableWS.Rows.Add(drCurrentRow)
                                tableWS.Rows(row)("Origen") = "WS"
                                tableWS.Rows(row)("SubProducto") = jresult.loanAlternatives(i).loanBase.productCode
                                tableWS.Rows(row)("Tasa") = tasa
                                tableWS.Rows(row)("Plazo") = Val(PlazoDes)
                            End If
                        End If
                    Next





                    If jresult.loanAlternatives.Count = 0 And 1 = 0 Then 'Se apaga temporalmente el Sudoku

                        '    ''************************************  MEJOR PROPUESTA (SUDOKU)  ************************
                        '    MensajeError("Entra SUDOKU")

                        restGT.Uri = System.Configuration.ConfigurationManager.AppSettings.Item("Loans") + "getBestLoanProposal?customerId=" + Cliente_BBVA + "&segment=" + segment + ""
                        restGT.buscarHeader("ResponseWarningDescription")

                        Dim respuestaMP As String = restGT.ConnectionGet(userID, iv_ticket1, String.Empty)
                        'jresult = serializer.Deserialize(Of loanAlternativesBase)(respuestaMP)
                        Dim jresul2 As loanBase = serializer.Deserialize(Of loanBase)(respuestaMP)

                        ''Error
                        Dim srrSerialer3 As New System.Web.Script.Serialization.JavaScriptSerializer()
                        Dim alert3 = srrSerialer.Deserialize(Of msjerr)(respuestaCP)
                        Dim Header As String = restGT.valorHeader
                        Dim valor1 As Integer = 0

                        If (jresul2.extendedData Is Nothing) Then
                            valor1 = 1
                        End If

                        If valor1 = 1 Then
                            MensajeError(Header)
                            Exit Sub
                        End If


                        If restGT.IsError Then
                            If restGT.MensajeError <> "" Then
                                MensajeError(restGT.MensajeError)
                            Else
                                MensajeError(alert3.message & " Estatus: " & alert3.status & ".")
                            End If
                            Exit Sub
                        End If

                        tasa = Left(jresul2.loan.loanProduct.interestRate, 3) + "." + Right(jresul2.loan.loanProduct.interestRate, 4)
                        PlazoDes = Val(Right(jresul2.extendedData.termNumber, 3))

                        Dim existe = 0
                        For r = 0 To tableWS.Rows.Count - 1
                            If Val(PlazoDes) = tableWS.Rows(r)("Plazo") Then
                                Dim tasa2 As Decimal = tableWS.Rows(r)("Tasa")
                                existe = 1
                                If tasa < tasa2 Then
                                    tableWS.Rows(r)("Tasa") = tasa
                                    PlazoMod = PlazoMod + PlazoDes.ToString + "|" + tasa.ToString + ", "
                                    ViewState("PlazoMod") = PlazoMod
                                End If
                            End If
                        Next

                        If existe = 0 Then
                            drCurrentRow = tableWS.NewRow()
                            Dim row As Integer = tableWS.Rows.Count
                            drCurrentRow("RowNumber") = tableWS.Rows.Count + 1
                            tableWS.Rows.Add(drCurrentRow)
                            tableWS.Rows(row)("Origen") = "WS"
                            tableWS.Rows(row)("SubProducto") = jresul2.productCode
                            tableWS.Rows(row)("Tasa") = tasa
                            tableWS.Rows(row)("Plazo") = Val(PlazoDes)
                        End If

                    End If

                    If MejorPropuesta <> "" Then
                        MensajeError(MejorPropuesta)
                    End If

                    dst.Tables.Add(tableWS)
                    ViewState("MulPlazosMerge") = tableWS

                End If
                If (IsNothing(dst)) Then

                    For x = 0 To dst.Tables(0).Rows.Count - 1
                        If Val(ddlplazos.SelectedItem.Text) = Val(dst.Tables(0).Rows(x)("Plazo")) Then
                            Me.txttasa.Text = dst.Tables(0).Rows(x)("Tasa")
                        End If
                    Next

                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
        ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
        CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), Val(ddlplazos.SelectedItem.Text), CDbl(txtporeng.Text.Trim), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, id_prod)

            Catch ex As Exception
                MensajeError(ex.Message)
                Exit Sub
            End Try
        Else
            MensajeError("RFC o CP incompleto")
            Me.txtcp.Focus()
            Exit Sub
        End If
    End Sub
    Public Class loanAlternativesBase
        Public loanAlternatives As New List(Of loanAlternatives)
    End Class

    Public Class loanAlternatives
        Public productAmount As productAmount
        Public subproductDescription As String
        Public monthlyPayment As String
        Public referenceNumber As Integer
        Public loanBase As loanBase
    End Class

    Public Class productAmount
        Public amount As String
    End Class

    Public Class loanBase
        Public loan As loan
        Public subProductCode As String
        Public productDescription As String
        Public productCode As String
        Public extendedData As extendedData

    End Class

    Public Class loan
        Public loanProduct As loanProduct
    End Class

    Public Class loanProduct
        Public term As term
        Public interestRate As String
    End Class

    Public Class term
        Public timeUnit As timeUnit
    End Class

    Public Class timeUnit
        Public name As String
    End Class

    Public Class extendedData
        Public termNumber As String
    End Class
    Public Class Customer
        Public Person As Person = New Person

    End Class
    Public Class Person
        Public id As String
        Public segment As segment = New segment
    End Class
    Public Class segment
        Public name As name = New name
    End Class

    Public Class name
        Public id As String
    End Class
    Public Class msjerr
        Public message As String
        Public status As String
    End Class
    Public Sub Personalidad()
        If Val(ddlpj.SelectedValue) = 15 Then
            'txtnombrectepf.Visible = False
            txtnombrecte.Style.Clear()
            txtnombrectepf.Style.Clear()
            txtnombrecte.Style.Add("display", "block")
            txtnombrectepf.Style.Add("display", "none")
        Else
            txtnombrecte.Style.Clear()
            txtnombrectepf.Style.Clear()
            txtnombrectepf.Style.Add("display", "block")
            txtnombrecte.Style.Add("display", "none")
        End If
    End Sub
    Private Function ValidaDatosCliente() As Boolean

        ValidaDatosCliente = False
        Dim objVal As New SNProcotiza.clsValidaCampo

        If chkdatoscte.Checked = True Then
            If ddlpj.SelectedValue = 15 Then
                If (Len(txtnombrecte.Text)) < 3 Then
                    strErr = "Debe ingresar al menos 3 caracteres."
                    txtnombrecte.Focus()
                    Exit Function
                End If
            Else
                If (Len(txtnombrecte.Text)) < 2 Then
                    strErr = "Debe ingresar al menos 2 caracteres."
                    txtnombrectepf.Focus()
                    Exit Function
                End If
                If (txtfecnac.Text) = "" Then
                    strErr = "El campo fecha es obligatorio"
                    txtfecnac.Focus()
                    Exit Function
                End If
                If (Len(txttelfijo.Text)) > 0 And (Len(txttelfijo.Text)) < 10 Then
                    strErr = "El teléfono debe contener 10 caracteres."
                    txttelfijo.Focus()
                    Exit Function
                End If
                If (Len(txttelmovil.Text)) > 0 And (Len(txttelmovil.Text)) < 10 Then
                    strErr = "El teléfono debe contener 10 caracteres."
                    txttelmovil.Focus()
                    Exit Function
                End If
            End If

            'BUG-PC-24 MAUT 14/12/2016 Se valida el nombre del cliente
            If (txtnombrecte.Text) = "" Then
                strErr = "Debe ingresar el nombre del cliente."
                txtnombrecte.Focus()
                Exit Function
            End If

            If (txtrfc.Text) = "" Then
                strErr = "El RFC ingresado no tiene el formato correcto."
                txtrfc.Focus()
                Exit Function
            End If

            If ddlpj.SelectedValue = 15 Then 'Morales
                If txtrfc.Text.Trim.Length < 9 Then
                    strErr = "El RFC no tiene la longitud correcta."
                    Exit Function
                End If

            Else 'Fisicas
                If txtrfc.Text.Trim.Length < 10 Then
                    strErr = "El RFC no tiene la longitud correcta."
                    Exit Function
                End If
            End If

            If (txtcp.Text = "" Or Len(txtcp.Text) < 5) Then
                strErr = "El Código Postal debe contener 5 caracteres."
                txtcp.Focus()
                Exit Function
            End If
            If txtmail.Text <> "" Then
                objVal.ValidaEmail(txtmail.Text)
            End If
        End If


        ValidaDatosCliente = True
    End Function

    Private Function obten_broker() As Integer
        Dim brokerid As Integer
        objAge = New SNProcotiza.clsAgencias()
        objAge.CargaAgencia(ddlagencia.SelectedValue)

        If objAge.ErrorAgencia <> "" Then
            strErr = objAge.ErrorAgencia
            Exit Function
        End If

        Dim objAlianza As New SNProcotiza.clsAlianzas
        objAlianza.CargaAlianza(objAge.IDAlianza)

        If objAlianza.ErrorAlianza <> "" Then
            strErr = objAlianza.ErrorAlianza
            Exit Function
        End If

        Dim objBroker As New SNProcotiza.clsBrokerSeguros()
        objBroker.CargaBroker(objAlianza.IDBroker)

        If objBroker.ErrorBroker <> "" Then
            strErr = objBroker.ErrorBroker
            Exit Function
        End If

        brokerid = objBroker.IDBroker
        Return brokerid

    End Function

    Private Function GuardaDetSeg(IDSeg As Integer) As Boolean
        GuardaDetSeg = False
        Dim _Chk As CheckBox
        Dim Request As String = String.Empty

        For i = 0 To grvSeguro.Rows.Count - 1
            If grvSeguro.Rows(i).RowType = DataControlRowType.DataRow Then

                _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")
                If _Chk.Checked = True Then
                    Request = grvSeguro.Rows(i).Cells(15).Text
                End If
            End If
        Next

        Dim dtrecibos As New DataTable

        dtrecibos = ViewState("dtsREcibos")

        Dim objrecibos As New SNProcotiza.clsSeguroDetalle()
        Dim brokerid As Integer = obten_broker()

        If brokerid = 2 Then
            For i As Integer = 0 To dtrecibos.Rows.Count - 1
                Dim objwcf As WCF.clsDeserialOrdas = New WCF.clsDeserialOrdas()
                Dim insurerid As String = objwcf.Obteninsurerid(ddlaseguradora.SelectedValue)

                If dtrecibos.Rows(i).Item("idRequest") = Request.ToString And insurerid = dtrecibos.Rows(i).Item("insurerId") Then
                    objrecibos.SEG_FL_CVE = IDSeg
                    Dim idrecibo() As String = Split(dtrecibos.Rows(i).Item("serialNumber"))
                    objrecibos.ID_RECIBO = Val(idrecibo(0))
                    objrecibos.SEG_NO_PRIMANETA = dtrecibos.Rows(i).Item("realPremium")
                    objrecibos.SEG_NO_RECARGO = 0.00
                    objrecibos.SEG_NO_DERECHO = dtrecibos.Rows(i).Item("shippingCosts")
                    objrecibos.SEG_NO_IVA = dtrecibos.Rows(i).Item("tax")
                    objrecibos.SEG_NO_PRIMATOTAL = dtrecibos.Rows(i).Item("totalPremium")
                    objrecibos.SEG_TIPO_SEGURO = 2

                    objrecibos.ManejaDetalleSeg(2)
                End If
            Next
        ElseIf (usaMulticotiza = 1 AndAlso brokerid = 4) Then 'BUG-PC-187
            For i As Integer = 0 To dtrecibos.Rows.Count - 1

                If dtrecibos.Rows(i).Item("idRequest") = Request.ToString Then
                    objrecibos.SEG_FL_CVE = IDSeg
                    Dim idrecibo() As String = Split(dtrecibos.Rows(i).Item("serialNumber"))
                    objrecibos.ID_RECIBO = Val(idrecibo(0))
                    objrecibos.SEG_NO_PRIMANETA = dtrecibos.Rows(i).Item("realPremium")
                    objrecibos.SEG_NO_RECARGO = dtrecibos.Rows(i).Item("lateFee")
                    objrecibos.SEG_NO_DERECHO = dtrecibos.Rows(i).Item("shippingCosts")
                    objrecibos.SEG_NO_IVA = dtrecibos.Rows(i).Item("tax")
                    objrecibos.SEG_NO_PRIMATOTAL = dtrecibos.Rows(i).Item("totalPremium")
                    objrecibos.SEG_TIPO_SEGURO = 2

                    objrecibos.ManejaDetalleSeg(2)
                End If
            Next
        Else
            For i As Integer = 0 To dtrecibos.Rows.Count - 1

                If dtrecibos.Rows(i).Item("idRequest") = Request.ToString Then
                    objrecibos.SEG_FL_CVE = IDSeg
                    Dim idrecibo() As String = Split(dtrecibos.Rows(i).Item("serialNumber"))
                    objrecibos.ID_RECIBO = Val(idrecibo(0))
                    objrecibos.SEG_NO_PRIMANETA = dtrecibos.Rows(i).Item("realPremium")
                    objrecibos.SEG_NO_RECARGO = 0.0
                    objrecibos.SEG_NO_DERECHO = dtrecibos.Rows(i).Item("shippingCosts")
                    objrecibos.SEG_NO_IVA = dtrecibos.Rows(i).Item("tax")
                    objrecibos.SEG_NO_PRIMATOTAL = dtrecibos.Rows(i).Item("totalPremium")
                    objrecibos.SEG_TIPO_SEGURO = 2

                    objrecibos.ManejaDetalleSeg(2)
                End If
            Next
        End If
        'If ddlsegvida.SelectedValue <> 172 Then
        '    objrecibos.ID_RECIBO = 1
        '    objrecibos.SEG_NO_PRIMANETA = Math.Truncate((CDbl(Session("montoSegVida")) / 1.16) * 100) / 100
        '    objrecibos.SEG_NO_RECARGO = 0.0
        '    objrecibos.SEG_NO_DERECHO = 0.0
        '    objrecibos.SEG_NO_IVA = Math.Truncate(((Math.Truncate((CDbl(Session("montoSegVida")) / 1.16) * 100) / 100) * 0.16) * 100) / 100
        '    objrecibos.SEG_NO_PRIMATOTAL = CDbl(Session("montoSegVida"))
        '    objrecibos.SEG_TIPO_SEGURO = 3

        '    objrecibos.ManejaDetalleSeg(2)
        'End If

        GuardaDetSeg = True

        Return GuardaDetSeg
    End Function

    Public Function CalculaMontoSubsidio(ByRef vpnInteresPrimerRecibo As Double, ByRef vpnSumatoriaInt As Double,
                                        ByRef montoFinanciadoAuto As Double, ByRef tasaSubsidio As Double, ByRef tasaPaquete As Double) As Double

        Dim nTasaMinima As Double
        Dim nTasaMaxima As Double
        Dim montoSubsidiado As Double
        Dim nTasaResultado As Double
        Dim factor As Double
        Dim nValorActual As Double
        Dim nValorFuturo As Double
        Dim nPorcionMonto As Double
        Dim nResultado As Double
        Dim tasaIteracion As Double
        Dim tasaMensual As Double

        If tasaPaquete < tasaSubsidio Then
            strErr = "Subsidio fuera de rango"
            Exit Function
        End If
        montoSubsidiado = 0
        nTasaMinima = 0
        nTasaMaxima = 100
        factor = vpnInteresPrimerRecibo / vpnSumatoriaInt

        For iteracion As Integer = 1 To 1200
            tasaIteracion = (nTasaMaxima + nTasaMinima) / 2
            montoSubsidiado = montoFinanciadoAuto * (tasaIteracion / 100)
            nPorcionMonto = factor * montoSubsidiado
            nValorActual = vpnInteresPrimerRecibo - nPorcionMonto
            tasaMensual = (30 / 360) * (tasaPaquete / 100)
            nValorFuturo = nValorActual * (1 + tasaMensual)
            nTasaResultado = ((360 / 30) * 100) * (nValorFuturo / montoFinanciadoAuto)
            nResultado = nTasaResultado - tasaSubsidio

            If nResultado < 0 Then
                nTasaMaxima = tasaIteracion
            ElseIf nResultado > 0.000000000 Then
                nTasaMinima = tasaIteracion
            Else
                Exit For
            End If
        Next
        Return montoSubsidiado
    End Function

    Public Function CalculaTasaSubsidio(ByVal tasaPaquete As Double, ByVal montoSub As Double, ByVal plazo As Integer, ByVal montoFinanciadoAuto As Double) As Double
        Dim dts As New DataSet()
        Dim Sql As New StringBuilder

        Dim interesSub As Double = 0
        Dim tasaSubsidioAux As Double = 0
        Dim tasaSubsidioAuto As Double = 0

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

        Sql.AppendLine("Exec procCalculaTasaSubsidio " & CDbl(montoFinanciadoAuto) & ", " & objPlazos.Valor & ", " & txttasa.Text.Trim & ", 83")

        Dim objsubsidio As SDManejaBD.clsConexion = New SDManejaBD.clsConexion()
        dts = objsubsidio.EjecutaQueryConsulta(Sql.ToString)


        Dim montoSubsidioTasaCero As Double = CalculaMontoSubsidio(dts.Tables(0).Rows(0).Item("interesPrimerRecibo"), dts.Tables(0).Rows(0).Item("sumatoriaInt"), CDbl(txtprecio.Text.Trim), CDbl(0.00), txttasa.Text.Trim)

        If montoSub <= montoSubsidioTasaCero Then
            interesSub = tasaPaquete * montoSub
            tasaSubsidioAux = interesSub / montoSubsidioTasaCero
            tasaSubsidioAuto = tasaPaquete - tasaSubsidioAux
            If tasaPaquete < tasaSubsidioAuto Then
                strErr = "Subsidio fuera de rango"
                Exit Function
            End If
        Else
            strErr = "Subsidio fuera de rango"
            Exit Function
        End If

        Return tasaSubsidioAuto
    End Function

    Private Sub txtporsub_TextChanged(sender As Object, e As EventArgs) Handles txtporsub.TextChanged
        Dim dts As New DataSet()
        Dim Sql As New StringBuilder

        If txtporsub.Text.Length = 0 Then
            txtmtosub.Text = ""
            Exit Sub
        End If

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

        Sql.AppendLine("Exec procCalculaTasaSubsidio " & CDbl(txtprecio.Text.Trim - txtenganche.Text.Trim) & ", " & objPlazos.Valor & ", " & txttasa.Text.Trim & ", 83")

        Dim objsubsidio As SDManejaBD.clsConexion = New SDManejaBD.clsConexion()
        dts = objsubsidio.EjecutaQueryConsulta(Sql.ToString)


        Dim dblSubsidio As Double = CalculaMontoSubsidio(dts.Tables(0).Rows(0).Item("interesPrimerRecibo"), dts.Tables(0).Rows(0).Item("sumatoriaInt"), CDbl(txtprecio.Text.Trim - txtenganche.Text.Trim), txtporsub.Text.Trim, CDbl(txttasa.Text.Trim))
        If strErr <> "" Then
            txtporsub.Text = ""
            txtmtosub.Text = ""
            MensajeError(strErr)
        Else
            txtmtosub.Text = (Math.Truncate(dblSubsidio * 100) / 100).ToString("###,##0.00")
        End If
        'Subsidio(txtporsub.Text)  'MUAA
    End Sub

    Private Sub txtmtosub_TextChanged(sender As Object, e As EventArgs) Handles txtmtosub.TextChanged
        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

        Dim dblTasaSub As Double = CalculaTasaSubsidio(txttasa.Text.Trim, CDbl(txtmtosub.Text.Trim), objPlazos.Valor, CDbl(txtprecio.Text.Trim) - CDbl(txtenganche.Text.Trim))
        If strErr <> "" Then
            txtporsub.Text = ""
            txtmtosub.Text = ""
            MensajeError(strErr)
        Else
            txtporsub.Text = CDbl(dblTasaSub).ToString("###,##0.00")
        End If
        'Subsidio(txtporsub.Text) 'MUAA
    End Sub

    Public Sub AgregaAccesorios(ByVal intopc As Integer)
        Dim Registros As Integer = grvAccesorios.Rows.Count

        For Each row As GridViewRow In grvAccesorios.Rows

            Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
            Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)
            Dim ddl2 As DropDownList = TryCast(row.FindControl("DropDownList2"), DropDownList)
            Dim imgbtn As ImageButton = DirectCast(row.FindControl("ImageButton1"), ImageButton)

            Select Case intopc

                Case 1 ''Agregar accesorios desde el botón btnagregarprod

                    'Vallidamos si el primer acceosrio ingresado es la Garantia Extendida
                    If ddl1.SelectedValue = 1 Then
                        Continue For
                    End If

                    If Registros >= 1 Then
                        If ddl1.SelectedValue <> 1 And ddl1.Enabled = False Then
                            strErr = "Solo se permite un registro de Accesorios."
                            AccFlag = False
                            Exit Sub
                        End If
                    End If

                    If ddl1.SelectedValue = 0 Or ddl2.SelectedValue = 0 Then
                        strErr = "Debe seleccionar Accesorio y Condición."
                        AccFlag = False
                        Exit Sub
                    End If

                    If Val(txt.Text.Trim) = 0 Then
                        strErr = "El precio no puede ser $0.00"
                        AccFlag = False
                        Exit Sub
                    End If

                    If Not ValidaMontoAcc() Then
                        txt.Text = ""
                        AccFlag = False
                        Exit Sub
                    End If

                    If ddl2.SelectedValue = 160 Then
                        AccFinan = AccFinan + CDbl(txt.Text.Trim())
                    ElseIf ddl2.SelectedValue = 161 Then
                        AccConta = AccConta + CDbl(txt.Text.Trim())
                    End If
                    '02032017
                    If Val(txtmtogarantia.Text.Trim) > 0 Then
                        AccFinan = AccFinan + CDbl(txtmtogarantia.Text.Trim())
                    End If

                    AddNewRowToGrid()

                Case 2 ''Agregar Garantia Extendida

                    If ddlGarantia.SelectedValue > 0 And Val(txtmtogarantia.Text.Trim) = 0 Then
                        strErr = "El monto de la Garantia Extendida no puede ser 0.00"
                        AccFlag = False
                        Exit Sub
                    End If

                    If ddlGarantia.SelectedValue = 0 And Val(txtmtogarantia.Text.Trim) > 0 Then
                        strErr = "El plazo de la Garantia Extendida no es valido."
                        AccFlag = False
                        Exit Sub
                    End If
                    'If Not ValidaMontoGarantia(CDbl(txtmtogarantia.Text)) Then
                    'ddlGarantia.SelectedValue = 0
                    'txtmtogarantia.Text = ""
                    'AccFlag = False
                    'Exit Sub
                    'End If
                    If ddlGarantia.SelectedValue > 0 And Val(txtmtogarantia.Text.Trim) > 0 Then
                        '02032017
                        AccFinan = AccFinan + CDbl(txtmtogarantia.Text.Trim())
                        AddNewRowToGrid(1)
                    End If
            End Select
        Next

        For Each row As GridViewRow In grvAccesorios.Rows
            Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
            If txt.Text <> "" Then
                total = total + CDbl(txt.Text.Trim())
            End If
        Next


        '02032017
        lblAccFinan.Text = Val(total)
        lblAccConta.Text = Val(AccConta)
        lbltotalacc.Text = Val(total).ToString("###,##0.00")

    End Sub

    Protected Sub ddlengancheCI_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlengancheCI.SelectedIndexChanged
        Dim datos(0 To 2) As Integer
        txtporsub.Text = ""
        txtmtosub.Text = ""

        txtporeng.Text = ddlengancheCI.SelectedItem.Text
        lblengmin.Text = ddlengancheCI.SelectedItem.Text
        Dim dtsResver As New DataSet
        Dim clsver As New clsVersiones
        clsver.IDVersion = ddlversion.SelectedValue
        clsver.Plazo = ddlplazos.SelectedValue
        clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)

        dtsResver = clsver.ManejaVersion(9)
        If dtsResver.Tables.Count > 0 And dtsResver.Tables(0).Rows.Count > 0 Then
            txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
            txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            txtporeng_TextChanged(txtporeng, Nothing)
        Else
            ddlplazos_SelectedIndexChanged(ddlplazos, Nothing)
            MensajeError("El enganche CI seleccionado ya no existe")
        End If
    End Sub

    Protected Sub txtnombrectepf_TextChanged(sender As Object, e As EventArgs) Handles txtnombrectepf.TextChanged
        If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
            WS()
        End If
    End Sub

    Protected Sub txtpaterno_TextChanged(sender As Object, e As EventArgs) Handles txtpaterno.TextChanged
        If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
            WS()
        End If
    End Sub

    Protected Sub txtfecnac_TextChanged(sender As Object, e As EventArgs) Handles txtfecnac.TextChanged
        If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
            WS()
        End If
    End Sub

    Protected Sub txtrfc_TextChanged(sender As Object, e As EventArgs) Handles txtrfc.TextChanged
        If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
            WS()
        End If
    End Sub

    Protected Sub txtnombrecte2_TextChanged(sender As Object, e As EventArgs) Handles txtnombrecte2.TextChanged
        If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
            WS()
        End If
    End Sub

    Protected Sub txtmaterno_TextChanged(sender As Object, e As EventArgs) Handles txtmaterno.TextChanged
        If (txtnombrectepf.Text <> "" And txtpaterno.Text <> "" And txtfecnac.Text <> "" And txtrfc.Text <> "" And txtcp.Text <> "") Then
            WS()
        End If
    End Sub
    Private Sub ddlGarantia_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlGarantia.SelectedIndexChanged

        Dim brokerid As Integer = obten_broker()
        Dim dts As New DataTable
        dts = CType(ViewState("dtsGarantia"), DataTable)
        If brokerid = 2 Then
            If ViewState("dtsGarantia") Is Nothing Then
                If ObtenGarantiaOrdas() = False Then
                    If strErr <> "" Then
                        MensajeError(strErr)
                        Exit Sub
                    Else
                        MensajeError("No se pudo recuperar información de Garantia Extendida.")
                        Exit Sub
                    End If
                End If
            End If
        End If

        If ddlGarantia.SelectedValue = 0 Then
            If Val(txtmtogarantia.Text) > 0 Then
                For Each row As GridViewRow In grvAccesorios.Rows
                    Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
                    Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)

                    If ddl1.SelectedItem.Text = "GARANTIA EXTENDIDA" Then
                        EliminaGarantiaExt(row.RowIndex)
                    End If
                Next
            End If
            txtmtogarantia.Text = ""
        Else
            If brokerid = 2 Then
                Dim dttplazogar As New DataTable
                dttplazogar = DirectCast(ViewState("dtsGarantia"), DataTable)

                For i As Integer = 0 To dttplazogar.Rows.Count - 1
                    Dim coverid As String = dttplazogar.Rows(i).Item("idPack").ToString

                    Select Case coverid
                        Case "3627" '12 Meses ' se agrega garantia de 12 meses cambio urgente rhernandez
                            If ddlGarantia.SelectedValue = "12" Then
                                txtmtogarantia.Text = dttplazogar.Rows(i).Item("totalPremium").ToString
                                txtmtogarantia_TextChanged(txtmtogarantia, EventArgs.Empty)
                            End If
                        Case "3629" '24 Meses
                            If ddlGarantia.SelectedValue = "24" Then
                                txtmtogarantia.Text = dttplazogar.Rows(i).Item("totalPremium").ToString
                                txtmtogarantia_TextChanged(txtmtogarantia, EventArgs.Empty)
                            End If
                        Case "3639" '36 Meses
                            If ddlGarantia.SelectedValue = "36" Then
                                txtmtogarantia.Text = dttplazogar.Rows(i).Item("totalPremium").ToString
                                txtmtogarantia_TextChanged(txtmtogarantia, EventArgs.Empty)
                            End If
                    End Select

                Next

            Else
                txtmtogarantia.Focus()
            End If
        End If
    End Sub

    Private Sub txtmtogarantia_TextChanged(sender As Object, e As EventArgs) Handles txtmtogarantia.TextChanged

        Dim contador As Integer = 0
        If Val(txtmtogarantia.Text) = 0 And ddlGarantia.SelectedValue <> 0 Then
            MensajeError("El monto de la Garantia Extendida no puede ser $0.00")
            Exit Sub
        Else

            For Each row As GridViewRow In grvAccesorios.Rows
                Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
                Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)
                If Not IsNothing(ddl1.SelectedItem) Then
                    If ddl1.SelectedItem.Text = "GARANTIA EXTENDIDA" Then
                        If Val(txt.Text) <> Val(txtmtogarantia.Text) Then
                            txt.Text = txtmtogarantia.Text
                            contador = contador + 1
                        End If
                    End If
                End If
            Next

            If contador = 0 Then
                AgregaAccesorios(2)
                If strErr <> "" Then
                    MensajeError(strErr)
                    Exit Sub
                End If
            End If
        End If

        Dim totacc As Double = 0
        For Each row As GridViewRow In grvAccesorios.Rows
            Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
            totacc = totacc + Val(txt.Text.Trim)
        Next
        lbltotalacc.Text = totacc.ToString("###,##0.00")


        If Not grvSeguro.Rows.Count > 0 Then
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
        Else

            Dim intbroker As Integer = obten_broker()
            Dim cad As String = String.Empty
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                For j As Integer = 0 To grvSeguro.Rows.Count - 1
                    cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                Next
            End If
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
        ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                    CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                    IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                    ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                    0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                    ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

        End If

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        Dim MulPlazos As DataSet
        Dim Plazo As String
        Dim Monto As Decimal
        Dim Concepto As String

        MulPlazos = ViewState("MulPlazos")
        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
            If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                    If Concepto = "Pago" Then
                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                    End If
                Next
            End If
        Next
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.ErrorPaquete = "" Then
            txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
        Else
            strErr = objPaq.ErrorPaquete
            Exit Sub
        End If

        If chkPagosEsp.Checked = True Then
            btnAplicaPE_Click(btnAplicaPE, Nothing)
        End If

        grvSeguro.DataBind()
        finseg.Visible = False

    End Sub

    Public Sub EliminaGarantiaExt(ByVal Row As Integer)

        Dim rowID As Integer = Row
        Dim acc As String = String.Empty
        Dim drCurrentRow As DataRow = Nothing

        If ViewState("CurrentTable") IsNot Nothing Then

            Dim dt As DataTable = DirectCast(ViewState("CurrentTable"), DataTable)
            If dt.Rows.Count > 1 Then
                If rowID < dt.Rows.Count - 1 Then

                    acc = dt.Rows(rowID).Item("Column1").ToString
                    'Remove the Selected Row data and reset row number  
                    dt.Rows.Remove(dt.Rows(rowID))
                    ResetRowID(dt)

                    If acc <> "GARANTIA EXTENDIDA" Then
                        drCurrentRow = dt.NewRow()
                        drCurrentRow("RowNumber") = dt.Rows.Count + 1
                        'add new row to DataTable   
                        dt.Rows.Add(drCurrentRow)
                    End If
                Else
                    acc = dt.Rows(rowID).Item("Column1").ToString
                    If acc = "GARANTIA EXTENDIDA" Then
                        dt.Rows.Remove(dt.Rows(rowID))
                        ResetRowID(dt)
                    ElseIf acc <> "GARANTIA EXTENDIDA" And rowID = 1 Then
                        dt.Rows.Remove(dt.Rows(rowID))
                        ResetRowID(dt)
                        drCurrentRow = dt.NewRow()
                        drCurrentRow("RowNumber") = dt.Rows.Count + 1
                        'add new row to DataTable   
                        dt.Rows.Add(drCurrentRow)
                    End If
                End If
            Else
                acc = dt.Rows(rowID).Item("Column1").ToString
                If acc <> "GARANTIA EXTENDIDA" Then
                    dt.Rows(rowID)("Column1") = ""
                    dt.Rows(rowID)("Column2") = ""
                    dt.Rows(rowID)("Column3") = ""
                Else
                    dt.Rows.Remove(dt.Rows(rowID))
                    ResetRowID(dt)
                    drCurrentRow = dt.NewRow()
                    drCurrentRow("RowNumber") = dt.Rows.Count + 1
                    'add new row to DataTable   
                    dt.Rows.Add(drCurrentRow)
                End If

            End If

            'Store the current data in ViewState for future reference
            ViewState("CurrentTable") = dt

            'Re bind the GridView for the updated data  
            grvAccesorios.DataSource = dt
            grvAccesorios.DataBind()
        End If

        If acc = "GARANTIA EXTENDIDA" Then
            ddlGarantia.SelectedValue = 0
            txtmtogarantia.Text = ""
        End If

        'Set Previous Data on Postbacks  
        SetPreviousData()

        For Each rw As GridViewRow In grvAccesorios.Rows
            Dim txt As TextBox = TryCast(rw.FindControl("TextBox1"), TextBox)
            Dim ddl1 As DropDownList = TryCast(rw.FindControl("DropDownList1"), DropDownList)
            Dim ddl2 As DropDownList = TryCast(rw.FindControl("DropDownList2"), DropDownList)
            Dim imgbtn As ImageButton = TryCast(rw.FindControl("ImageButton1"), ImageButton)

            total = total + CDbl(IIf(txt.Text.Trim() = "", 0, txt.Text.Trim()))

            If ddl2.SelectedValue = 160 Then
                AccFinan = AccFinan + CDbl(txt.Text.Trim())
            ElseIf ddl2.SelectedValue = 161 Then
                AccConta = AccConta + CDbl(txt.Text.Trim())
            End If
        Next

        lbltotalacc.Text = Val(total).ToString("###,##0.00")
        '02032017
        lblAccFinan.Text = Val(total)
        lblAccConta.Text = Val(AccConta)

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        If objPlazos.StrErrPlazo = "" Then

            prodid = ObtenProducto()
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, prodid)
        Else
            MensajeError(objPlazos.StrErrPlazo)
            Exit Sub
        End If

    End Sub

    Private Sub ddlsegvida_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlsegvida.SelectedIndexChanged

        If ddlsegvida.SelectedValue = 172 Then
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                btncotizaseg.Enabled = True
            Else
                btncotizaseg.Enabled = False
            End If
            Dim intbroker As Integer = obten_broker()
            Session("montoSegVida") = "0.00"
            Session("idquotevida") = "0"
            Dim cad As String = String.Empty
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                For j As Integer = 0 To grvSeguro.Rows.Count - 1
                    cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                Next
            End If
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                            ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                            CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                            IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                            ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                            0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                            ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String
            objPlazos.CargaPlazo(ddlplazos.SelectedValue)

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If
        Else
            btncotizaseg.Enabled = True

            Dim intbroker As Integer = obten_broker()
            Dim cad As String = String.Empty
            If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                For j As Integer = 0 To grvSeguro.Rows.Count - 1
                    cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                Next
            End If
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                            ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                            CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                            IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                            ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                            0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                            ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


            Dim MulPlazos As DataSet
            Dim Plazo As String
            Dim Monto As Decimal
            Dim Concepto As String
            objPlazos.CargaPlazo(ddlplazos.SelectedValue)

            MulPlazos = ViewState("MulPlazos")
            For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
                Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
                If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                    For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                        Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                        If Concepto = "Pago" Then
                            Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                        End If
                    Next
                End If
            Next
            objPaq = New clsPaquetes
            objPaq.CargaPaquete(ddlplan.SelectedValue)
            If objPaq.ErrorPaquete = "" Then
                txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
            Else
                strErr = objPaq.ErrorPaquete
                Exit Sub
            End If
        End If
    End Sub

    'MUAA
    Public Sub Subsidio(mtoTasaSubsidiada As Double)
        Dim cadAux As String = ""
        txttasa.Text = mtoTasaSubsidiada
        cadAux = cadAux + ddlplazos.SelectedItem.Text + "|" + txttasa.Text.ToString.Trim + ", "
        ViewState("SubsidioMod") = cadAux

        Dim datos(0 To 2) As Integer
        CalculaEnganche(0)
        LlenaPagEsp(ddlplazos.SelectedValue)
        Session("band") = 0

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.IDTipoCalculo = 167 Then
            ReDim datos(3)
            datos(0) = ddlversion.SelectedValue
            datos(1) = ddlplazos.SelectedValue
            objCombo.LlenaObjs(ddlengancheCI, datos)
            If ddlengancheCI.SelectedValue <> "" And ddlengancheCI.SelectedValue <> 0 Then
                txtporeng.Text = ddlengancheCI.SelectedItem.Text
                lblengmin.Text = ddlengancheCI.SelectedItem.Text
                Dim dtsResver As New DataSet
                Dim clsver As New clsVersiones
                clsver.IDVersion = ddlversion.SelectedValue
                clsver.Plazo = ddlplazos.SelectedValue
                clsver.Enganche = CDbl(ddlengancheCI.SelectedItem.Text)
                dtsResver = clsver.ManejaVersion(9)
                txtporresidual.Text = CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsResver.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            Else
                ddlengancheCI.Enabled = False
                Dim dtsPlazo As New DataSet
                objPaq.IDPlazo = Val(ddlplazos.SelectedValue)
                objPaq.IDPaquete = Val(ddlplan.SelectedValue)
                objPaq.IDEstatusPlazo = 2
                dtsPlazo = objPaq.ManejaPaquete(7)
                txtporresidual.Text = CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")).ToString("###,##0.00")
                txtresidual.Text = Val((CDbl(dtsPlazo.Tables(0).Rows(0).Item("PTJ_BLIND_DISCOUNT")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
            End If
        Else
            Dim dtsRes As New DataSet
            objPaq.IDPaquete = ddlplan.SelectedValue
            objPaq.IDVersion = ddlversion.SelectedValue
            objPaq.IDPlazo = ddlplazos.SelectedValue
            dtsRes = objPaq.ManejaPaquete(50)
            If objPaq.ErrorPaquete = "" Then
                If dtsRes.Tables(0).Rows.Count Then
                    txtporeng.Text = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                    lblengmin.Text = dtsRes.Tables(0).Rows(0).Item("PORC_ENGANCHE")
                    txtporresidual.Text = dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON").ToString("###,##0.00")
                    txtresidual.Text = Val((CDbl(dtsRes.Tables(0).Rows(0).Item("PORC_BALLOON")) / 100) * CDbl(txtprecio.Text.Trim)).ToString("###,##0.00")
                End If
            Else
                MensajeError(objPaq.ErrorPaquete)
                Exit Sub
            End If
        End If
        txtporeng_TextChanged(txtporeng, Nothing)


        If grvSeguro.Rows.Count > 0 Then
            objPlazos.CargaPlazo(ddlplazos.SelectedValue)
            Dim valor As Integer = objPlazos.Valor

            For i = 0 To grvSeguro.Rows.Count - 1
                Dim _Chk As New CheckBox
                _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")

                If valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                    If CDbl(grvSeguro.Rows(i).Cells(15).Text) = 0 Then
                        MensajeError("Debe seleccionar un plazo valido, el Broker no regreso valor de ID_COTIZACION.")
                        _Chk.Enabled = False
                        _Chk.Checked = False
                        Continue For
                    Else
                        _Chk.Enabled = False
                        _Chk.Checked = True
                    End If
                Else
                    _Chk.Enabled = False
                    _Chk.Checked = False
                End If
            Next
        Else
            If Not grvSeguro.Rows.Count > 0 Then
                Dim id_prod As Integer = ObtenProducto()
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue, ddltoperacion.SelectedValue,
                                    ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue, CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim),
                                    objPlazos.Valor, IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
            Else

                Dim intbroker As Integer = obten_broker()
                Dim cad As String = String.Empty
                If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                    For j As Integer = 0 To grvSeguro.Rows.Count - 1
                        cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                    Next
                End If
                Dim id_prod As Integer = ObtenProducto()
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)

            End If
        End If

        objPlazos.CargaPlazo(ddlplan.SelectedValue)
        Dim MulPlazos As DataSet
        Dim Plazo As String
        Dim Monto As Decimal
        Dim Concepto As String

        MulPlazos = ViewState("MulPlazos")
        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
            If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                    If Concepto = "Pago" Then
                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                    End If
                Next
            End If
        Next
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.ErrorPaquete = "" Then
            txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
        Else
            strErr = objPaq.ErrorPaquete
            Exit Sub
        End If

        If chkPagosEsp.Checked = True Then
            btnAplicaPE_Click(btnAplicaPE, Nothing)
        End If
    End Sub

    Private Sub OcultaColumnas(ByVal intopc As Integer)
            Select Case intopc
                Case 1 ''Oculta
                    grvSeguro.Columns(2).Visible = False ''PRIMA NETA
                    grvSeguro.Columns(3).Visible = False ''RECARGO
                    grvSeguro.Columns(4).Visible = False ''DERECHO
                    grvSeguro.Columns(5).Visible = False ''IVA
                    grvSeguro.Columns(9).Visible = False ''USO
                    grvSeguro.Columns(10).Visible = False ''URL Cotizacion
                    grvSeguro.Columns(11).Visible = False ''PRIMA NETA GAP
                    grvSeguro.Columns(12).Visible = False ''IVA GAP
                    grvSeguro.Columns(13).Visible = False ''SEGURO GAP
                    grvSeguro.Columns(16).Visible = False ''OBSERVACIONES
                    grvSeguro.Columns(17).Visible = False ''PRIMA_TOTAL_SG
                Case 2 ''Muestra
                    grvSeguro.Columns(2).Visible = True ''PRIMA NETA
                    grvSeguro.Columns(3).Visible = True ''RECARGO
                    grvSeguro.Columns(4).Visible = True ''DERECHO
                    grvSeguro.Columns(5).Visible = True ''IVA
                    grvSeguro.Columns(9).Visible = False ''USO
                    grvSeguro.Columns(10).Visible = False ''URL Cotizacion
                    grvSeguro.Columns(11).Visible = True ''PRIMA NETA GAP
                    grvSeguro.Columns(12).Visible = True ''IVA GAP
                    grvSeguro.Columns(13).Visible = True ''SEGURO GAP
                    grvSeguro.Columns(16).Visible = False ''OBSERVACIONES
                    grvSeguro.Columns(17).Visible = False ''PRIMA_TOTAL_SG
            End Select
    End Sub


    Private Function accesorioXfactor() As Double
        Dim totacc As Double = 0
        Try
            For i As Integer = 0 To grvAccesorios.Rows.Count - 1
                Dim box1 As TextBox = DirectCast(grvAccesorios.Rows(i).Cells(3).FindControl("TextBox1"), TextBox)
                Dim ddl1 As DropDownList = DirectCast(grvAccesorios.Rows(i).Cells(1).FindControl("DropDownList1"), DropDownList)

                If ddl1.SelectedValue <> 0 Then
                    If ddl1.SelectedValue <> 1 Then
                        totacc = CDbl(Val(box1.Text.Trim))
                    End If
                End If
            Next
            Return totacc

        Catch ex As Exception
            strErr = "Error al obtener información de accesorios para el cálculo por factor."
            Return totacc
        End Try
    End Function

    Private Sub ddlaseguradora_SelectedIndexChanged(sender As Object, e As EventArgs) Handles ddlaseguradora.SelectedIndexChanged
        Dim brokerid As Integer = obten_broker()
        Dim objPlazos As New SNProcotiza.clsPlazo
        Dim contAseg As Integer = 0
        Dim contPlazo As Integer = 0

        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

        If grvSeguro.Rows.Count = 0 Then
            Return
        End If

        If brokerid = 2 OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then 'RQ-PC5 BUG-PC-191

            For i As Integer = 0 To grvSeguro.Rows.Count - 1
                If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(i).Cells(7).Text Then
                    contAseg = contAseg + 1

                    If objPlazos.Valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                        contPlazo = contPlazo + 1
                    End If

                End If
            Next

            If contAseg = 0 Or contPlazo = 0 Then
                If grvSeguro.Visible = True Then
                    strErr = "La combinación de Aseguradora y/o plazo seleccionado no es válido."
                End If
            End If

            For i As Integer = 0 To grvSeguro.Rows.Count - 1
                Dim _Chk As New CheckBox
                _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")

                If Val(grvSeguro.Rows(i).Cells(15).Text) > 0 Then
                    If objPlazos.Valor = Convert.ToInt16(grvSeguro.Rows(i).Cells(1).Text) Then
                        If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(i).Cells(7).Text Then
                            _Chk.Checked = True
                        Else
                            _Chk.Checked = False
                        End If
                    Else
                        _Chk.Checked = False
                    End If
                Else
                    _Chk.Checked = False
                    Continue For
                End If
            Next
        End If

        Dim cad As String = String.Empty
        If strErr.Length = 0 Then
            If grvSeguro.Rows.Count > 0 Then
                If brokerid = 2 OrElse (usaMulticotiza = 1 AndAlso brokerid = 4) Then 'RQ-PC5 BUG-PC-191
                    If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                        For j As Integer = 0 To grvSeguro.Rows.Count - 1
                            If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(j).Cells(7).Text Then
                                cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                            End If
                        Next
                    End If
                Else
                    If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
                        For j As Integer = 0 To grvSeguro.Rows.Count - 1
                            If ddlaseguradora.SelectedItem.Text = grvSeguro.Rows(j).Cells(7).Text Then
                                cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
                            End If
                        Next
                    End If
                End If
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                1, ddltiposeg.SelectedValue, 1, 1,
                0, 0, mtosegvida, 0, ddlaseguradora.SelectedValue,
                ddledoseg.SelectedValue, brokerid, cad, 0, ddlsegvida.SelectedValue, id_prod)

            Else
                Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
                Dim id_prod As Integer = ObtenProducto()
                LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                    ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                    CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0,
                                    CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
            End If
        Else
            Dim mtosegvida As Double = IIf(Session("montoSegVida").ToString() = "0.00", 0, CType(Session("montoSegVida").ToString(), Double))
            Dim id_prod As Integer = ObtenProducto()
            LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim), CDbl(lblAccConta.Text.Trim), objPlazos.Valor, IIf(Val(Session("band")) = 0, 0,
                                CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue, 0, 0, 0, 0, 0, 0, mtosegvida, 0, 0, 0, 0, "", 0, ddlsegvida.SelectedValue, id_prod)
        End If

        Dim MulPlazos As DataSet
        Dim Plazo As String
        Dim Monto As Decimal
        Dim Concepto As String

        MulPlazos = ViewState("MulPlazos")
        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
            If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                    If Concepto = "Pago" Then
                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                    End If
                Next
            End If
        Next

        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.ErrorPaquete = "" Then
            txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
        Else
            MensajeError(objPaq.ErrorPaquete)
            Exit Sub
        End If

        If strErr.Length > 0 Then
            If ddlaseguradora.SelectedValue = 55 And grvSeguro.Rows.Count > 0 Then
                strErr = "Debe seleccionar una aseguradora de la cotización del Seguro."
            End If
            MensajeError(strErr)
        End If

    End Sub

    Private Function ObtenGarantiaOrdas() As Boolean
        ObtenGarantiaOrdas = False

        Dim dtsgarantia As New DataSet()
        Dim objcotOrdas As New WCF.clsCotSegOrdas()

        Dim totacc As Double = 0

        For Each row In grvAccesorios.Rows
            Dim ddl1 As DropDownList = TryCast(row.FindControl("DropDownList1"), DropDownList)
            Dim txt As TextBox = TryCast(row.FindControl("TextBox1"), TextBox)
            If ddl1.Items.Count > 0 Then
            If ddl1.SelectedValue = 1 Then
                totacc = CDbl(txt.Text.Trim())
                End If
            End If
        Next

        'coverageId "" --> 12 meses --> Pendiente
        'coverageId "3629" --> 24 meses
        'coverageId "3639" --> 36 meses

        Dim cover(0 To 2) As String
        cover(0) = "3627,12"  ' se agrega garantia de 12 meses cambio urgente rhernandez
        cover(1) = "3629,24"
        cover(2) = "3639,36"

        dtsgarantia = objcotOrdas.cotizaGarantia(2, ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue,
                                         ddlversion.SelectedValue, ddlanio.SelectedValue, IIf(Val(txtedad.Text.Trim) = 0, 35, Convert.ToInt16(Val(txtedad.Text.Trim))),
                                         IIf(rdbsexh.Checked = False And rdbsexm.Checked = False, 1, IIf(rdbsexh.Checked = True, 1, 2)), totacc, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                         CDbl(txtprecio.Text.Trim), ddlpj.SelectedValue, ddledoseg.SelectedValue,
                                         txtcprecurrente.Text.Trim, 32, ddlmonedafact.SelectedValue,
                                         IIf(ddltiposeg.SelectedValue = 188, 1, 9), ddlplan.SelectedValue, cover, ddlagencia.SelectedValue)

        If objcotOrdas.StrError <> "" Then
            ViewState("dtsGarantia") = Nothing
            strErr = objcotOrdas.StrError
            Exit Function
        Else
            ViewState("dtsGarantia") = dtsgarantia.Tables(0).Copy()
            ObtenGarantiaOrdas = True
        End If

        Return ObtenGarantiaOrdas
    End Function

    Private Function EmulaCotSegVida() As Boolean
        EmulaCotSegVida = False
        Dim intbroker As Integer = obten_broker()

        If intbroker = 4 Then
            OcultaColumnas(2)
        Else
            OcultaColumnas(1)
        End If
        'Dim objcotizasegdaño As New WCF.clsCotSegBBVA()
        'Dim idveh As String = ObtenidVehicle(intbroker, ddlclasif.SelectedValue, ddlmarca.SelectedValue, ddlmodelo.SelectedValue, ddlversion.SelectedValue, ddlanio.SelectedValue)

        'If idveh = "" Then
        '    strErr = "El producto seleccionado no tiene idenficador para el broker de seguros."
        '    Exit Function
        'End If
        'objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        'Session("idpolBBVA") = objcotizasegdaño.CotizaBBVADaños(ddlanio.SelectedValue, idveh, ddlversion.SelectedItem.Text.ToString, txtprecio.Text.ToString, objPlazos.Valor)
        'If IsNothing(Session("idpolBBVA").ToString) Or Session("idpolBBVA").ToString = "" Then
        '    MensajeError("Error WS: " & objcotizasegdaño.StrError)
        'End If
        Dim valorsegdanios As Double = 0
        Dim montoSegvida As Double
        If ddltiposeg.SelectedValue <> 32 And ddltiposeg.SelectedValue <> 30 And ddltiposeg.SelectedValue <> 76 And ddltiposeg.SelectedValue <> 168 Then
            Dim pos As Integer = 0
            For j As Integer = 0 To grvSeguro.Columns.Count - 1
                If grvSeguro.Columns.Item(j).HeaderText = "PRIMA TOTAL" Then
                    pos = j
                End If
            Next
            For i As Integer = 0 To grvSeguro.Rows.Count - 1
                Dim _Chk As New CheckBox
                _Chk = grvSeguro.Rows(i).Cells(0).FindControl("rdbSel")
                If _Chk.Checked = True Then
                    valorsegdanios = CDbl(grvSeguro.Rows(i).Cells(pos).Text.Trim.ToString)
                End If
            Next
        End If
        
        Dim mtofinancia As Double = (((Val(Trim(Replace(Replace(txtprecio.Text, ",", ""), "$", ""))) * Val(txtUniProd.Text.Trim)) + Val(Trim(Replace(Replace(lbltotalacc.Text, ",", ""), "$", "")))) - CDbl(txtenganche.Text.Trim)) + valorsegdanios
        'Dim datprod As DataSet = ObtenDatProducto()
        'If (datprod.Tables(0).Rows(0).Item("ID_TIPO_PRODUCTO").ToString = "1") Then
        'If CDbl(mtofinancia) <= 800000.99 Then
        '    montoSegvida = 3500.0
        'ElseIf CDbl(mtofinancia) >= 800001 And CDbl(mtofinancia) <= 2000000.99 Then
        '    montoSegvida = 15400.0
        'ElseIf CDbl(mtofinancia) >= 2000001 And CDbl(mtofinancia) <= 3500000.99 Then
        '    montoSegvida = 30800.0
        'End If
        'Else
        '    montoSegvida = 2150.0
        'End If
        objPlazos.CargaPlazo(ddlplazos.SelectedValue)
        Dim cotvida As New clsCotSegVidaBBVA()
        Dim idquotevida As String = String.Empty

        'RQ-PD30 INI
        Dim productoDetalle = ObtenDatProducto()

        If IsNothing(productoDetalle) OrElse productoDetalle.Tables.Count = 0 OrElse productoDetalle.Tables(0).Rows.Count = 0 Then
            strErr = "No se encontró información para poder cargar el producto"
            Exit Function
        End If

        montoSegvida = CDbl(cotvida.CotizaBBVAVida(objPlazos.Valor, mtofinancia, idquotevida, productoDetalle.Tables(0).Rows(0).Item("ID_TIPO_PRODUCTO").ToString()))
        'RQ-PD30 FIN

        Session("montoSegVida") = montoSegvida
        Session("idquotevida") = idquotevida
        Dim cad As String = String.Empty
        If (ddltiposeg.SelectedValue <> 32 AndAlso ddltiposeg.SelectedValue <> 168) Then
            For j As Integer = 0 To grvSeguro.Rows.Count - 1
                cad = cad & grvSeguro.Rows(j).Cells(1).Text & "," & IIf(grvSeguro.Rows(j).Cells(2).Text = "", "0", grvSeguro.Rows(j).Cells(2).Text) & "," & IIf(grvSeguro.Rows(j).Cells(4).Text = "", "0", grvSeguro.Rows(j).Cells(4).Text) & "," & IIf(grvSeguro.Rows(j).Cells(6).Text = "", "0", grvSeguro.Rows(j).Cells(6).Text) & "|"
            Next
        End If
        Dim id_prod As Integer = ObtenProducto()
        LlenaGrvMultiplazos(ddlplan.SelectedValue, CDbl(txtprecio.Text.Trim), CDbl(txtenganche.Text.Trim), ddlpj.SelectedValue,
                                ddltoperacion.SelectedValue, ddlclasif.SelectedValue, txtUniProd.Text.Trim, ddliva.SelectedValue,
                                CDbl(lblAccFinan.Text.Trim.Trim), CDbl(lblAccConta.Text.Trim.Trim), objPlazos.Valor,
                                IIf(Val(Session("band")) = 0, 0, CDbl(txtporeng.Text.Trim)), Val(Session("band")), ddlversion.SelectedValue,
                                ddltipounidad.SelectedValue, ddltiposeg.SelectedValue, ddlcobertura.SelectedValue, ddluso.SelectedValue,
                                0, 0, CDbl(montoSegvida), 0, ddlaseguradora.SelectedValue,
                                ddledoseg.SelectedValue, intbroker, cad, 0, ddlsegvida.SelectedValue, id_prod)


        Dim MulPlazos As DataSet
        Dim Plazo As String
        Dim Monto As Decimal
        Dim Concepto As String
        objPlazos.CargaPlazo(ddlplazos.SelectedValue)

        MulPlazos = ViewState("MulPlazos")
        For C = 1 To MulPlazos.Tables(0).Columns.Count - 1
            Plazo = MulPlazos.Tables(0).Columns(C).ColumnName
            If objPlazos.Nombre = MulPlazos.Tables(0).Columns(C).ColumnName Then
                For R = 0 To MulPlazos.Tables(0).Rows.Count - 1
                    Concepto = MulPlazos.Tables(0).Rows(R)("CONCEPTO")
                    If Concepto = "Pago" Then
                        Monto = MulPlazos.Tables(0).Rows(R)(Plazo)
                    End If
                Next
            End If
        Next
        objPaq = New clsPaquetes
        objPaq.CargaPaquete(ddlplan.SelectedValue)
        If objPaq.ErrorPaquete = "" Then
            txtPagEsp.Text = CDbl(Monto) * CDbl(objPaq.PorPagEspeciales)
        Else
            strErr = objPaq.ErrorPaquete
            Exit Function
        End If
        EmulaCotSegVida = True
    End Function
    Private Function ObtenidVehicle(ByVal brokerid As Integer, idclasif As Integer, ByVal Idmarca As Integer, ByVal Idsubmarca As Integer,
                                  ByVal Idversion As Integer, ByVal IdAnio As Integer) As String

        Dim Vehicleid As String = String.Empty
        Dim objconex As New SDManejaBD.clsConexion
        Dim sql As New StringBuilder
        Dim dts As New DataSet()

        sql.AppendLine("SELECT B.NOMBRE AS MARCA, C.DESCRIPCION AS SUBMARCA, ISNULL(A.ID_EXTERNO, '') ID_EXTERNO")
        sql.AppendLine("FROM PRODUCTOS A")
        sql.AppendLine("INNER JOIN MARCAS B ON B.ID_MARCA = A.ID_MARCA")
        sql.AppendLine("INNER JOIN SUBMARCAS C ON C.ID_SUBMARCA = A.ID_SUBMARCA")
        sql.AppendLine("WHERE A.ID_CLASIFICACION = " & idclasif.ToString)
        sql.AppendLine("AND A.ID_MARCA = " & Idmarca.ToString)
        sql.AppendLine("AND A.ID_SUBMARCA = " & Idsubmarca.ToString)
        sql.AppendLine("AND A.ID_VERSION = " & Idversion.ToString)
        sql.AppendLine("AND A.ID_ANIO = " & IdAnio.ToString)

        dts = objconex.EjecutaQueryConsulta(sql.ToString)

        Vehicleid = dts.Tables(0).Rows(0).Item("ID_EXTERNO")

        Return Vehicleid

    End Function

    Protected Sub Page_LoadComplete(sender As Object, e As System.EventArgs) Handles Me.LoadComplete
        Dim dsDatos As New DataSet()
        dsDatos = objParam.ManejaParametro(10)
        ddledoseg.Enabled = True
        Try
            'BUG-PC-128: CGARCIA: 23/11/2017: SE PONE BANDERA PARA APARESER O NO AL DEDUCIBLE
            If MuestraDeducible = 0 Then
                divDeducible.Visible = False
            Else
                divDeducible.Visible = True
            End If
            If ddltiposeg.SelectedValue = 32 Or ddltiposeg.SelectedValue = 168 Then
                'ddledoseg.Items.Insert(0, New ListItem("< SELECCIONAR >", "-1"))
                'ddledoseg.SelectedValue = -1
                ddledoseg.Enabled = False
                'ddltipounidad.SelectedValue = 0
                ddltipounidad.Enabled = False
                'ddlcobertura.SelectedValue = 0
                ddlcobertura.Enabled = False
                'ddluso.SelectedValue = 0
                ddluso.Enabled = False
                'ddlaseguradora.SelectedValue = 0
                ddlaseguradora.Enabled = False
                If ddlsegvida.SelectedValue = 172 Then
                    btncotizaseg.Enabled = False
                Else
                    btncotizaseg.Enabled = True
                End If
            Else
                btncotizaseg.Enabled = True
                'ddledoseg.SelectedValue = 0
                ddledoseg.Enabled = True
                'ddltipounidad.SelectedValue = 0
                ddltipounidad.Enabled = True
                'ddlcobertura.SelectedValue = 0
                ddlcobertura.Enabled = True
                'ddluso.SelectedValue = 0
                ddluso.Enabled = True
                'ddlaseguradora.SelectedValue = 0
                ddlaseguradora.Enabled = True
            End If
        Catch ex As Exception
        End Try

        Dim brokerid As String = obten_broker()

        If dsDatos.Tables.Count > 0 AndAlso dsDatos.Tables(0).Rows.Count > 0 Then
            'Dim int1 As Integer = ddlalianza.SelectedValue
            'RQ-PI7-PC7: CGARCIA: 27/12/2017: CREACION DE LOS SERVICIOS DE SUBPLANES, INDEMNIZACION Y DEDUCIBLES (comobo de coberturas es subplan) unicamente para seguros bancomer
            'BUG-PC-168: CGARCIA: 15/03/2018: SE MODIFICA SERVICO DE DAÑOS PARA MULTIMARCA
            If (brokerid = CInt(dsDatos.Tables(0).Rows(0).Item("ID_BROKER"))) Then                
                Dim bolLlena As Boolean = False
                Dim intValue As Integer

                For index As Integer = 0 To dsDatos.Tables(0).Rows.Count - 1 Step 1
                    intValue = dsDatos.Tables(0).Rows(index).Item("ID_ALIANZA").ToString()
                    If ddlalianza.SelectedValue = intValue Then
                        'ObtenSubplan()
                        bolLlena = True
                        Exit For
                    End If
                Next
                If bolLlena = True Then
                    'BUG-PC-173: CGARCIA: 05/04/2018: SE MODIFICAN ALIANZAS PARA SEGURO A TU MEDIDA
                    ddledoseg.Enabled = False
                    If MuestraDeducible = 1 Then
                        divDeducible.Visible = True
                    Else
                        divDeducible.Visible = False
                    End If

                    If ddlcobertura.Items.Count > 0 Then
                        If ViewState("vwsCobertura") = 0 Then
                            Exit Sub
                        Else
                            If MuestraDeducible = 1 Then
                                ObtenSubplan()
                                ViewState("vwsCobertura") = 0
                            Else
                                ViewState("vwsCobertura") = 1
                            End If

                        End If
                    Else
                        If MuestraDeducible = 1 Then
                            ObtenSubplan()
                            ViewState("vwsCobertura") = 0
                        Else
                            ViewState("vwsCobertura") = 1
                        End If

                    End If
                Else
                    divDeducible.Visible = False
                    ViewState("vwsCobertura") = 1
                End If
            Else
                divDeducible.Visible = False
                ViewState("vwsCobertura") = 1
            End If
        Else
            MensajeError("Error al consultar parámetro de seguro de daños.")
        End If

        'BUG-PC-177 INI
        If usaMulticotiza = 1 AndAlso brokerid = 4 Then
            ddledoseg.Enabled = False
        End If

    End Sub
    'RQ-PI7-PC7: CGARCIA: 27/12/2017: CREACION DE LOS SERVICIOS DE SUBPLANES, INDEMNIZACION Y DEDUCIBLES (comobo de coberturas es subplan) unicamente para seguros bancomer
    'BUG-PC-168: CGARCIA: 15/03/2018: SE MODIFICA SERVICO DE DAÑOS PARA MULTIMARCA
    Protected Sub ddlcobertura_SelectedIndexChanged(sender As Object, e As EventArgs)
        Dim dsDatos As New DataSet()
        Dim bolLlena As Boolean = False
        Dim intValue As Integer
        dsDatos = objParam.ManejaParametro(10)
        'BUG-PC-173: CGARCIA: 05/04/2018: SE MODIFICAN ALIANZAS PARA SEGURO A TU MEDIDA
        If MuestraDeducible = 1 Then
            For index As Integer = 0 To dsDatos.Tables(0).Rows.Count - 1 Step 1
                intValue = dsDatos.Tables(0).Rows(index).Item("ID_ALIANZA").ToString()
                If ddlalianza.SelectedValue = intValue Then
                    obtieneDeducibles()
                    obtieneIndemnizacion()
                End If
            Next           
        End If
    End Sub
End Class

